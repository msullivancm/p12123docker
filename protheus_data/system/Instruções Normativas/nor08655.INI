?{"Nome do Arquivo INI","NOR08655.INI"}
?{"Descricao Completa do Arquivo Magnetico","Instrucao Normativa SRF n.86"}
?{"A Quem se Destina","Às pessoas jurídicas obrigadas a manter a disposição da Secretaria da Receita Federal os arquivos digitais e sistemas."}
?{"Objetivo","Manter a disposição da Secretaria da Receita Federal os arquivos digitais e sistemas, sempre que solicitadas via intimação, nos termos do art. 11 da Lei 8.218/91 (alterado pela Medida Provisória nº 2.158-35, de 24/08/2001) e da Instrução Normativa SRF nº 86, de 22 de outubro de 2001 e pelo Ato Declaratório Executivo Cofis nº 25, de 07/06/2010."}
?{"Prazo de Entrega","Conforme a intimação dos Auditores-Fiscais da Receita Federal."}
?{"Aplicativo Disponibilizado pelo Fisco","SVA"}
?{"Versao do Aplicativo Contemplada pela Microsiga","3.1.0"}
?{"Comentarios","As empresas optantes pelo Sistema Integrado de Pagamento de Impostos e Contribuicoes das Microempresas e Empresas de Pequeno Porte (Simples), de que trata a Lei n. 9.317, de 5 de dezembro de 1996, ficam dispensadas do cumprimento da obrigacao."}
?{"Nomenclaturas dos Arquivos",""}
?{"411LANCSI2.TXT - Lancamentos Contabeis"}
?{"411LANCCT2.TXT - Lancamentos Contabeis"}
?{"412SALSI1.TXT - Saldos Mensais"}
?{"412SALCT1.TXT - Saldos Mensais"} 
?{"421CONTSE1.TXT - Fornecedores / Clientes"}
?{"421CONTSE2.TXT - Fornecedores / Clientes"}
?{"421MOVRSE5.TXT - Fornecedores / Clientes"}
?{"421MOVPSE5.TXT - Fornecedores / Clientes"}
?{"431MESTREENTSAI.TXT - Mestre de Merc./Serv. - Saidas/Entradas"}
?{"432ITENENTRSAID.TXT - Itens de Merc./Serv. - Saidas/Entradas"}
?{"433SERVENTR.TXT - Mestre de Merc./Serv. - Entr. - Terc."}
?{"434ITENSERV.TXT - Intes de Merc./Serv. - Entr. - Terc."}
?{"435NFSERV.TXT - Mestre de NFs de Serv. - P. Juridica"}
?{"436ITESERVE.TXT - Itens de NFs de Serv. - P. Juridica"}
?{"438MESTENTR.TXT - Arq. Mestre de entrada"}
?{"439ENTR.TXT - Itens de notas de Entradas"}
?{"4310SAIDA.TXT - Saída de CF"}
?{"4311ENTR.TXT -  Entrada de CF"}
?{"441EXPORTAC.TXT - Exportacao"}
?{"442IMPORTAC.TXT - Importacao"}
?{"451RESTOQU.TXT - Controle de Estoque"}
?{"452INVENTAR.TXT - Registro de Inventario"}
?{"461INSUMOS.TXT - Insumos Relacionados"}
?{"471ATIVO.TXT - Cadastro de Bens"}
?{"481FOLHA.TXT - Folha de Pagamento"}
?{"482EMPREGAD.TXT - Cadastro de Empregados"}
?{"491CLIFOR.TXT - Cadastro de Pessoas Juridicas e Fisicas"}
?{"492PLANO.TXT - Plano de Contas Geral"}
?{"492PLANO2.TXT - Plano de Contas Geral"}
?{"492PLANOA.TXT - Plano de Contas Auxiliar"}
?{"492PLANOA2.TXT - Plano de Contas Auxiliar"}
?{"493CENTRO.TXT - Centro de Custo/Despesa"}
?{"493CENTRO2.TXT - Centro de Custo/Despesa"}
?{"494CFOP.TXT - Natureza da Operacao"}
?{"495PRODUTO.TXT - Mercadorias / Servicos"}
?{"496PROVENTO.TXT - Proventos / Descontos"}
?{"4101PISCOFSAIDA.TXT - Complementar de Saída"}
?{"4102COMPSAIDA.TXT - Complementar de Saída, não sujeito ao ICMS"}
?{"4103PISCOFSADECF.TXT - Complementar de Saída, ECF"}
?{"4104PISCOFENTR.TXT - Entrada, emitidas pela própria PJ"}
?{"4105COMPENTRTERC.TXT - Entrada, emitidas por terceiros"}
?{"4106COMPENTR.TXT - Entrada, não sujeitos ao ICMS"}
?{"4107PISCOFENTECF.TXT - Complementar de Entrada, ECF"}
?{"4111COMPSAIDA.TXT - Complementar de Saída"}
?{"4112COMPSAIDASER.TXT - Saída, não sujeitos ao ICMS"}
?{"4113COMPENT.TXT - Entrada, emitidas pela própria PJ"}
?{"4114COMPENT.TXT - Entrada, emitidas por terceiros "}
?{"4115COMPENT.TXT - Entrada, não sujeios ao ICMS "}

[SM0 Montagem de Arquivo ATI      ]  
(PRE) _aTotal[010]	:= {}
(PRE) _aTotal[011]	:= {}
(PRE) _aTotal[012]	:= {}   
(PRE) _aTotal[77]		:= {"INV",""}
(PRE) _aTotal[03]		:= {}
(PRE) _aTotal[03]		:= DadosCTB()
(PRE) _aTotal[33]		:= ""
(PRE) _aTotal[34]		:= ""
(PRE) _aTotal[35]		:= ""
(PRE) _aTotal[36]		:= ""
(PRE) _aTotal[37]		:= ""
(PRE) _aTotal[38]		:= .T.
(PRE) _aTotal[85]		:= {}
(PRE) _aTotal[86]		:= GetNewPar("MV_ITEMSIS",.F.)
(PRE) _aTotal[05]		:= GetNewPar("MV_5CLIFOR",.F.)
(PRE) _aTotal[06]		:= GetNewPar("MV_RECA1A2",.F.)
(PRE) _aTotal[97]		:= SUPERGETMV("MV_TPODATA",,.F.)
// Tratamento para filtrar os movimento que possuem titulos na filial de origem.
(PRE) _aTotal[99] 		:= SUPERGETMV("MV_E5FLORI",,.F.)
(PRE) _aTotal[87]		:= ""
(PRE) _aTotal[88]		:= 0
(PRE) _aTotal[100]		:= ""
(PRE) _aTotal[66]		:= StrZero(Day(MV_PAR01),2)+StrZero(MONTH(MV_PAR01),2)+StrZero(YEAR(MV_PAR01)-2,4)
(PRE) _aTotal[55]		:= .F. 
//usado para gerar nos arquivos de Cliente, Fornecedor, Transportador e Produtos, que tiveram movimentação
(PRE) _aTotal[30]		:= ""
(PRE) _aTotal[31]		:= {} 
(PRE) _aTotal[32]		:= {} 
 
[XXX Verificando perguntas da rotina]
(PRE) Pergunte("MTA950",.F.) 

[XXX Painel Principal]
(PRE) aAdd (_aTotal[010], "Instrução Normativa 086")
(PRE) aAdd (_aTotal[010], "")
(PRE) aAdd (_aTotal[010], "Preencha corretamente as informações solicitadas.")
(PRE) aAdd (_aTotal[010], "Digite a data que será utilizada para gerar o Registro de Inventário pela Instrução Normativa 086")

[XXX Montagem do Wizard - Data do Inventário.]
(PRE) aAdd (_aTotal[011], {})
(PRE) aAdd (_aTotal[011][1], "Instrução Normativa 086")
(PRE) aAdd (_aTotal[011][1], "Digite a data que será utilizada para gerar o Registro de Inventário pela Instrução Normativa 086")
(PRE) aAdd (_aTotal[011][1], {})
(PRE) aAdd (_aTotal[011][1][3], {1, "Data para Inventário",,,,,,})
(PRE) aAdd (_aTotal[011][1][3], {2,,,3,,,,}) 
[XXX Montagem do Wizard - Percentuais PIS/PASEP.]
(PRE) aAdd (_aTotal[011], {})
(PRE) aAdd (_aTotal[011][2], "Instrução Normativa 086")
(PRE) aAdd (_aTotal[011][2], "Informe os Percentuais correspondentes aos itens de Receitas de Exportacao, Tributadas e Nao-Tributada no Mercado Interno")
(PRE) aAdd (_aTotal[011][2], {})
(PRE) aAdd (_aTotal[011][2][3], {1, "% Cred. Pis/Cofins Receita de Exportação",,,,,,})
(PRE) aAdd (_aTotal[011][2][3], {1, "% Cred. Pis/Cofins Rec. Trib. Merc Interno",,,,,,})
(PRE) aAdd (_aTotal[011][2][3], {2,,"@E 999.99",2,2,,,6})       
(PRE) aAdd (_aTotal[011][2][3], {2,,"@E 999.99",2,2,,,6}) 
(PRE) aAdd (_aTotal[011][2][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[011][2][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[011][2][3], {1, "% Cred. Pis/Cofins Rec.Não-Trib Merc Interno",,,,,,}) 
(PRE) aAdd (_aTotal[011][2][3], {1, "",,,,,,})
(PRE) aAdd (_aTotal[011][2][3], {2,,"@E 999.99",2,2,,,6})
(PRE) aAdd (_aTotal[011][2][3], {1, "",,,,,,})

(PRE) xMagWizard (_aTotal[010],_aTotal[011], "NORMA086")
(PRE) xMagLeWiz ("NORMA086", @_aTotal[012], .T.)
(PRE) FsEstInv (_aTotal[77], 1, .T., .F., Stod(_aTotal[012][1][1]))
(POS) CtbTmpAT7(MV_PAR01,MV_PAR02,,.F.)       

[ATI Lancamentos Contabeis        ]
(ARQ) &If("CON"$GETMV("MV_MCONTAB"), "411LANCSI2.TXT", "")
(PRE) _aTotal[1] := VerCod("62")
(PRE) ATI->(DBGOTOP())
(PREREG) "CON"$GETMV("MV_MCONTAB")
(PREREG) (ATI->DtLanca >= MV_PAR01 .and. ATI->DtLanca <= MV_PAR02)
Data_Lanca C 008 0 DataInt(ATI->DtLanca)
Conta_Anal C 028 0 ATI->CtaAnal
CCusto     C 028 0 ATI->CCusto
Contra_Par C 028 0 ATI->ContPar
Valor_Lanc N 017 2 ATI->ValLanc
IndicaDc   C 001 0 ATI->IndicaDc
Numero Arq C 012 0 ATI->NumArq
Numero LancC 012 0 ATI->NumLanc
Hist_Compl C 150 0 ATI->HstCompl
             
[AT2 Lancamentos Contabeis        ]
(ARQ) &If("CTB"$GETMV("MV_MCONTAB"),"411LANCCT2.TXT","")
(PRE) AT2->(DBGOTOP())
(PREREG) "CTB"$GETMV("MV_MCONTAB")  
Data_Lanca C 008 0 DataInt(AT2->DtLanca)
Conta_Anal C 028 0 AT2->CtaAnal
CCusto     C 028 0 AT2->CCusto
Contra_Par C 028 0 AT2->ContPar
Valor_Lanc N 017 2 AT2->ValLanc
IndicaDc   C 001 0 AT2->IndicaDc
Numero Arq C 012 0 AT2->NumArq
Numero LancC 012 0 AT2->NumLanc
Hist_Compl C 150 0 AT2->HstCompl
(POS) DadosCTB(.T.,,MV_PAR01,MV_PAR02,,cFilAnt,cFilAnt,_aTotal[03])

[SI1 Saldos Mensais               ]
(ARQ) &If("CON"$GETMV("MV_MCONTAB"),"412SALSI1.TXT","")
(PREREG) "CON"$GETMV("MV_MCONTAB")  
(PREREG) SI1->I1_CLASSE=="A"  
(PREREG) Abs(CalcSaldo(Month(mv_par02))) > 0 .Or. ((TotDebitos(Month(mv_par01),Month(mv_par02)) + TotCreditos(Month(mv_par01),Month(mv_par02))) > 0)
DtaSaldoIn C 008 0 DataInt(mv_par01)
Conta_Anal C 028 0 SI1->I1_CODIGO
VlrSldIni  N 017 2 Abs(CalcSaldo(Month(mv_par01)-1))
Ind Inicio C 001 0 DouC(CalcSaldo(Month(mv_par01)-1))
VlrTotDeb  N 017 2 TotDebitos(Month(mv_par01),Month(mv_par02))
VlrTotCred N 017 2 TotCreditos(Month(mv_par01),Month(mv_par02))
VlrSldFina N 017 2 Abs(CalcSaldo(Month(mv_par02)))
Ind Final  C 001 0 DouC(CalcSaldo(Month(mv_par02)))

[AT7 Saldos Mensais               ]
(ARQ) &If("CTB"$GETMV("MV_MCONTAB"),"412SALCT1.TXT","")
(PRE) If("CTB"$GETMV("MV_MCONTAB"), _aTotal[100] := CtbTmpAT7(MV_PAR01,MV_PAR02,,.T.), NIL)
(PRE) AT7->(dbGoTop())
(PREREG) "CTB"$GETMV("MV_MCONTAB")  
(PREREG) AT7->TIPOCONTA $ "2"
(PREREG) AT7->SALDOATU !=  0 .OR. AT7->SALDODEB > 0 .OR. AT7->SALDOCRD > 0
DtaSaldoIn C 008 0 DataInt(AT7->DATASLD)
Conta_Anal C 028 0 AT7->CONTA
VlrSldIni  N 017 2 ABS(AT7->SALDOANT)
Ind Inicio C 001 0 DouC(AT7->SALDOANT)
VlrTotDeb  N 017 2 ABS(AT7->SALDODEB)
VlrTotCred N 017 2 ABS(AT7->SALDOCRD)
VlrSldFina N 017 2 ABS(AT7->SALDOATU)
Ind Final  C 001 0 DouC(AT7->SALDOATU)
(POS) ConAT7Clos("AT7",.T.,_aTotal[100])

[SE1 Arquivo Fornecedores/Clientes - Arquivo relacionado: CONTSE1.TXT]
(ARQ) 421CONTSE1.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Cta_Conta","Conta Contabil"},{"Participa", "Participante"}, {"Data_Lanca", "Dt. Lanc"}, {"Hist_Natur","Historico Naturezas"}, {"Valor_Oper","Valor operacao"}, {"TipoOper","T"}, {"TipoDoc","TPD"}, {"NumDocSe1","Num. Doc."}, {"Valor_Orig","Valor Original"}, {"DtEmissao","Dt.Emis."}, {"Data_Venc","Dt.Venc."}, {"Numero_Lct","Num.Lanc."}}
(LEG) "T=Tipo da Operacao, TPD=Tipo do documento"
(PRE) DadosAdm("SE1")                                                            
(PRE) SA1->(dbSetOrder(1))
(PREREG) ( MV_PAR06 == 2 .Or. FWModeAccess("SE1",3) == "E" .Or. ( MV_PAR06 == 1 .And. FWModeAccess("SE1",3) == "C" .And. SE1->E1_FILORIG == cFilAnt ) )
(PREREG) SA1->(MsSeek(xFilial("SA1")+SE1->E1_CLIENTE+SE1->E1_LOJA))
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)

(POS) CloseAdm("SE1")
Cta_Conta  C 028 0 SA1->A1_CONTA
Participa  C 014 0 _aTotal[30]
Data_Lanca C 008 0 DataInt(SE1->E1_EMIS1)
Hist_Natur C 050 0 SE1->E1_HIST
Valor_Oper N 017 2 xMoeda(SE1->E1_VALOR,SE1->E1_MOEDA,1,SE1->E1_EMISSAO)
TipoOper   C 001 0 "C"
TipoDoc    C 003 0 SE1->E1_TIPO
NumDocSe1  C 012 0 SE1->E1_PREFIXO+(RetNf(SE1->E1_NUM,6,"C")+Space((6-Len(RetNf(SE1->E1_NUM,6,"C")))))+SE1->E1_PARCELA
Valor_Orig N 017 2 SE1->E1_VLCRUZ
DtEmissao  C 008 0 DataInt(SE1->E1_EMISSAO)
Data_Venc  C 008 0 DataInt(SE1->E1_VENCREA)
Numero_Lct C 012 0 SE1->E1_NUM

[SE2 Arquivo Fornecedores/Clientes - Arquivo relacionado: CONTSE2.TXT]
(ARQ) 421CONTSE2.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Cta_Conta","Conta Contabil"},{"Participa", "Participante"}, {"Data_Lanca", "Dt. Lanc"}, {"Hist_Natur","Historico Naturezas"}, {"Valor_Oper","Valor operacao"}, {"TipoOper","T"}, {"TipoDoc","TPD"}, {"NumDocSe2","Num. Doc."}, {"Valor_orig","Valor Original"}, {"DtEmissao","Dt.Emis."}, {"Data_Venc","Dt.Venc."}, {"Numero_Lct","Num.Lanc."}}
(LEG) "T=Tipo da Operacao, TPD=Tipo do documento"
(PRE) DadosAdm("SE2")
(PRE) SA2->(dbSetOrder(1))
(PREREG) ( MV_PAR06 == 2 .Or. FWModeAccess("SE2",3) == "E" .Or. ( MV_PAR06 == 1 .And. FWModeAccess("SE2",3) == "C" .And. SE2->E2_FILORIG == cFilAnt ) )
(PREREG) SA2->(MsSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))    
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
(POS) CloseAdm("SE2")
Cta_Conta  C 028 0 SA2->A2_CONTA
Participa  C 014 0 _aTotal[30]
Data_Lanca C 008 0 DataInt(SE2->E2_EMIS1)
Hist_Natur C 050 0 SE2->E2_HIST
Valor_Oper N 017 2 xMoeda(SE2->E2_VALOR,SE2->E2_MOEDA,1,SE2->E2_EMISSAO)
TipoOper   C 001 0 "C"
TipoDoc    C 003 0 SE2->E2_TIPO
NumDocSe2  C 012 0 SE2->E2_PREFIXO+(RetNf(SE2->E2_NUM,6,"C")+Space((6-Len(RetNf(SE2->E2_NUM,6,"C")))))+SE2->E2_PARCELA
Valor_orig N 017 2 SE2->E2_VLCRUZ
DtEmissao  C 008 0 DataInt(SE2->E2_EMISSAO)
Data_Venc  C 008 0 DataInt(SE2->E2_VENCREA)
Numero_Lct C 012 0 SE2->E2_NUM

[SM0 Montagem de Arquivo SE5]
(PRE) DadosAdm("SE5","BBR")

[BBR Arquivo Fornecedores/Clientes - Arquivo relacionado: MOVRSE5.TXT]
(ARQ) 421MOVRSE5.TXT 
(IMP){.T., 0, 0, ""}
(CMP){{"Cta_Conta","Conta Contabil"},{"Participa", "Participante"}, {"Data_Lanca", "Dt. Lanc"}, {"Hist_Natur","Historico Naturezas"}, {"Valor_Oper","Valor operacao"}, {"TipoOper","T"}, {"TipoDoc","TPD"}, {"NumDocSe5","Num. Doc."}, {"Valor_orig","Valor Original"}, {"DtEmissao","Dt.Emis."}, {"Data_Venc","Dt.Venc."}, {"Numero_Lct","Num.Lanc."}}
(LEG) "T=Tipo da Operacao, TPD=Tipo do documento"
(PRE) SA1->(dbSetOrder(1))
(PRE) SE1->(dbSetOrder(2))
(PREREG) SelAdm("SE5","BBR")
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
(PREREG) iif( _aTotal[99] , ( SE1->E1_FILORIG == cFilAnt ) , .T. )
Cta_Conta  C 028 0 SA1->A1_CONTA
Participa  C 014 0 _aTotal[30]
Data_Lanca C 008 0 DataInt(SE5->E5_DTDIGIT)
Hist_Natur C 050 0 SE5->E5_HISTOR
Valor_Oper N 017 2 ValOpera(SE5->E5_FILIAL,SE5->E5_PREFIXO,SE5->E5_NUMERO,SE5->E5_PARCELA,SE5->E5_TIPO,SE5->E5_CLIFOR,SE5->E5_LOJA,SE5->E5_SEQ,SE5->E5_RECPAG)
TipoOper   C 001 0 Iif(SE5->E5_MOTBX $ SuperGetMv("MV_TPOIN86",,""),"B",SE5->E5_RECPAG)
TipoDoc    C 003 0 SE5->E5_TIPO
NumDocSe5  C 012 0 SE5->E5_PREFIXO+(RetNf(SE5->E5_NUMERO,6,"C")+Space((6-Len(RetNf(SE5->E5_NUMERO,6,"C")))))+SE5->E5_PARCELA
Valor_orig N 017 2 SE1->E1_VLCRUZ
DtEmissao  C 008 0 DataInt(SE1->E1_EMISSAO)
Data_Venc  C 008 0 DataInt(SE1->E1_VENCREA)
Numero_Lct C 012 0 SE5->E5_NUMERO

[SM0 Montagem de Arquivo SE5]
(PRE) DadosAdm("SE5","BBP")
[BBP Arquivo Fornecedores/Clientes - Arquivo relacionado: MOVPSE5.TXT]
(ARQ) 421MOVPSE5.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Cta_Conta","Conta Contabil"},{"Participa", "Participante"}, {"Data_Lanca", "Dt. Lanc"}, {"Hist_Natur","Historico Naturezas"}, {"Valor_Oper","Valor operacao"}, {"TipoOper","T"}, {"TipoDoc","TPD"}, {"NumDocSe5","Num. Doc."}, {"Valor_orig","Valor Original"}, {"DtEmissao","Dt.Emis."}, {"Data_Venc","Dt.Venc."}, {"Numero_Lct","Num.Lanc."}}
(LEG) "T=Tipo da Operacao, TPD=Tipo do documento"
(PRE) SA2->(dbSetOrder(1))
(PRE) SE2->(dbSetOrder(6))
(PREREG) SelAdm("SE5","BBP")
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
(PREREG) iif( _aTotal[99] , ( SE2->E2_FILORIG == cFilAnt ) , .T. )
Cta_Conta  C 028 0 SA2->A2_CONTA                                                 
Participa  C 014 0 _aTotal[30]
Data_Lanca C 008 0 DataInt(SE5->E5_DTDIGIT)                                      
Hist_Natur C 050 0 SE5->E5_HISTOR                                                
Valor_Oper N 017 2 ValOpera(SE5->E5_FILIAL,SE5->E5_PREFIXO,SE5->E5_NUMERO,SE5->E5_PARCELA,SE5->E5_TIPO,SE5->E5_CLIFOR,SE5->E5_LOJA,SE5->E5_SEQ,SE5->E5_RECPAG)
TipoOper   C 001 0 Iif(SE5->E5_MOTBX $ SuperGetMv("MV_TPOIN86",,""),"B",SE5->E5_RECPAG)
TipoDoc    C 003 0 SE5->E5_TIPO                                                  
NumDocSe5  C 012 0 SE5->E5_PREFIXO+(RetNf(SE5->E5_NUMERO,6,"C")+Space((6-Len(RetNf(SE5->E5_NUMERO,6,"C")))))+SE5->E5_PARCELA                
Valor_orig N 017 2 SE2->E2_VLCRUZ                                                
DtEmissao  C 008 0 DataInt(SE2->E2_EMISSAO)                                      
Data_Venc  C 008 0 DataInt(SE2->E2_VENCREA)                                      
Numero_Lct C 012 0 SE5->E5_NUMERO                                                

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                     ³
//³REGISTRO MESTRE MERCADORIAS/SERVICOS - SAIDAS (4.3.1)³
//³                                                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF3 4.3.1 Mestre Mercadorias/Servicos SAIDAS]
(IMP){.T., 0, 0, ""}
(CMP){{"Indica_Mov","I"},{"Modelo_Doc","MD"},{"SerSub_Doc", "Serie Doc."}, {"Numero_Doc", "Num. Doc."}, {"Dt_Emi_Doc","Dt. Emis."}, {"Cod_Partic", "Participante"}, {"Data_Saida","Dt. Saida"}, {"ValTotMerc","Val. Total Merc."}, {"ValTotDesc","Val. Total Desc."}, {"ValTotFret","Val. Total Frete"},{"ValTotSegu","Val. Tot. Seguro"},{"ValTotOutr","Val. Tot. Outras"}, {"ValTotIPI","Val. Tot. IPI"}, {"Val_Icm_St","Val.ICMS Sub.Trib."},{"Val_Tot_Nf","Val. Tot. NF"},{"Mod_Frete","Modelo Frete"},{"Ind_Sit_Ca","C"},{"Tip_Fatura","T"}}
(LEG) "I=Movto. (E)-Entrada (S)-Saida, MD=Modelo Documento, C=Indicador de Cancelamento, T= Tipo da Fatura (1)a vista (2)a prazo"

(PRE) SF1->(dbSetOrder(1))
(PRE) SF2->(dbSetOrder(2))
(PRE) SF3->(dbSetOrder(1))
(PRE) SD2->(dbSetOrder(3))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SA4->(dbSetOrder(1))   
(PRE) SE4->(dbSetOrder(1))

(PRE) _aTotal[89] := ""
(PRE) _aTotal[90] := {"SF3",""}
(PRE) _aTotal[92] := GETNEWPAR("MV_SUBTRIB", "")
(PRE) _aTotal[98] := "F3_FILIAL+F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "F3_FILIAL = '" + xFilial("SF3") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "F3_ENTRADA", "F3_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "(F3_CFO LIKE '5%' OR F3_CFO LIKE '6%' OR F3_CFO LIKE '7%') AND F3_TIPO <> 'L'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "F3_FILIAL == '" + xFilial("SF3") + "' .And. "
(PRE) _aTotal[99] += Iif(_aTotal[97],"DTOS(F3_ENTRADA)","DTOS(F3_EMISSAO)") + " >= '"+ DTOS(MV_PAR01) +"' .And. "
(PRE) _aTotal[99] += Iif(_aTotal[97],"DTOS(F3_ENTRADA)","DTOS(F3_EMISSAO)") + " <= '"+ DTOS(MV_PAR02) +"' .And. "
(PRE) _aTotal[99] += "SubStr(SF3->F3_CFO, 1, 1) >= '5' .And. SubStr(SF3->F3_CFO, 1, 1) <= '7' .And. F3_TIPO <> 'L'"

(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) DbGoTop()
//--Pre-Processamento do Registro de Arquivo
(PREREG) _aTotal[89] <> xFilial("SF3")+SF3->(F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE+DTOS(F3_DTCANC))
(PREREG) SF2->(DbSeek(xFilial("SF2")+SF3->(F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE))) .Or. .T.
(PREREG) SD2->(DbSeek(xFilial("SD2")+SF3->(F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA))) .Or. .T.
(PREREG) If(SF3->F3_TIPO $ "DB", SF1->(DbSeek(xFilial("SF2")+SD2->(D2_NFORI+D2_SERIORI+D2_CLIENTE+D2_LOJA))) , .T.) .Or. .T.
(PREREG) If(SF3->F3_TIPO $ "DB", SA2->(DbSeek(xFilial("SA2")+SF3->(F3_CLIEFOR+F3_LOJA))), SA1->(DbSeek(xFilial("SA1")+SF3->(F3_CLIEFOR+F3_LOJA)))) .Or. .T.
(PREREG) SA4->(DbSeek(xFilial("SA4")+SF2->F2_TRANSP)) .Or. .T.
(PREREG) SE4->(DbSeek(xFilial("SE4")+SF2->F2_COND)) .Or. .T.
(PREREG) _aTotal[93] := If(At(SF3->F3_ESTADO, _aTotal[92]) == NIL, 0, At(SF3->F3_ESTADO, _aTotal[92]))
(PREREG) _aTotal[29] := If(!Empty(SD2->D2_NFORI), If(!SF3->F3_TIPO$"DB", If(_aTotal[06], "SA1"+StrZero(SA1->(Recno()),11), If(_aTotal[05] .Or. SA1->A1_EST == "EX", "SA1"+AllTrim(xFilial("SA1"))+Right(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))), If(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))) , Replicate("0",14) )
(PREREG) _aTotal[21] := If(!Empty(SD2->D2_NFORI) , If(SF3->F3_TIPO$"DB", If(SF1->F1_FORMUL == "S" , _aTotal[29] , Replicate("0",14) ) , _aTotal[29] ) , Replicate("0",14) )                   

//Cli/For
(PREREG) _aTotal[30] := If(SF3->F3_TIPO$"DB",Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC))),Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
//Transportador
(PREREG) _aTotal[30] := Iif(!Empty(SF2->F2_TRANSP),Iif(_aTotal[06],"SA4"+StrZero(SA4->(Recno()),11),Iif(_aTotal[05].Or.SA4->A4_EST=="EX","SA4"+AllTrim(xFilial("SA4"))+RIGHT(SA4->A4_COD,9),space(14-len(alltrim(SA4->A4_CGC)))+alltrim(SA4->A4_CGC))),"")
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
(PREREG) AModNot(SF3->F3_ESPECIE) <> SPACE(2) .Or. Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS" 

//--Montagem do arquivo
Indica_Mov C 001 0 "S"
Modelo_Doc C 002 0 iif(Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS","03",AModNot(SF3->F3_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SF3",2,"F3_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF3->F3_NFISCAL)))+Alltrim(SF3->F3_NFISCAL)
Dt_Emi_Doc C 008 0 DataInt(SF3->F3_EMISSAO)
Cod_Partic C 014 0 If(SF3->F3_TIPO$"DB",Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC))),Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))))
Data_Saida C 008 0 DataInt(SF3->F3_ENTRADA)
ValTotMerc N 017 2 IIF( SF2->F2_TIPO <> "P" , SF2->(F2_VALMERC+F2_DESCONT) , 0 )
ValTotDesc N 017 2 SF2->F2_DESCONT
ValTotFret N 017 2 SF2->F2_FRETE
ValTotSegu N 017 2 SF2->F2_SEGURO
ValTotOutr N 017 2 SF2->F2_DESPESA
ValTotIPI  N 017 2 SF2->F2_VALIPI 
Val_Icm_St N 017 2 SF2->F2_ICMSRET
Val_Tot_Nf N 017 2 SF2->F2_VALBRUT
Ins_Est_St C 014 0 If(!EMPTY(SUBS(_aTotal[92], _aTotal[93]+2, AT("/",SUBS(_aTotal[92],_aTotal[93],Len(_aTotal[92])))-3)),SUBS(_ATOTAL[92], _ATOTAL[93], AT("/",SUBS(_ATOTAL[92],_ATOTAL[93],Len(_ATOTAL[92])))-1),If(SF3->F3_TIPO$"DB" .AND. SF3->F3_ICMSRET>0 ,SA2->A2_INSCR,SA1->A1_INSCR))
Via_Transp C 015 0 SA4->A4_VIA
Cod_Transp C 014 0 Iif(!Empty(SF2->F2_TRANSP),Iif(_aTotal[06],"SA4"+StrZero(SA4->(Recno()),11),Iif(_aTotal[05].Or.SA4->A4_EST=="EX","SA4"+AllTrim(xFilial("SA4"))+RIGHT(SA4->A4_COD,9),space(14-len(alltrim(SA4->A4_CGC)))+alltrim(SA4->A4_CGC))),"")
Qtd_Volume N 017 0 SF2->F2_VOLUME1
EspecieVol C 010 0 SF2->F2_ESPECI1
Peso_Bruto N 017 3 SF2->F2_PBRUTO
Peso_Liqui N 017 3 SF2->F2_PLIQUI
Mod_Frete  C 003 0 IIF(SF2->F2_FRETE>0,"CIF","FOB")
Ident_Veic C 015 0 SPACE(15)
Ind_Sit_Ca C 001 0 If(!Empty(SF3->F3_DTCANC),"S","N")
Tip_Fatura C 001 0 If(Alltrim(SE4->E4_COND)=="0","1","2")
Observacao C 045 0 SUBS(SF3->F3_OBSERV,1,45)
Ato_Decl   C 050 0 SPACE(50)
Mod_Doc    C 002 0 Iif(!Empty(SD2->D2_NFORI) , Iif(SF3->F3_TIPO$"DB", IIf(SF1->F1_FORMUL == "S" , AModNot(SF1->F1_ESPECIE) , SPACE(2) ) , AModNot(SF2->F2_ESPECIE) ) , SPACE(2) )
SerSub_Doc C 005 0 Iif(!Empty(SD2->D2_NFORI) , Iif(SF3->F3_TIPO$"DB", IIf(SF1->F1_FORMUL == "S" , SerieNfId("SD2",2,"D2_SERIORI") , Replicate("0",5) ) , SerieNfId("SD2",2,"D2_SERIORI") ) , Replicate("0",5) )  
Numero_Doc C 009 0 Iif(!Empty(SD2->D2_NFORI) , Iif(SF3->F3_TIPO$"DB", IIf(SF1->F1_FORMUL == "S" , Replicate("0",9-Len(Alltrim(SD2->D2_NFORI)))+Alltrim(SD2->D2_NFORI) , Replicate("0",9) ) , Replicate("0",9-Len(Alltrim(SD2->D2_NFORI)))+Alltrim(SD2->D2_NFORI) ) , Replicate("0",9) )  
Dt_Emi_Doc C 008 0 Iif(!Empty(SD2->D2_NFORI) , Iif(SF3->F3_TIPO$"DB", IIf(SF1->F1_FORMUL == "S" , DataInt(SF1->F1_EMISSAO) , SPACE(8) ) , Iif( SD2->(dbSeek(xFilial("SD2")+SD2->D2_NFORI+SD2->D2_SERIORI+SD2->D2_CLIENTE+SD2->D2_LOJA)) , DataInt(SD2->D2_EMISSAO) , SPACE(8) )  ) , SPACE(8) )
Cod_Partic C 014 0 _aTotal[21]

(POSREG) _aTotal[89] := xFilial("SF3")+SF3->(F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE+DTOS(F3_DTCANC))
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                       ³
//³REGISTRO MESTRE MERCADORIAS/SERVICOS - ENTRADAS (4.3.1)³
//³                                                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF3 4.3.1 Mestre Mercadorias/Servicos ENTRADAS]
(ARQ) 431MESTREENTSAI.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Indica_Mov","I",001},{"Modelo_Doc","MD",002},{"SerSub_Doc", "Serie Doc.",005}, {"Numero_Doc", "Num. Doc.",009}, {"Dt_Emi_Doc","Dt. Emis.",008}, {"Cod_Partic", "Participante",014}, {"Data_Saida","Dt. Saida",008}, {"ValTotMerc","Val.Total Merc.",014}, {"ValTotDesc","Val. Total Desc.",014}, {"ValTotFret","Val.Total Frete",014},{"ValTotSegu","Val.Tot.Seguro",13},{"ValTotOutr","Val.Tot.Outras",013}, {"ValTotIPI","Val.Tot. IPI",012}, {"Val_Icm_St","Val.ICMS Sub.Trib.",017},{"Val_Tot_Nf","Val. Tot. NF",014},{"Mod_Frete","Modelo Frete",003},{"Ind_Sit_Ca","C",001},{"Tip_Fatura","T",001}}
(LEG) "I=Movto. (E)-Entrada (S)-Saida, MD=Modelo Documento, C=Indicador de Cancelamento, T= Tipo da Fatura (1)a vista (2)a prazo"

(PRE) SF3->(dbSetOrder(1))
(PRE) SF2->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))

(PRE) _aTotal[89] := ""
(PRE) _aTotal[92] := GETNEWPAR("MV_SUBTRIB", "")
(PRE) _aTotal[90] := {"SF3",""}
(PRE) _aTotal[98] := "F3_FILIAL+F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "F3_FILIAL = '"+ xFilial("SF3") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "F3_ENTRADA", "F3_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "(F3_CFO LIKE '1%' OR F3_CFO LIKE '2%' OR F3_CFO LIKE '3%') AND F3_FORMUL = 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "F3_FILIAL == '" + xFilial("SF3") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F3_ENTRADA)", "DTOS(F3_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F3_ENTRADA)", "DTOS(F3_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "SubStr(F3_CFO, 1, 1) >= '1' .And. SubStr(F3_CFO, 1, 1) <= '3' .And. F3_FORMUL == 'S'"

(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) DbGoTop()
//--Pre-Processamento do Registro de Arquivo
(PREREG) _aTotal[89] <> xFilial("SF3")+SF3->(F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE)
(PREREG) SF1->(DbSeek(xFilial("SF1")+SF3->(F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA))) .OR. .T.
(PREREG) SD1->(DbSeek(xFilial("SD1")+SF3->(F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA))) .Or. .T.
(PREREG) If(SF3->F3_TIPO $ "DB", SF2->(DbSeek(xFilial("SF2")+SD1->(D1_NFORI+D1_SERIORI+D1_FORNECE+D1_LOJA))), .T. ) .Or. .T.
(PREREG) If(SF3->F3_TIPO $ "DB", SA1->(DbSeek(xFilial("SA1")+SF3->(F3_CLIEFOR+F3_LOJA))), SA2->(DbSeek(xFilial("SA2")+SF3->(F3_CLIEFOR+F3_LOJA)))) .Or. .T.
(PREREG) SE4->(DbSeek(xFilial("SE4")+SF1->F1_COND)) .Or. .T.
(PREREG) _aTotal[93] := If(AT(F3_ESTADO,_aTotal[92])==NIL,0,AT(F3_ESTADO,_aTotal[92])) 
(PREREG) _aTotal[20] := If(!Empty(SD1->D1_NFORI) , If(SF3->F3_TIPO$"DB",Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))),Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))) , Replicate("0",14) )
(PREREG) _aTotal[30] := If(SF3->F3_TIPO$"DB",Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))),Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC))))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
(PREREG) AModNot(SF3->F3_ESPECIE) <> SPACE(2) .Or. Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS" 


//--Montagem do arquivo
Indica_Mov C 001 0 "E"
Modelo_Doc C 002 0 iif(Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFE","03",AModNot(SF3->F3_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SF3",2,"F3_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF3->F3_NFISCAL)))+Alltrim(SF3->F3_NFISCAL)
Dt_Emi_Doc C 008 0 DataInt(SF3->F3_EMISSAO)
Cod_Partic C 014 0 _aTotal[30]
Data_Saida C 008 0 DataInt(SF3->F3_ENTRADA)
ValTotMerc N 017 2 IIF( SF1->F1_TIPO <> "P" ,  SF1->F1_VALMERC , 0 )
ValTotDesc N 017 2 SF1->F1_DESCONT
ValTotFret N 017 2 SF1->F1_FRETE
ValTotSegu N 017 2 SF1->F1_SEGURO
ValTotOutr N 017 2 SF1->F1_DESPESA
ValTotIPI  N 017 2 SF1->F1_VALIPI
Val_Icm_St N 017 2 SF1->F1_ICMSRET
Val_Tot_Nf N 017 2 SF1->(F1_VALBRUT)
Ins_Est_St C 014 0 If(!EMPTY(SUBS(_aTotal[92], _aTotal[93]+2, AT("/",SUBS(_aTotal[92],_aTotal[93],Len(_aTotal[92])))-3)),SUBS(_ATOTAL[92], _ATOTAL[93], AT("/",SUBS(_ATOTAL[92],_ATOTAL[93],Len(_ATOTAL[92])))-1),If(SF3->F3_TIPO$"DB" .AND. SF3->F3_ICMSRET>0 ,SA1->A1_INSCR,SA2->A2_INSCR))
Via_Transp C 015 0 SPACE(15)
Cod_Transp C 014 0 SPACE(14)
Qtd_Volume N 017 0 0
EspecieVol C 010 0 SPACE(10)
Peso_Bruto N 017 3 0
Peso_Liqui N 017 3 SF1->F1_PESOL
Mod_Frete  C 003 0 IIF(SF1->F1_FRETE>0,"CIF","FOB")
Ident_Veic C 015 0 SPACE(15)
Ind_Sit_Ca C 001 0 If(!Empty(SF3->F3_DTCANC),"S","N")
Tip_Fatura C 001 0 If(Alltrim(SE4->E4_COND)=="0","1","2")
Observacao C 045 0 SUBS(SF3->F3_OBSERV,1,45)
Ato_Decl   C 050 0 SPACE(50)
Mod_Doc    C 002 0 Iif(!Empty(SD1->D1_NFORI) , Iif(SF3->F3_TIPO$"DB", AModNot(SF2->F2_ESPECIE) , AModNot(SF1->F1_ESPECIE) ) , SPACE(2) )
SerSub_Doc C 005 0 Iif(!Empty(SD1->D1_NFORI) , SerieNfId("SD1",2,"D1_SERIORI") , Replicate("0",5) )  
Numero_Doc C 009 0 Iif(!Empty(SD1->D1_NFORI) , Replicate("0",9-Len(Alltrim(SD1->D1_NFORI)))+Alltrim(SD1->D1_NFORI) , Replicate("0",9) )
Dt_Emi_Doc C 008 0 Iif(!Empty(SD1->D1_NFORI) , Iif(SF3->F3_TIPO$"DB", DataInt(SF2->F2_EMISSAO), Iif( SD1->(dbSeek(xFilial("SD1")+SD1->D1_NFORI+SD1->D1_SERIORI+SD1->D1_FORNECE+SD1->D1_LOJA)) , DataInt(SD1->D1_EMISSAO) , SPACE(8) )   ) , SPACE(8) )
Cod_Partic C 014 0 _aTotal[20]
(POSREG) _aTotal[89] := xFilial("SF3")+SF3->(F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                  ³
//³ITENS MESTRE MERCADORIAS/SERVICOS - SAIDAS (4.3.2)³
//³                                                  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                  ³
//³ITENS MESTRE MERCADORIAS/SERVICOS - SAIDAS (4.3.2)³
//³                                                  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD2 4.3.2 Itens Mestre Mercadorias/Servicos SAIDA]
(IMP){.T., 0, 0, ""}
(CMP){{"Indica_Mov","I"},{"Modelo_Doc","MD"},{"SerSub_Doc", "Serie Doc."}, {"Numero_Doc", "Num. Doc."}, {"Dt_Emi_Doc","Dt. Emis."}, {"Cod_d_Merc", "Cod. Merc./Serv."},{"Cod_CFOP","CFOP"}, {"Cod_ClaFis","NCM"},{"Quantidade","Qtd."},{"Unidade","UN"},{"Vl_Unitari","Val. Unitario"}, {"Vl_Total","Val. Total"}, {"Vl_DescIte","Val. Desconto"},{"Aliquo_Ipi","Aliq. IPI"},{"BaseCalIpi","Base IPI"},{"Aliq_Icms","Aliq. ICMS"},{"Vl_Bas_Icm","Base ICMS"},{"Vl_Bas_Sub","Base Sub.Trib."}}
(LEG) "I=Movto. (E)-Entrada (S)-Saida, NCM= Nomenclatura Comum Mercosul, UN=Unidade de Medida"

(PRE) SB1->(dbSetOrder(1))
(PRE) SF3->(dbSetOrder(5))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))

(PRE) _aTotal[87] :=""
(PRE) _aTotal[90] := {"SD2",""}
(PRE) _aTotal[98] := "D2_FILIAL+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_COD+D2_ITEM"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D2_FILIAL = '" + xFilial("SD2") + "' AND D2_TIPO <> '" + "L" + "' AND "
(PRE) _aTotal[91] += "D2_EMISSAO BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02)+ "'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D2_FILIAL == '"+ xFilial("SD2") +"' .And. "
(PRE) _aTotal[99] += "DTOS(D2_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. DTOS(D2_EMISSAO) <= '" + DTOS(MV_PAR02) + "'"
(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) DbGoTop()
//--Pre-Processamento do Registro de Arquivo
(PREREG) SF3->(DbSeek(xFilial("SF3")+SD2->(D2_SERIE+D2_DOC+D2_CLIENTE+D2_LOJA)))
(PREREG) SF4->(DbSeek(xFilial("SF4")+SD2->D2_TES))
(PREREG) SF4->(F4_LFICM <> "N" .Or. F4_LFIPI <> "N" .Or. F4_LFISS <> "N")
(PREREG) SB1->(DbSeek(xFilial("SB1")+SD2->D2_COD))
(PREREG) If(SD2->D2_TIPO$"DB", SA2->(DbSeek(xFilial("SA2")+SF3->(F3_CLIEFOR+F3_LOJA))), SA1->(DbSeek(xFilial("SA1")+SF3->(F3_CLIEFOR+F3_LOJA))))
(PREREG) If(AScan(_aTotal[85], SD2->D2_TES) == 0, (AAdd(_aTotal[85], SD2->D2_TES), .T.), .T.)
(PREREG) _aTotal[88] := If(_aTotal[86], 0, If(_aTotal[87] == SD2->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA), _aTotal[88]+1, 1))
(PREREG) _aTotal[87] := SD2->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA)
(PREREG) If(AScan(_aTotal[32], RIGHT(Trim(SD2->D2_COD),20)) == 0, (AAdd(_aTotal[32], RIGHT(Trim(SD2->D2_COD),20)), .T.), .T.)
(PREREG) AModNot(SF3->F3_ESPECIE) <> SPACE(2) .Or. Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS" 

//--Montagem do arquivo
Indica_Mov C 001 0 "S"
Modelo_Doc C 002 0 iif(Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS","03",AModNot(SF3->F3_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SD2",2,"D2_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD2->D2_DOC)))+Alltrim(SD2->D2_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD2->D2_EMISSAO)
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD2->D2_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD2->D2_ITEM,3),Str(_aTotal[88])))
Cod_d_Merc C 020 0 RIGHT(Trim(SD2->D2_COD),20)
Desc_Compl C 045 0 SB1->B1_DESC
Cod_CFOP   C 004 0 IIF(YEAR(SD2->D2_EMISSAO)>=2003,SUBS(SD2->D2_CF,1,4),SUBS(SD2->D2_CF,1,3))
Cod_Nat_Op C 006 0 SD2->D2_TES
Cod_ClaFis C 008 0 SB1->B1_POSIPI
Quantidade N 017 3 IIF( SD2->D2_TIPO <> "P" , Iif( SD2->D2_TIPO$"NDB" , SD2->D2_QUANT , 1 ) , 0 )
Unidade    C 003 0 Subs(SD2->D2_UM,1,3)
Vl_Unitari N 017 4 IIF(SD2->D2_TIPO <> "P", SD2->D2_PRCVEN + ( SD2->D2_DESCON / SD2->D2_QUANT ), 0 )
Vl_Total   N 017 2 IIF(SD2->D2_TIPO <> "P", IIF(SD2->D2_TIPO $ "NDB", SD2->((D2_PRCVEN*D2_QUANT)+D2_DESCON), IIF(SD2->D2_TIPO=="C" .And. SD2->D2_ICMSRET>0, SD2->D2_ICMSRET, SD2->D2_TOTAL)), 0)
Vl_DescIte N 017 2 SD2->D2_DESCON
Indica_Ipi C 001 0 If(SF4->F4_LFIPI$"T", 1, If(SF4->F4_LFIPI$"IN",2, 3))
Aliquo_Ipi N 005 2 SD2->D2_IPI
BaseCalIpi N 017 2 If(SD2->D2_IPI>0,SD2->D2_BASEIPI,0)
Vl_Ipi     N 017 2 SD2->D2_VALIPI
Sit_TrEst  C 003 0 SD2->D2_CLASFIS
Ind_T_Icms C 001 0 If(SF4->F4_LFICM=="T",1,If(SF4->F4_LFICM$"IN",2,3))
Aliq_Icms  N 005 2 SD2->D2_PICM
Vl_Bas_Icm N 017 2 SD2->D2_BASEICM
Vl_Icms_Pr N 017 2 SD2->D2_VALICM
Vl_Bas_Sub N 017 2 SD2->D2_BRICMS
Vl_Icm_Sub N 017 2 SD2->D2_ICMSRET
Ind_M_Fisi C 001 0 SF4->F4_ESTOQUE 
Cod_SitTri C 002 0 SF4->F4_CTIPI
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                    ³
//³ITENS MESTRE MERCADORIAS/SERVICOS - ENTRADAS (4.3.2)³
//³                                                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD1 4.3.2 Itens Mestre Mercadorias/Servicos ENTRADA]
(ARQ) 432ITENENTRSAID.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Indica_Mov","I"},{"Modelo_Doc","MD"},{"SerSub_Doc", "Serie Doc."}, {"Numero_Doc", "Num. Doc."}, {"Dt_Emi_Doc","Dt. Emis."}, {"Cod_d_Merc", "Cod. Merc./Serv."},{"Cod_CFOP","CFOP"}, {"Cod_ClaFis","NCM"},{"Quantidade","Qtd."},{"Unidade","UN"},{"Vl_Unitari","Val. Unitario"}, {"Vl_Total","Val. Total"}, {"Vl_DescIte","Val. Desconto"},{"Aliquo_Ipi","Aliq. IPI"},{"BaseCalIpi","Base IPI"},{"Aliq_Icms","Aliq. ICMS"},{"Vl_Bas_Icm","Base ICMS"},{"Vl_Bas_Sub","Base Sub.Trib."}}
(LEG) "I=Movto. (E)-Entrada (S)-Saida, NCM= Nomenclatura Comum Mercosul, UN=Unidade de Medida"

(PRE) SB1->(dbSetOrder(1))
(PRE) SF3->(dbSetOrder(5))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))

(PRE) _aTotal[87] := ""
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[98] := "D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D1_FILIAL = '" + xFilial("SD1") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "D1_DTDIGIT", "D1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) +"' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "D1_FORMUL = 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D1_FILIAL == '" + xFilial("SD1") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "D1_FORMUL == 'S'"
(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) DbGoTop() 
//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(DbSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) SF4->F4_LFICM <> "N" .Or. SF4->F4_LFIPI <> "N" .Or. SF4->F4_LFISS <> "N" 
(PREREG) SB1->(DbSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) SF3->(DbSeek(xFilial("SF3")+SD1->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA)))
(PREREG) If(SD1->D1_TIPO$"DB", SA1->(DbSeek(xFilial("SA1")+SF3->(F3_CLIEFOR+F3_LOJA))), SA2->(DbSeek(xFilial("SA2")+SF3->(F3_CLIEFOR+F3_LOJA))))
(PREREG) If(AScan(_aTotal[85], SD1->D1_TES) == 0, (AAdd(_aTotal[85], SD1->D1_TES),.T.), .T. )
(PREREG) _aTotal[88] := If(_aTotal[86], 0, If(_aTotal[87] == SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA), _aTotal[88]+1, 1))
(PREREG) _aTotal[87] := SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
(PREREG) If( AScan(_aTotal[32], RIGHT(Trim(SD1->D1_COD),20)) == 0, (AAdd(_aTotal[32], RIGHT(Trim(SD1->D1_COD),20)), .T.), .T.)
(PREREG) AModNot(SF3->F3_ESPECIE) <> SPACE(2) .Or. Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS" 
//--Montagem do arquivo
Indica_Mov C 001 0 "E"
Modelo_Doc C 002 0 Iif(Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFE","03",AModNot(SF3->F3_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SD1",2,"D1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD1->D1_DOC)))+Alltrim(SD1->D1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD1->D1_EMISSAO)
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))
Cod_d_Merc C 020 0 RIGHT(Trim(SD1->D1_COD),20)
Desc_Compl C 045 0 SB1->B1_DESC
Cod_CFOP   C 004 0 IIF(YEAR(SD1->D1_EMISSAO)>=2003,SUBS(SD1->D1_CF,1,4),SUBS(SD1->D1_CF,1,3))
Cod_Nat_Op C 006 0 SD1->D1_TES
Cod_ClaFis C 008 0 SB1->B1_POSIPI
Quantidade N 017 3 Iif( SD1->D1_TIPO <> "P" , Iif( SD1->D1_TIPO$"NDB" , SD1->D1_QUANT , 1 ) , 0 )
Unidade    C 003 0 Subs(SD1->D1_UM,1,3)
Vl_Unitari N 017 4 Iif( SD1->D1_TIPO <> "P" , Iif( SD1->D1_TIPO$"NDB" , (SD1->D1_TOTAL)/SD1->D1_QUANT , SD1->D1_TOTAL ) , 0 )
Vl_Total   N 017 2 Iif( SD1->D1_TIPO <> "P" , SD1->D1_TOTAL , 0 )
Vl_DescIte N 017 2 SD1->D1_VALDESC
Indica_Ipi C 001 0 If(SF4->F4_LFIPI$"T", 1, If(SF4->F4_LFIPI$"IN", 2, 3))
Aliquo_Ipi N 005 2 SD1->D1_IPI
BaseCalIpi N 017 2 If(SD1->D1_IPI>0,SD1->D1_BASEIPI,0)
Vl_Ipi     N 017 2 SD1->D1_VALIPI
Sit_TrEst  C 003 0 SD1->D1_CLASFIS
Ind_T_Icms C 001 0 If(SF4->F4_LFICM=="T",1,If(SF4->F4_LFICM$"IN",2,3))
Aliq_Icms  N 005 2 SD1->D1_PICM
Vl_Bas_Icm N 017 2 SD1->D1_BASEICM
Vl_Icms_Pr N 017 2 SD1->D1_VALICM                                                
Vl_Bas_Sub N 017 2 SD1->D1_BRICMS                                                
Vl_Icm_Sub N 017 2 SD1->D1_ICMSRET                                        
Ind_M_Fisi C 001 0 SF4->F4_ESTOQUE
Cod_SitTri C 002 0 SF4->F4_CTIPI
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                            ³
//³REGISTRO MERCADORIAS/SERVICOS - Entradas - Terceiros (4.3.3)³
//³                                                            ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF1 4.3.3 Mercadorias/Servicos - Entradas - Terceiros]
(ARQ) 433SERVENTR.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Modelo_Doc","MD"},{"Serie_Sub", "Serie Doc."}, {"Numero_Doc", "Num. Doc."}, {"Dt_Emi_Doc","Dt. Emis."}, {"Cod_Partic", "Participante"}, {"Dt_Entrada","Dt. Entrada"}, {"Vl_TotMerc","Val. Total Merc."}, {"Vl_TotDesc","Val. Total Desc."}, {"Vl_TotFret","Val. Total Frete"},{"Vl_TotSegu","Val. Tot. Seguro"},{"Vl_TotOutr","Val. Tot. Outras"}, {"Vl_TotIPI","Val. Tot. IPI"}, {"Vl_Icm_Sub","Val.ICMS Sub.Trib."},{"Vl_Tot_NF","Val. Tot. NF"},{"InscEstSub","Insc. Sub.Trib."},{"Tipo_Fatur","T"}}
(LEG) "MD=Modelo Documento, T= Tipo da Fatura (1)a vista (2)a prazo"

(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SF2->(dbSetOrder(1))
(PRE) SF3->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))

(PRE) _aTotal[92] := GETNEWPAR("MV_SUBTRIB", "")
(PRE) _aTotal[90] := {"SF1",""}
(PRE) _aTotal[98] := SF1->(IndexKey())
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "F1_FILIAL = '" + xFilial("SF1") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "F1_DTDIGIT", "F1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "F1_FORMUL <> 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "F1_FILIAL == '" + xFilial("SF1") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97],"DTOS(F1_DTDIGIT)", "DTOS(F1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97],"DTOS(F1_DTDIGIT)", "DTOS(F1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "F1_FORMUL <> 'S'"

(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) DbGoTop()

//--Pre-Processamento do Registro de Arquivo
(PREREG) SF3->(DbSeek(xFilial("SF3")+SF1->(DTOS(F1_DTDIGIT)+F1_DOC+F1_SERIE+F1_FORNECE+F1_LOJA)))
(PREREG) SE4->(DbSeek(xFilial("SE4")+SF1->F1_COND)) .Or. .T.
(PREREG) If(SF1->F1_TIPO $ "DB", SA1->(DbSeek(xFilial("SA1")+SF1->(F1_FORNECE+F1_LOJA))), SA2->(DbSeek(xFilial("SA2")+SF1->(F1_FORNECE+F1_LOJA))))
(PREREG) If(SF3->F3_TIPO $ "DB", SF2->(DbSeek(xFilial("SF2")+SD1->(D1_NFORI+D1_SERIORI+D1_FORNECE+D1_LOJA))) , .T. ) .Or. .T.
(PREREG) (SD1->(DbSeek(xFilial("SD1")+SF3->(F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA))) .Or. .T.)
(PREREG) (SF4->(DbSeek(xFilial("SF4")+SD1->D1_TES)), .T.)
(PREREG) (_aTotal[93] := AT(SF1->F1_EST, _aTotal[92]), .T.)
(PREREG) AModNot(SF1->F1_ESPECIE) <> SPACE(2) .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS" 
(PREREG) _aTotal[30] := If(SF1->F1_TIPO$"DB",Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))),Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC))))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
//--Montagem do arquivo
Modelo_Doc C 002 0 iif(AModNot(SF1->F1_ESPECIE)="01" .Or. Alltrim(SF1->F1_ESPECIE)=="NFS" .Or. Alltrim(SF1->F1_ESPECIE)=="NFPS","03",AModNot(SF1->F1_ESPECIE))
Serie_Sub  C 005 0 SerieNfId("SF1",2,"F1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF1->F1_DOC)))+Alltrim(SF1->F1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SF1->F1_EMISSAO)
Cod_Partic C 014 0 _aTotal[30]
Dt_Entrada C 008 0 DataInt(SF1->F1_DTDIGIT)
ValTotMerc N 017 2 IIF( SF1->F1_TIPO <> "P", SF1->F1_VALMERC, 0)
Vl_TotDesc N 017 2 SF1->F1_DESCONT
Vl_TotFret N 017 2 SF1->F1_FRETE
Vl_TotSegu N 017 2 SF1->F1_SEGURO
Vl_TotOutr N 017 2 SF1->F1_DESPESA
Vl_TotIPI  N 017 2 SF1->F1_VALIPI
Vl_Icm_Sub N 017 2 SF1->F1_ICMSRET
Vl_Tot_NF  N 017 2 SF1->F1_VALBRUT
InscEstSub C 014 0 IIf(SF1->F1_ICMSRET>0 .And. _aTotal[93]>0,(Substr(_aTotal[92],_aTotal[93]+2,(AT("/",(Substr(_aTotal[92],_aTotal[93]+2)))-1))),"")
Tipo_Fatur C 001 0 If(Alltrim(SE4->E4_COND)=="0","1","2")
Observacao C 045 0 SPACE(45)
Ato_Decl   C 050 0 SPACE(50)
Mod_Doc    C 002 0 SPACE(2)
SerSub_Doc C 005 0 Iif(!Empty(SD1->D1_NFORI) , SerieNfId("SD1",2,"D1_SERIORI") , Replicate("0",5) )  

Numero_Doc C 009 0 Iif(!Empty(SD1->D1_NFORI) , Replicate("0",9-Len(Alltrim(SD1->D1_NFORI)))+Alltrim(SD1->D1_NFORI) , Replicate("0",9) )
Dt_Emi_Doc C 008 0 Iif(SF3->F3_TIPO$"DB", DataInt(SF2->F2_EMISSAO), "00000000" )
Cod_Partic C 014 0 If(SF1->F1_TIPO$"DB",Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))),Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC))))
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                         ³
//³REGISTRO ITENS MESTRE MERCADORIAS/SERVICOS - ENTRADAS - TERCEIROS (4.3.4)³
//³                                                                         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD1 4.3.4 Itens Mestre Mercadorias/Servicos - Terceiros]
(ARQ) 434ITENSERV.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Modelo_Doc","MD"},{"SerSub_Doc", "Serie Doc."}, {"Numero_Doc", "Num. Doc."}, {"Dt_Emi_Doc","Dt. Emis."}, {"Cod_d_Merc", "Cod. Merc./Serv."},{"Cod_CFOP","CFOP"}, {"Cod_ClaFis","NCM"}, {"Quantidade","Qtd."},{"Unidade","UN"},{"Vl_Unitari","Val. Unitario"}, {"Vl_Total","Val. Total"}, {"Vl_DescIte","Val. Desconto"},{"Aliquo_Ipi","Aliq. IPI"},{"BaseCalIpi","Base IPI"},{"Aliq_Icms","Aliq. ICMS"},{"Vl_Bas_Icm","Base ICMS"},{"Vl_Bas_Sub","Base Sub.Trib."}}
(LEG) "NCM= Nomenclatura Comum Mercosul, UN=Unidade de Medida"

(PRE) SF4->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))
(PRE) SB1->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))

(PRE) _aTotal[87] := ""
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[98] := "D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D1_FILIAL = '" + xFilial("SD1") + "' AND " 
(PRE) _aTotal[91] += If(_aTotal[97], "D1_DTDIGIT", "D1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) +"' AND '" +  DTOS(MV_PAR02) +"' AND "
(PRE) _aTotal[91] += "D1_FORMUL <> 'S'" 
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D1_FILIAL == '" + xFilial("SD1") + "' .And. " 
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "D1_FORMUL <> 'S'"

(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) DbGoTop()

//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(DbSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) SFT->(DbSeek(xFilial("SFT")+SF4->F4_TIPO+SD1->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_ITEM+D1_COD)))
(PREREG) SF4->(F4_LFICM <> "N" .Or. F4_LFIPI <> "N" .Or. F4_LFISS <> "N")
(PREREG) SB1->(DbSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) SF1->(DbSeek(xFilial("SF1")+SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)))
(PREREG) If(SD1->D1_TIPO$"DB", SA1->(DbSeek(xFilial("SA1")+SD1->(D1_FORNECE+D1_LOJA))), SA2->(DbSeek(xFilial("SA2")+SD1->(D1_FORNECE+D1_LOJA))))
(PREREG) If(AScan(_aTotal[85], SD1->D1_TES) == 0, (AAdd(_aTotal[85], SD1->D1_TES), .T.), .T.)
(PREREG) _aTotal[88] := If(_aTotal[86], 0, Iif(_aTotal[87] == SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA), _aTotal[88]+1, 1))
(PREREG) _aTotal[87] := SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)       
(PREREG) If(AScan(_aTotal[32], RIGHT(Trim(SD1->D1_COD),20)) == 0, (AAdd(_aTotal[32], RIGHT(Trim(SD1->D1_COD),20)), .T.), .T.)
(PREREG) _aTotal[30] := If(SD1->D1_TIPO$"DB",Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))),Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC))))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
(PREREG) AModNot(SF1->F1_ESPECIE) <> SPACE(2) .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS" 
//--Montagem do arquivo
Modelo_Doc C 002 0 iif(AModNot(SF1->F1_ESPECIE)="01" .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS","03",AModNot(SF1->F1_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SFT",2,"FT_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SFT->FT_NFISCAL)))+Alltrim(SFT->FT_NFISCAL)
Dt_Emi_Doc C 008 0 DataInt(SFT->FT_EMISSAO)
Cod_Partic C 014 0 _aTotal[30]
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))
Cod_d_Merc C 020 0 RIGHT(Trim(SFT->FT_PRODUTO),20)
Desc_Compl C 045 0 SB1->B1_DESC
Cod_CFOP   C 004 0 IIF(YEAR(SFT->FT_EMISSAO)>=2003,SUBS(SFT->FT_CFOP,1,4),SUBS(SFT->FT_CFOP,1,3))
Cod_Nat_Op C 006 0 SD1->D1_TES
Cod_ClaFis C 008 0 SB1->B1_POSIPI
Quantidade N 017 3 Iif( SD1->D1_TIPO <> "P" , Iif( SD1->D1_TIPO$"NDB" , SD1->D1_QUANT , 1 ) , 0 )
Unidade    C 003 0 Subs(SD1->D1_UM,1,3)
Vl_Unitari N 017 4 Iif( SD1->D1_TIPO <> "P" , Iif( SD1->D1_TIPO$"NDB" , (SD1->D1_TOTAL)/SD1->D1_QUANT , SD1->D1_TOTAL ) , 0 )
Vl_Total   N 017 2 Iif( SD1->D1_TIPO <> "P" , SD1->D1_TOTAL, 0)
Vl_DescIte N 017 2 SD1->D1_VALDESC
Indica_Ipi C 001 0 If(SFT->FT_OUTRIPI > 0, 3, If(SFT->FT_ISENIPI > 0 .Or. SFT->FT_VALIPI > 0, 1, 2))
Aliquo_Ipi N 005 2 SFT->FT_ALIQIPI
BaseCalIpi N 017 2 If(SFT->FT_ALIQIPI>0,SFT->FT_BASEIPI,0)
Vl_Ipi     N 017 2 SFT->FT_VALIPI  
Sit_TrEst  C 003 0 SFT->FT_CLASFIS
Ind_T_Icms C 001 0 If(SFT->FT_OUTRICM > 0, 3, If(SFT->FT_ISENICM == 0 .And. SFT->FT_VALICM == 0, 2, 1))
Aliq_Icms  N 005 2 SFT->FT_ALIQICM
Vl_Bas_Icm N 017 2 SFT->FT_BASEICM
Vl_Icms_Pr N 017 2 SFT->FT_VALICM                                                
Vl_Bas_Sub N 017 2 SFT->FT_BASERET                            
Vl_Icm_Sub N 017 2 SFT->FT_ICMSRET                                        
Ind_M_Fisi C 001 0 SF4->F4_ESTOQUE
Cod_SitTri C 002 0 SFT->FT_CTIPI
(POS) FsQuery(_aTotal[90], 2)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                  ³
//³REGISTRO MESTRE - NOTAS FISCAIS DE SERVICO (4.3.5)³
//³                                                  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF3 4.3.5 Nfs Servicos-Mestre]
(ARQ) 435NFSERV.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Serie_Sub", "Serie Doc."}, {"Numero_Doc", "Num. Doc."}, {"Dt_Emi_Doc","Dt. Emis."}, {"Cod_Partic", "Participante"},{"Vl_TotServ","Vl. Total Servico"},{"Vl_TotDesc","Vl. Total Desconto"},{"Aliq_IRRF","Aliq. IRRF"},{"BaseC_IRRF","Base IRRF"},{"Vl_IRRF","Val. IRRF"},{"Ind_Cancel","C"}}
(LEG) "C= Indicador de Cancelamento"

(PRE) SB1->(dbSetOrder(1))
(PRE) SF2->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SD2->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(3))
(PRE) SF3->(dbSetOrder(5)) 

(PRE) _aTotal[87] := ""                         
(PRE) _aTotal[90] := {"SF3",""}
(PRE) _aTotal[98] := "F3_FILIAL+F3_SERIE+F3_NFISCAL+F3_CLIEFOR+F3_LOJA+F3_IDENTFT"
(PRE) _aTotal[98] := SF3->(IndexKey())		                          
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "F3_FILIAL = '" + xFilial("SF3") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "F3_ENTRADA", "F3_EMISSAO") + " BETWEEN '" +  DTOS(MV_PAR01) + "' AND '" +  DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "(F3_CFO LIKE '5%' OR F3_CFO LIKE '6%' OR F3_CFO LIKE '7%') AND F3_TIPO = 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "F3_FILIAL == '" +xFilial("SF3") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F3_ENTRADA)", "DTOS(F3_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F3_ENTRADA)", "DTOS(F3_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "SubStr(F3_CFO, 1, 1) >= '5' .And. SubStr(F3_CFO, 1, 1) <= '7' .And. F3_TIPO == 'S'"
(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])             
(PRE) SF3->(DbGoTop())

//--Pre-Processamento do Registro de Arquivo 
(PREREG) _aTotal[87] <> xFilial("SF3")+SF3->(F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE+DTOS(F3_DTCANC)) 
(PREREG) SFT->(dbSeek(xFilial("SFT")+"S"+SF3->(F3_CLIEFOR+F3_LOJA+F3_SERIE+F3_NFISCAL+F3_IDENTFT)))
(PREREG) SF2->(MsSeek(xFilial("SF2")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE)) .Or. .T.
(PREREG) If(SF3->F3_TIPO$"DB", SA2->(MsSeek(xFilial("SA2")+SF3->F3_CLIEFOR+SF3->F3_LOJA)), SA1->(MsSeek(xFilial("SA1")+SF3->F3_CLIEFOR+SF3->F3_LOJA))) .Or. .T.
(PREREG) (_aTotal[71]:= 0,.T.)
(PREREG) _aTotal[76] := {|| _aTotal[71] += SFT->FT_TOTAL}
(PREREG) (SFT->(DbEval(_aTotal[76] ,, {|| !SFT->(Eof()) .And. xFilial("SFT")+SFT->(FT_TIPOMOV+FT_CLIEFOR+FT_LOJA+FT_SERIE+FT_NFISCAL) == xFilial("SF3")+"S"+SF3->(F3_CLIEFOR+F3_LOJA+F3_SERIE+F3_NFISCAL)}) ), .T.)
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)

//--Montagem do arquivo
Serie_Sub  C 005 0 SerieNfId("SF3",2,"F3_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF3->F3_NFISCAL)))+Alltrim(SF3->F3_NFISCAL)
Dt_Emi_Doc C 008 0 DataInt(SF3->F3_EMISSAO)
Cod_Partic C 014 0 _aTotal[30]
Vl_TotServ N 017 2 _aTotal[71]
Vl_TotDesc N 017 2 SF2->F2_DESCONT
Aliq_IRRF  N 005 2 0
BaseC_IRRF N 017 2 0
Vl_IRRF    N 017 2 SF2->F2_VALIRRF
Ind_Cancel C 001 0 If(!Empty(SF3->F3_DTCANC),"S","N")

(POS) FsQuery(_aTotal[90], 2)
(POSREG) _aTotal[87] := xFilial("SF3")+SF3->(F3_CLIEFOR+F3_LOJA+F3_NFISCAL+F3_SERIE+DTOS(F3_DTCANC))

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                        ³
//³REGISTRO ITENS NOTAS FISCAIS DE SERVICO - SAIDAS (4.3.6)³
//³                                                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD2 4.3.6 Itens Servicos]
(ARQ) 436ITESERVE.TXT
(IMP){.T., 0, 0, ""}
(CMP){{"Serie_Sub", "Serie Doc."}, {"Numero_Doc", "Num. Doc."}, {"Dt_Emi_Doc","Dt. Emis."}, {"Cod_Servic", "Cod. Servico"}, {"Vl_Servico","Val. Servico"}, {"Vl_Descont","Val. Desconto"}, {"Aliq_ISS","Aliq. ISS"},{"BaseC_ISS","Base ISS"},{"Vl_ISS","Val. ISS"}}

(PRE) SA1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1)) 
(PRE) _aTotal[90] := {"SD2",""}
(PRE) _aTotal[98] := "D2_FILIAL+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_COD+D2_ITEM"
(PRE) _aTotal[87] := ""
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D2_FILIAL = '" + xFilial("SD2") + "' AND "
(PRE) _aTotal[91] += "D2_EMISSAO BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' "
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D2_FILIAL == '" + xFilial("SD2") + "' .And. "
(PRE) _aTotal[99] += "DTOS(D2_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. DTOS(D2_EMISSAO) <= '" + DTOS(MV_PAR02) + "'"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()  
//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD2->D2_TES)) .And. SF4->F4_ISS == "S"
(PREREG) SA1->(MsSeek(xFilial("SA1")+SD2->D2_CLIENTE+SD2->D2_LOJA))
(PREREG) (If(ASCAN(_aTotal[85],SD2->D2_TES)==0,AADD(_aTotal[85],SD2->D2_TES),.T.),.T.) 
(PREREG) _aTotal[88] := If(_aTotal[86],0,Iif(_aTotal[87]==SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA,_aTotal[88]+1,1))
(PREREG) _aTotal[87] := SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA  
(PREREG) If(AScan(_aTotal[32], RIGHT(Trim(SD2->D2_COD),20)) == 0, (AAdd(_aTotal[32], RIGHT(Trim(SD2->D2_COD),20)), .T.), .T.)
//--Montagem do arquivo
Serie_Sub  C 005 0 SerieNfId("SD2",2,"D2_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD2->D2_DOC)))+Alltrim(SD2->D2_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD2->D2_EMISSAO)
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD2->D2_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD2->D2_ITEM,3),Str(_aTotal[88])))
Cod_Servic C 020 0 RIGHT(Trim(SD2->D2_COD),20) 
Desc_Compl C 045 0 SPACE(45)
Vl_Servico N 017 2 SD2->D2_TOTAL
Vl_Descont N 017 2 SD2->D2_DESCON
Aliq_ISS   N 005 2 Iif (SD2->D2_ALIQISS==0, SD2->D2_PICM, SD2->D2_ALIQISS)
BaseC_ISS  N 017 2 Iif (SD2->D2_BASEISS==0, SD2->D2_BASEICM, SD2->D2_BASEISS)
Vl_ISS     N 017 2 Iif (SD2->D2_VALISS==0, SD2->D2_VALICM, SD2->D2_VALISS)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                      ³
//³REGISTRO MESTRE DE NOTAS FISCAIS DE SERV. EMITIDAS P/ TERCEIRO (4.3.8)³
//³                                                                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF3 4.3.8 Arquivo Mestre de notas fiscais de servico emitidas por terceiros]
(ARQ) 438MESTENTR.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(3))
(PRE) SF3->(dbSetOrder(5))

(PRE) _aTotal[87] := "" 
(PRE) _aTotal[98] := "F3_FILIAL+F3_SERIE+F3_NFISCAL+F3_CLIEFOR+F3_LOJA+F3_IDENTFT"
(PRE) _aTotal[98] := IndexKey()
(PRE) _aTotal[90] := {"SF3",""}
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "F3_FILIAL = '" + xFilial("SF3") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "F3_ENTRADA", "F3_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "F3_CODISS <> '' AND F3_FORMUL <> 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "F3_FILIAL == '" + xFilial("SF3") + "' .And. "
(PRE) _aTotal[99] += "DTOS(F3_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += "DTOS(F3_EMISSAO) <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "F3_CODISS <> '' .And. F3_FORMUL <> 'S'"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) SF3->(DbGoTop())
//--Pre-Processamento do Registro de Arquivo
(PREREG) SFT->(dbSeek(xFilial("SFT")+"E"+SF3->(F3_CLIEFOR+F3_LOJA+F3_SERIE+F3_NFISCAL+F3_IDENTFT)))
(PREREG) SD1->(dbSeek(xFilial("SD1")+SFT->(FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA+FT_PRODUTO+FT_ITEM)))
(PREREG) SA2->(MsSeek(xFilial("SA2")+SF3->(F3_CLIEFOR+F3_LOJA)))
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) (Iif(ASCAN(_aTotal[85],SD1->D1_TES)==0,AADD(_aTotal[85],SD1->D1_TES),.T.),.T.)
(PREREG) _aTotal[88] := Iif(_aTotal[86],0,Iif(_aTotal[87]==SF3->(F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA),_aTotal[88]+1,1))
(PREREG) _aTotal[87] := SF3->(F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)
(PREREG) (_aTotal[71]:= 0,.T.)
(PREREG) (_aTotal[72]:= 0,.T.)
(PREREG) (_aTotal[73]:= 0,.T.)
(PREREG) (_aTotal[74]:= 0,.T.)
(PREREG) (_aTotal[75]:= 0,.T.)
(PREREG) _aTotal[76] := {|| _aTotal[71] += SFT->FT_TOTAL , _aTotal[72] += SFT->FT_DESCONT , _aTotal[73] := SFT->FT_ALIQIRR , _aTotal[74] += SFT->FT_BASEIRR , _aTotal[75] += SFT->FT_VALIRR }
(PREREG) (SFT->(DbEval(_aTotal[76] ,, {|| !SFT->(Eof()) .And. xFilial("SFT")+SFT->(FT_TIPOMOV+FT_CLIEFOR+FT_LOJA+FT_SERIE+FT_NFISCAL+FT_IDENTF3 ) == xFilial("SF3")+"E"+SF3->(F3_CLIEFOR+F3_LOJA+F3_SERIE+F3_NFISCAL+F3_IDENTFT)}) ), .T.)
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
//--Montagem do arquivo
SerSub_Doc C 005 0 SerieNfId("SF3",2,"F3_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF3->F3_NFISCAL)))+Alltrim(SF3->F3_NFISCAL)
Dt_Emi_Doc C 008 0 DataInt(SF3->F3_EMISSAO)
Participa  C 014 0 _aTotal[30]
Vlr_Serv   N 017 2 _aTotal[71]
Vlr_Desc   N 017 2 _aTotal[72]
Aliq_Irrf  N 005 2 _aTotal[73]
Base_Irrf  N 017 2 _aTotal[74]
Vlr_Irrf   N 017 2 _aTotal[75]

(POSREG) _aTotal[71] := 0
(POSREG) _aTotal[72] := 0
(POSREG) _aTotal[73] := 0
(POSREG) _aTotal[74] := 0
(POSREG) _aTotal[75] := 0
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                        ³
//³REGISTRO ITENS DE NOTAS FISCAIS DE SERVICO EMITIDAS P/ TERCEIRO (4.3.9) ³
//³                                                                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD1 4.3.9 Arquivo de Itens de notas fiscais de servico emitidas por terceiros]
(ARQ) 439ENTR.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[87] := "" 
(PRE) _aTotal[98] := IndexKey()
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[98] := "D1_FILIAL+D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_COD+D1_ITEM"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D1_FILIAL = '" + xFilial("SD1") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "D1_DTDIGIT", "D1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "D1_CODISS <> '' AND D1_FORMUL <> 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D1_FILIAL == '" + xFilial("SD1") + "' .And. "
(PRE) _aTotal[99] += "DTOS(D1_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += "DTOS(D1_EMISSAO) <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "D1_CODISS <> '' .And. D1_FORMUL <> 'S'"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()  

//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) SFT->(MsSeek(xFilial("SFT")+"E"+SD1->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_ITEM)))
(PREREG) SF1->(MsSeek(xFilial("SF1")+SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)))
(PREREG) SA2->(MsSeek(xFilial("SA2")+SF1->(F1_FORNECE+F1_LOJA)))
(PREREG) (Iif(ASCAN(_aTotal[85],SD1->D1_TES)==0,AADD(_aTotal[85],SD1->D1_TES),.T.),.T.) 
(PREREG) _aTotal[88] := Iif(_aTotal[86],0,Iif(_aTotal[87]==SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA),_aTotal[88]+1,1))
(PREREG) _aTotal[87] := SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
(PREREG) If(AScan(_aTotal[32], RIGHT(Trim(SD1->D1_COD),20)) == 0, (AAdd(_aTotal[32], RIGHT(Trim(SD1->D1_COD),20)), .T.), .T.)
//--Montagem do arquivo
SerSub_Doc C 005 0 SerieNfId("SD1",2,"D1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD1->D1_DOC)))+Alltrim(SD1->D1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD1->D1_EMISSAO)
Participa  C 014 0 _aTotal[30]
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))
Cod_Servic C 020 0 RIGHT(Trim(SD1->D1_COD),20)
Desc_Compl C 045 0 SPACE(45)
Vlr_Serv   N 017 2 SFT->FT_TOTAL
Vlr_Desc   N 017 2 SFT->FT_DESCONT
Aliq_Iss   N 005 2 SFT->FT_ALIQICM
Base_Iss   N 017 2 SFT->FT_BASEICM
Vlr_Iss    N 017 2 SFT->FT_VALCONT           
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                                    ³
//³REGISTRO MERCADORIA/SERVICO EMITIDO P/ EQUIP. EMISSOR DE CUPOM FISCAL - ECF (4.3.10)³
//³                                                                                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SFT 4.3.10 Arq de Saida Mercadoria/servico emitido por equip emissor de cupom fiscal ECF]
(ARQ) 4310SAIDA.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF2->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD2->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[105] := RddName() = "TOPCONN" 
(PRE) _aTotal[87]  := "" 
(PRE) _aTotal[98]  := IndexKey()
(PRE) _aTotal[90]  := {"SFT",""} 
(PRE) _aTotal[103] := Iif(!Empty(AllTrim(xFilial("SB1")) ), "B1_FILIAL = FT_FILIAL AND " , "" ) 
//--Montagem para o "WHERE" 
(PRE) _aTotal[91] := " FT_FILIAL = '" + cFilant + "' AND FT_EMISSAO BETWEEN '" + Dtos(MV_PAR01) + "' AND '" + Dtos(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "(FT_ESPECIE = 'ECF' OR FT_ESPECIE = 'CF') " 
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "FT_FILIAL == '" + xFilial("SFT") + "' .And. "
(PRE) _aTotal[99] += "DTOS(FT_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. DTOS(FT_EMISSAO) <= '" + DTOS(MV_PAR02) + "'"
//-- Montagem para o Order By:
(PRE) _aTotal[98] := Iif(_aTotal[105] , " FT_EMISSAO,FT_PRODUTO " , "FT_FILIAL+FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA+FT_PRODUTO+FT_ITEM" )
//-- Montagem para o Select:
(PRE) _aTotal[101] := " FT_EMISSAO,FT_ESPECIE,FT_PRODUTO, B1_POSIPI,SUM(FT_QUANT) FT_QUANT,"
(PRE) _aTotal[101] += " SUM(FT_BASEICM)FT_BASEICM, SUM(FT_VALICM)FT_VALICM, SUM(FT_VALCONT)FT_VALCONT "
//-- Montagem para o Group By:
(PRE) _aTotal[102] := " FT_EMISSAO,FT_ESPECIE,FT_PRODUTO, B1_POSIPI" 
//-- Montagem para o Inner Join 
(PRE) _aTotal[104] := {'SB1', _aTotal[103]  +  " B1_COD = FT_PRODUTO " }

(PRE) FsQuery(_aTotal[90], 1 ,_aTotal[91], _aTotal[99] ,_aTotal[98], Nil , _aTotal[104] ,_aTotal[101],_aTotal[102], Nil, Nil)
(PRE) DbGoTop()  
//--Pre-Processamento do Registro de Arquivo
(PREREG) Iif(_aTotal[105] , .T. , SFT->(MsSeek(xFilial("SFT")+"S"+SFT->(FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM))) .And. Alltrim(SFT->FT_ESPECIE) == "CF" )
(PREREG) Iif(_aTotal[105] , .T. , SF4->(MsSeek(xFilial("SF4")+SD2->D2_TES)) )
(PREREG) Iif(_aTotal[105] , .T. , SB1->(MsSeek(xFilial("SB1")+SFT->FT_PRODUTO)) )
(PREREG) Iif(_aTotal[105] , .T. , SA2->(MsSeek(xFilial("SA2")+SFT->(FT_CLIEFOR+FT_LOJA))) )
(PREREG) Iif(_aTotal[105] , .T. , SD2->(MsSeek(xFilial("SFT")+SFT->(FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA))) )
(PREREG) Iif(_aTotal[105] , .T. , (Iif(ASCAN(_aTotal[85],SD2->D2_TES)==0,AADD(_aTotal[85],SD2->D2_TES),.T.),.T.)  )
(PREREG) Iif(_aTotal[105] , .T. , _aTotal[88] := Iif(_aTotal[86],0,Iif(_aTotal[87]==SD2->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA),_aTotal[88]+1,1)) )
(PREREG) Iif(_aTotal[105] , .T. , _aTotal[87] := SD2->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA) )
//-- TABELA TEMPORARIA SUBSTITUINDO A TABELA SFT
//--Montagem do arquivo
Dt_Emi_Doc C 008 0 DataInt(SFT->FT_EMISSAO)
Modelo_Doc C 002 0 iif(Alltrim(SFT->FT_ESPECIE) == "NFS" .Or. Alltrim(SFT->FT_ESPECIE) == "NFPS","03",AModNot(SFT->FT_ESPECIE))					
Cod_Servic C 020 0 SFT->FT_PRODUTO
Cla_Fis_M  C 008 0 SFT->B1_POSIPI
Quantidade N 017 3 SFT->FT_QUANT
Base_Icms  N 017 2 SFT->FT_BASEICM
Aliq_Icms  N 005 2 00000
Vlr_Icms   N 017 2 SFT->FT_VALICM
Vlr_MerSe  N 017 2 SFT->FT_VALCONT
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                                           ³
//³REGISTRO ENTRADA MERCADORIA/SERVICO EMITIDO P/ EQUIP EMISSOR DE CUPOM FISCAL - ECF (4.3.11)³
//³                                                                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD1 4.3.11 Arq de Entrada Mercadoria/servico emitido por equip emissor de cupom fiscal ECF]
(ARQ) 4311ENTRA.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[87] := "" 
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[98] := IndexKey()
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D1_FILIAL = '" + xFilial("SD1") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "D1_DTDIGIT", "D1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D1_FILIAL == '" + xFilial("SD1") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "'"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()  

//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) SFT->(MsSeek(xFilial("SFT")+"E"+SD1->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_ITEM)))
(PREREG) Alltrim(SFT->FT_ESPECIE) == "CF"
(PREREG) SF1->(MsSeek(xFilial("SF1")+SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)))
(PREREG) SA2->(MsSeek(xFilial("SA2")+SF1->(F1_FORNECE+F1_LOJA)))
(PREREG) (Iif(ASCAN(_aTotal[85],SD1->D1_TES)==0,AADD(_aTotal[85],SD1->D1_TES),.T.),.T.) 
(PREREG) _aTotal[88]:= Iif(_aTotal[86],0,Iif(_aTotal[87]==SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA),_aTotal[88]+1,1))
(PREREG) _aTotal[87]:= SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)

//--Montagem do arquivo
Dt_Entrada C 008 0 DataInt(SD1->D1_DTDIGIT)
Participa  C 014 0 _aTotal[30]
Modelo_Doc C 002 0 iif(AModNot(SF1->F1_ESPECIE)="01" .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS","03",AModNot(SF1->F1_ESPECIE))
Cod_Servic C 020 0 SD1->D1_CODISS
Cla_Fis_M  C 008 0 SPACE(8)
Quantidade N 017 3 SD1->D1_QUANT
Vlr_MerSe  N 017 2 SFT->FT_TOTAL           
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                       ³
//³REGISTRO EXPORTACAO - TERCEIROS (4.4.1)³
//³                                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF3 4.4.1 Arquivo de Exportacao - Terceiros]
(ARQ) 441EXPORTAC.TXT

(PRE) SF3->(DbSetOrder(1))

(PRE) _aTotal[89] := ""
(PRE) _aTotal[90] := {"SF3",""}
(PRE) _aTotal[98] := SF3->(IndexKey())
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "F3_FILIAL = '" + xFilial("SF3") + "' And "
(PRE) _aTotal[91] += If(_aTotal[97], "F3_ENTRADA", "F3_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "F3_CFO LIKE '7%' AND F3_DTCANC = ''"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "F3_FILIAL == '" + xFilial("SF3") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F3_ENTRADA)", "DTOS(F3_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F3_ENTRADA)", "DTOS(F3_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "SubStr(F3_CFO, 1, 1) == '7' .And. Empty(F3_DTCANC)"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()
(PREREG) AModNot(SF3->F3_ESPECIE) <> SPACE(2) .Or. Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS" 

//--Pre-Processamento do Registro de Arquivo
(PREREG) _aTotal[89] <> SF3->(F3_FILIAL+DTOS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)
(PREREG) (_aTotal[50] := RetExpImp("E"),.T.)
//--Montagem do arquivo
Modelo_Doc C 002 0 iif(Alltrim(SF3->F3_ESPECIE) == "NFS" .Or. Alltrim(SF3->F3_ESPECIE) == "NFPS","03",AModNot(SF3->F3_ESPECIE))
Serie_Sub  C 005 0 SerieNfId("SF3",2,"F3_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF3->F3_NFISCAL)))+Alltrim(SF3->F3_NFISCAL)
Dt_Emi_Doc C 008 0 DataInt(SF3->F3_EMISSAO)
Numero_RE  N 012 0 _aTotal[50][1]
Numero_DDE N 012 0 _aTotal[50][2]

(POSREG) _aTotal[89] := SF3->(F3_FILIAL+DTOS(F3_ENTRADA)+F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                       ³
//³REGISTRO IMPORTACAO - TERCEIROS (4.4.2)³
//³                                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF1 4.4.2 Arquivo de Importacao - Terceiros]
(ARQ) 442IMPORTAC.TXT
(PRE) _aTotal[90] := {"SF1",""}
(PRE) _aTotal[91] := "F1_FILIAL='"+ xFilial("SF1") + IIF(_aTotal[97],"' And F1_DTDIGIT>='", "' And F1_EMISSAO>='") + DTOS(MV_PAR01) +"' And F1_EMISSAO<='"+ DTOS(MV_PAR02) +"'"
(PRE) _aTotal[98] := SF1->(IndexKey())
(PRE) _aTotal[99] := "F1_FILIAL=='"+ xFilial("SF1") +"' .and. " + IIF(_aTotal[97],"DTOS(F1_DTDIGIT)>='","DTOS(F1_EMISSAO)>='")+ DTOS(MV_PAR01) +"' .and. DTOS(F1_ENTRADA)<='"+ DTOS(MV_PAR02) +"'"
(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()                                               
(PREREG) (_aTotal[50] := RetExpImp("I",.T.),.T.)
(PREREG) !Empty( Alltrim( SF1->F1_ESPECIE ) ) .And. AModNot(SF1->F1_ESPECIE) <> SPACE(2)
(PREREG) SF1->F1_EST == "EX"

Modelo_Doc C 002 0 iif(Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFE","03",AModNot(SF1->F1_ESPECIE))
Serie_Sub  C 005 0 SerieNfId("SF1",2,"F1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF1->F1_DOC)))+Alltrim(SF1->F1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SF1->F1_EMISSAO)
Numero_DI  N 010 0 _aTotal[50][1]
(POS) FsQuery(_aTotal[90],2,_aTotal[91],_aTotal[99],_aTotal[98])

[SD3 Registro de Estoque          ]
(PRE) _aTotal[80] := ""
(PRE) _aTotal[81] := ""
(PRE) SB1->(dbSetOrder(1))
(PRE) _aTotal[98] := SD3->(IndexKey())
(PRE) _aTotal[90] := {"SD3",""}
(PRE) _aTotal[91] := "D3_FILIAL='"+ xFilial("SD3") +"' AND D3_EMISSAO>='"+DTOS(MV_PAR01)+"' AND D3_EMISSAO<='"+DTOS(MV_PAR02)+"'"
(PRE) _aTotal[99] := "D3_FILIAL=='"+ xFilial("SD3") +"' .And. DTOS(D3_EMISSAO)>='"+ DTOS(MV_PAR01) +"' .And. DTOS(D3_EMISSAO)<='"+ DTOS(MV_PAR02) +"'"
(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD3->D3_COD))
(PREREG) (_aTotal[80] := Iif(!Empty(SD3->D3_OP) .And. SubStr(SD3->D3_CF,1,2) == "PR" .And. Empty(SD3->D3_ESTORNO),"OP",""),.T.)
(PREREG) (_aTotal[80] := Iif(SubStr(SD3->D3_CF,1,2) == "RE","REQ",_aTotal[80]),.T.)
(PREREG) (_aTotal[80] := Iif(SubStr(SD3->D3_CF,1,2) == "DE","DEV",_aTotal[80]),.T.)
(PREREG) (_aTotal[81] := Iif(!Empty(SD3->D3_OP) .And. SubStr(SD3->D3_CF,1,2) == "PR" .And. Empty(SD3->D3_ESTORNO),"ORDEM DE PRODUCAO",""),.T.)
(PREREG) (_aTotal[81] := Iif(SubStr(SD3->D3_CF,1,2) == "RE","REQUISICAO",_aTotal[81]),.T.)
(PREREG) (_aTotal[81] := Iif(SubStr(SD3->D3_CF,1,2) == "DE","DEVOLUCAO",_aTotal[81]),.T.)
Cod_Merc   C 020 0 RIGHT(Trim(SD3->D3_COD),20)
Natur_Doc  C 001 0 "I"
TipoDoc    C 003 0 _aTotal[80]
Serie      C 005 0 SPACE(05)
NumDoc     C 012 0 SD3->D3_DOC
Dt_Movto   C 008 0 DataInt(SD3->D3_EMISSAO)
Historico  C 050 0 _aTotal[81]
Unidade    C 003 0 SB1->B1_UM
Quantidade N 017 3 SD3->D3_QUANT
Tipo_Mov   C 001 0 IF(Val(SD3->D3_TM) > 500,"S","E")
Custo_Unit N 017 4 SD3->D3_CUSTO1/SD3->D3_QUANT
ValorTotal N 017 2 SD3->D3_CUSTO1
(POS) FsQuery(_aTotal[90], 2)

[SD1 Registro de Estoque - Movimentacoes com nota fiscal de entrada]
(PRE) SD1->(dbSetOrder(1))
(PRE) SB1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) _aTotal[98] := SD1->(IndexKey())
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[91] := "D1_FILIAL='"+ xFilial("SD1") +"' AND "
(PRE) _aTotal[91] += Iif(_aTotal[97],"D1_DTDIGIT","D1_EMISSAO")
(PRE) _aTotal[91] += ">='"+DTOS(MV_PAR01)+"' AND "
(PRE) _aTotal[91] += Iif(_aTotal[97],"D1_DTDIGIT","D1_EMISSAO")
(PRE) _aTotal[91] += "<='"+DTOS(MV_PAR02)+"' AND D_E_L_E_T_ = ' ' AND D1_CODISS = ' ' "
(PRE) _aTotal[99] := "D1_FILIAL=='"+ xFilial("SD1") +"' .And. DTOS("
(PRE) _aTotal[99] += Iif(_aTotal[97],"D1_DTDIGIT","D1_EMISSAO")
(PRE) _aTotal[99] += ")>='"+ DTOS(MV_PAR01) +"' .And. DTOS("
(PRE) _aTotal[99] += Iif(_aTotal[97],"D1_DTDIGIT","D1_EMISSAO")
(PRE) _aTotal[99] += ")<='"+ DTOS(MV_PAR02) +"' .And. Empty(D1_CODISS) "
(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) !SF4->F4_ESTOQUE <> "S"
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) (IIf(ASCAN(_aTotal[85],SD1->D1_TES)==0,AADD(_aTotal[85],SD1->D1_TES),.T.),.T.)
(PREREG) If( AScan(_aTotal[32], RIGHT(Trim(SD1->D1_COD),20)) == 0, (AAdd(_aTotal[32], RIGHT(Trim(SD1->D1_COD),20)), .T.), .T.)
Cod_Merc   C 020 0 RIGHT(Trim(SD1->D1_COD),20)
Natur_Doc  C 001 0 "F"
TipoDoc    C 003 0 "NF"
Serie      C 005 0 SerieNfId("SD1",2,"D1_SERIE")
NumDoc     C 012 0 SD1->D1_DOC
Dt_Movto   C 008 0 DataInt(SD1->D1_EMISSAO)
Historico  C 050 0 "NOTA FISCAL"
Unidade    C 003 0 SB1->B1_UM
Quantidade N 017 3 SD1->D1_QUANT
Tipo_Mov   C 001 0 "E"
Custo_Unit N 017 4 SD1->D1_VUNIT
ValorTotal N 017 2 SD1->D1_TOTAL
(POS) FsQuery(_aTotal[90], 2)

[SD2 Registro de Estoque - Movimentacoes com nota fiscal de saida]
(ARQ) 451RESTOQU.TXT
(PRE) SD2->(dbSetOrder(1))
(PRE) SB1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) _aTotal[98] := SD2->(IndexKey())
(PRE) _aTotal[90] := {"SD2",""}
(PRE) _aTotal[91] := "D2_FILIAL='"+ xFilial("SD2") +"' AND D2_EMISSAO>='"+DTOS(MV_PAR01)+"' AND D2_EMISSAO<='"+DTOS(MV_PAR02)+"' AND D_E_L_E_T_ = ' ' AND D2_CODISS = ' ' "
(PRE) _aTotal[99] := "D2_FILIAL=='"+ xFilial("SD2") +"' .And. DTOS(D2_EMISSAO)>='"+ DTOS(MV_PAR01) +"' .And. DTOS(D2_EMISSAO)<='"+ DTOS(MV_PAR02) +"' .And. Empty(D2_CODISS) "
(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()                                    
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD2->D2_TES))
(PREREG) !SF4->F4_ESTOQUE <> "S"
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD2->D2_COD))
(PREREG) (IIf(ASCAN(_aTotal[85],SD2->D2_TES)==0,AADD(_aTotal[85],SD2->D2_TES),.T.),.T.)
Cod_Merc   C 020 0 RIGHT(Trim(SD2->D2_COD),20)
Natur_Doc  C 001 0 "F"
TipoDoc    C 003 0 "NF"
Serie      C 005 0 SerieNfId("SD2",2,"D2_SERIE")
NumDoc     C 012 0 SD2->D2_DOC
Dt_Movto   C 008 0 DataInt(SD2->D2_EMISSAO)
Historico  C 050 0 "NOTA FISCAL"
Unidade    C 003 0 SB1->B1_UM
Quantidade N 017 3 SD2->D2_QUANT
Tipo_Mov   C 001 0 "S"
Custo_Unit N 017 4 SD2->D2_CUSTO1
ValorTotal N 017 2 SD2->D2_TOTAL
(POS) FsQuery(_aTotal[90], 2)

[INV Registro de Inventario       ]
(ARQ) 452INVENTAR.TXT
(PRE) dbGoTop()
Dt_Invent  C 008 0 DataInt(Stod(_aTotal[012][1][1]))
Sit_Estoq  C 001 0 AFISFill(INV->SITUACA,1)
Cod_Merc   C 020 0 AFISFill(INV->CODIGO,20)
Unidade    C 003 0 SubStr (INV->UM, 1, 3)
Quantidade N 017 3 INV->QUANT
Vl_Total   N 017 2 INV->CUSTO
(POS) FsEstInv (_aTotal[77],2)

[SG1 Relacao Insumos /Produto - Arquivo Relacionado: INSUMOS.TXT]
(ARQ) 461INSUMOS.TXT
(IMP) {.T., 0, 0, ""}
(CMP) {{"CodProduto","Cod. Produto"}, {"Unidade","UN"}, {"Cod_Insumo","Cod. Insumo"}, {"Quantidade",""}, {"PerclPerd","%Perd"}, {"Unidade2","2UN"}, {"Dt_Inicial","Dt.Inic."}, {"Dt_Final","Dt.Final"}}
(LEG) "N=Natureza do Bem, TPD=Tipo do documento de Aquisicao"
(PRE) SB1->(dbSetOrder(1))
(PRE) _aTotal[057] := ""
(PREREG) SB1->(MsSeek(xFilial("SB1")+SG1->G1_COD))
(PREREG) IIF((SG1->G1_FILIAL == cFilant),SB1->(MsSeek(xFilial("SB1")+SG1->G1_COD)), SG1->(DbSeek("|")))
(PREREG) (_aTotal[057] := SB1->B1_UM, .T.)
(PREREG) SB1->(MsSeek(xFilial("SB1")+SG1->G1_COMP))
CodProduto C 020 0 RIGHT(Trim(SG1->G1_COD),20)
Unidade    C 003 0 Subs(_aTotal[057],1,3)
Cod_Insumo C 020 0 SG1->G1_COMP
Quantidade N 017 3 SG1->G1_QUANT
PerclPerd  N 005 2 SG1->G1_PERDA
Unidade2   C 003 0 Subs(SB1->B1_UM,1,3)
Dt_Inicial C 008 0 DataInt(SG1->G1_INI)
Dt_Final   C 008 0 DataInt(SG1->G1_FIM)

[SN3 Ativo Fixo - Arquivo Relacionado: ATIVO.TXT]
(ARQ) 471ATIVO.TXT
(IMP) {.T., 0, 0, ""}
(CMP) {{"NumCadBens","Num. Cadastro Bem"}, {"NatBem","N"}, {"IdentBem","Identificacao do bem"}, {"CtaBem","Conta Analitica"}, {"CtaDeprAcu","Cta Analitica Depreciacao"}, {"DtaAquis","Dt.Aquis"}, {"Tipo_Doc","TPD"}, {"Num_Serie","Serie"}, {"Ndoc_Aquis","Num.Docum."}, {"Val_Aquis","Vlr. Aquis. Reais"}, {"Vl_depracm","Depr.Acum."}, {"Vl_deprper","Depr.Lanc."}}
(LEG) "N=Natureza do Bem, TPD=Tipo do documento de Aquisicao"
(PRE) SN1->(dbSetOrder(1))
(PREREG) SN1->(MsSeek(xFilial("SN1")+SN3->N3_CBASE+SN3->N3_ITEM))
(PREREG) DTOS(MV_PAR01)<=DTOS(SN3->N3_AQUISIC) .And. DTOS(SN3->N3_AQUISIC) <= DTOS(MV_PAR02)  
NumCadBens C 020 0 SN3->N3_CBASE+SN3->N3_ITEM
NatBem     C 001 0 "1"
NumBemPrin C 020 0 SPACE(20)
IdentBem   C 045 0 SN1->N1_DESCRIC
CtaBem     C 028 0 SN3->N3_CCONTAB
CtaDeprAcu C 028 0 SN3->N3_CCDEPR
DtaAquis   C 008 0 DataInt(SN3->N3_AQUISIC)
Tipo_Doc   C 003 0 "NF "
Num_Serie  C 005 0 SerieNfId("SN1",2,"N1_SERIE")
Ndoc_Aquis C 012 0 SN1->N1_NFISCAL
Val_Aquis  N 017 2 SN3->N3_VORIG1
Val_Reais  N 017 2 SN3->N3_VORIG1
Identifica C 012 0 SN1->N1_CHAPA
DtaIniDepr C 008 0 DataInt(SN3->N3_DINDEPR)
TxDeprec   N 005 2 SN3->N3_TXDEPR1
Vl_depracm N 017 2 RetDepPer(N3_CBASE,N3_ITEM,N3_TIPO,CTOD("  /  /  "),CTOD("31/12/"+ALLTRIM(STR(YEAR(mv_par02)-1))))
Vl_deprper N 017 2 RetDepPer(N3_CBASE,N3_ITEM,N3_TIPO,mv_par01,mv_par02)
DtaBaixa   C 008 0 If(!Empty(SN3->N3_DTBAIXA) .And. SN3->N3_DTBAIXA >= mv_par01 .And. SN3->N3_DTBAIXA <= mv_par02, DataInt(SN3->N3_DTBAIXA), Space(8))

[SRD Folha Pagamento - Arquivo relacionado: FOLHA.TXT]
(ARQ) 481FOLHA.TXT
(IMP) {.T., 0, 0, ""}
(CMP) {{"TipoFolha","T"}, {"NumRegEmpr",""}, {"DtaCompet","DtCompet"}, {"DtaPagto",""}, {"CodProv","CdP"}, {"ValProv","Vlr Provento"}, {"IndProv","I"}, {"IndIncIRR","F"}}
(LEG) "T=Tipo de Folha, CdP=Codigo do Provento/Desconto, I=Indicador de Provento/Desconto e F=Indicador de Incidencia para o IRRF"
(PRE) _aTotal[61] := {"SRD",""}
(PRE) _aTotal[62] := "RD_DATARQ>='"+MesAno(MV_PAR01)+"' AND RD_DATARQ<= '"+ MesAno(MV_PAR02)+"' AND RD_EMPRESA= '"+ SPACE(02)+"' AND RV_TIPOCOD <> '3' "
(PRE) _aTotal[63] := "RD_DATARQ>='"+MesAno(MV_PAR01)+"' .AND. RD_DATARQ<='"+ MesAno(MV_PAR02)+"' .AND. RD_EMPRESA='"+ SPACE(02)+"'"
(PRE) _aTotal[80] := {"SRV", If(!empty(xFILIAL("SRV")),"RD_FILIAL||RD_PD = RV_FILIAL||RV_COD","RD_PD = RV_COD" )}
(PRE) _aTotal[64] := "RD_FILIAL+RD_MAT+RD_DATARQ+RD_PD+"+If(IfDefTop() .AND. TcSrvType()<>"AS/400" ,"","RD_SEMANA+RD_SEQ+")+"RD_CC"
(PRE) _aTotal[83] := "RD_FILIAL,RD_MAT,RD_DATARQ,RD_DATPGT,RD_PD,RD_CC,SUM(RD_VALOR) AS VALOR,RV_TIPOCOD,RV_IR,RV_INSS,RV_REF13,RV_FGTS,RV_CODFOL,RV_REFFER"
(PRE) _aTotal[84] := "RD_FILIAL,RD_MAT,RD_DATARQ,RD_PD,RD_CC,RV_TIPOCOD,RD_DATPGT,RV_IR,RV_INSS,RV_REF13,RV_FGTS,RV_CODFOL,RV_REFFER"
(PRE) FsQuery({"SRD",""},1,_aTotal[62],_aTotal[63],_aTotal[64],,_aTotal[80],_aTotal[083],_aTotal[084])
TipoFolha  C 001 0 fTp_Folha(SRD->RD_PD,"IN86")
NumRegEmpr C 012 0 SRD->RD_MAT
DtaCompet  C 008 0 DataInt(dDatabase)
DtaPagto   C 008 0 DataInt(SRD->RD_DATPGT)
CodProv    C 003 0 SRD->RD_PD
ValProv    N 017 2 If(IfDefTop().AND. TcSrvType()<>"AS/400",SRD->VALOR,SRD->RD_VALOR)
IndProv    C 001 0 VERPD(SRD->RD_PD)
IndIncIRR  C 001 0 SRV->RV_IR
(POS) FsQuery({"SRD",""}, 2)

[SRA Cadastro de Empregados - Arquivo relacionado: EMPREGAD.TXT]
(ARQ) 482EMPREGAD.TXT
(IMP) {.T., 0, 0, ""}
(CMP) {{"DtaAtuali","Dt.Atual"},{"NumRegEmpr",""},{"Cpf",""},{"NomeComp","Nome Completo"},{"DtaNasc","Dt.Nasc"},{"DtaAdmis","Dt.Admis"},{"DtaDemis","Dt.Demis"},{"Funcao",""},{"QtDepIr","QTD"}}
(LEG) "QTD=Quantidade de dependentes para fins de IRRF"
(PRE) _aTotal[61] := {"SRA",""}
(PRE) _aTotal[62] := "Substring(RA_ADMISSA,1,6) <= '"+MesAno(MV_PAR02)+"' AND ( RA_DEMISSA = '' OR SUBSTRING(RA_DEMISSA,1,6)>= '"+ MesAno(MV_PAR01)+"')"
(PRE) _aTotal[63] := "MesAno(RA_ADMISSA) <= '"+MesAno(MV_PAR02)+"' .AND. (EMPTY(RA_DEMISSA) .OR. MesAno(RA_DEMISSA)>='"+MesAno(MV_PAR01)+"')"
(PRE) _aTotal[80] := {"SRJ", If(!empty(xFILIAL("SRJ")),"RA_FILIAL||RA_CODFUNC = RJ_FILIAL||RJ_FUNCAO","RA_CODFUNC = RJ_FUNCAO" )}
(PRE) _aTotal[64] := "RA_FILIAL+RA_MAT"
(PRE) _aTotal[83] := "RA_FILIAL,RA_MAT,RA_CIC,RA_NOME,RA_NASC,RA_ADMISSA,RA_DEMISSA,RA_DEPIR,RJ_DESC"
(PRE) _aTotal[84] := "RA_FILIAL,RA_MAT,RA_CIC,RA_NOME,RA_NASC,RA_ADMISSA,RA_DEMISSA,RA_DEPIR,RJ_DESC"
(PRE) FsQuery({"SRA",""},1,_aTotal[62],_aTotal[63],_aTotal[64],,_aTotal[80],_aTotal[083],_aTotal[084])
(PREREG) If(IfDefTop() .AND. TcSrvType()<>"AS/400",.T.,SRJ->(MsSeek(xFilial("SRJ",SRA->RA_FILIAL)+SRA->RA_CODFUNC)))
DtaAtuali  C 008 0 _aTotal[66]
NumRegEmpr C 012 0 SRA->RA_MAT
Cpf        C 014 0 SRA->RA_CIC
NomeComp   C 070 0 SRA->RA_NOME
DtaNasc    C 008 0 DataInt(SRA->RA_NASC)
DtaAdmis   C 008 0 DataInt(SRA->RA_ADMISSA)
DtaDemis   C 008 0 DataInt(SRA->RA_DEMISSA)                                      
Funcao     C 020 0 If(IfDefTop() .AND. TcSrvType()<>"AS/400",SRA->RJ_DESC,SRJ->RJ_DESC)
QtDepIr    C 003 0 StrZero(Val(SRA->RA_DEPIR),3)
(POS) FsQuery({"SRA",""}, 2)
(POS) SA4->(MsSeek(xFilial("SA4")))

[SI1 Tabela Plano de Contas       ]
(ARQ) &If("CON"$GETMV("MV_MCONTAB"),"492PLANO.TXT","")
(PRE) SI1->(dbSetOrder(1))
(PRE) SI1->(MsSeek(xFilial("SI1")))    
(PRE) _aTotal[38] := SI1->(FieldPos ("I1_USERLGI"))>0 .And. SI1->(FieldPos ("I1_USERLGA"))>0
(PREREG) "CON"$GETMV("MV_MCONTAB")  
(PREREG) ( Iif( _aTotal[38] , SI1->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39] := Iif( Empty( _aTotal[39] ), dDataBase , _aTotal[39])
Dt_Atualiz C 008 0 _aTotal[66]
Cod_Conta  C 028 0 SI1->I1_CODIGO
Tip_Conta  C 001 0 SI1->I1_CLASSE
CodCta_Tot C 028 0 SI1->I1_CTASUP
Desc_Conta C 045 0 SI1->I1_DESC

[CT1 Tabela Plano de Contas       ]
(ARQ) &If("CTB"$GETMV("MV_MCONTAB"),"492PLANO2.TXT","")
(PRE) CT1->(MsSeek(xFilial("CT1"),.T.))
(PRE) _aTotal[38] := CT1->(FieldPos ("CT1_USERGI"))>0 .And. CT1->(FieldPos ("CT1_USERGA"))>0
(PREREG) "CTB"$GETMV("MV_MCONTAB")  
(PREREG) ( Iif( _aTotal[38] , CT1->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39] := Iif( Empty( _aTotal[39] ), dDataBase , _aTotal[39])
Data       C 008 0 _aTotal[66]
Conta      C 028 0 CT1->CT1_CONTA
TipoConta  C 001 0 If(CT1->CT1_CLASSE="1", "S", "A")
Conta      C 028 0 CT1->CT1_CTASUP
Descricao  C 045 0 CT1->CT1_DESC01

[SI1 Tabela Plano de Contas Auxiliar   ]
(ARQ) &If("CON"$GETMV("MV_MCONTAB"),"492PLANOA.TXT","")
(PRE) SI1->(dbSetOrder(1))
(PRE) SI1->(MsSeek(xFilial("SI1")))    
(PRE) _aTotal[38] := SI1->(FieldPos ("I1_USERLGI"))>0 .And. SI1->(FieldPos ("I1_USERLGA"))>0
(PREREG) "CON"$GETMV("MV_MCONTAB")
(PREREG) ( Iif( _aTotal[38] , SI1->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39] := Iif( Empty( _aTotal[39] ), dDataBase , _aTotal[39])
(PREREG) (SI1->I1_CLASSE == "A")
Dt_Atualiz C 008 0 _aTotal[66]
Cod_Conta  C 028 0 Substr( SI1->I1_CODIGO , 1, 1 ) + "0" + Substr( SI1->I1_CODIGO , 2, len(SI1->I1_CODIGO)-1 )
Tip_Conta  C 001 0 SI1->I1_CLASSE
CodCta_Tot C 028 0 SI1->I1_CODIGO
Desc_Conta C 045 0 SI1->I1_DESC

[CT1 Tabela Plano de Contas Auxiliar  ]
(ARQ) &If("CTB"$GETMV("MV_MCONTAB"),"492PLANOA2.TXT","")
(PRE) CT1->(MsSeek(xFilial("CT1"),.T.))
(PRE) _aTotal[38] := CT1->(FieldPos ("CT1_USERGI"))>0 .And. CT1->(FieldPos ("CT1_USERGA"))>0
(PREREG) "CTB"$GETMV("MV_MCONTAB")  
(PREREG) ( Iif( _aTotal[38] , CT1->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39] := Iif( Empty( _aTotal[39] ), dDataBase , _aTotal[39])
(PREREG) (CT1->CT1_CLASSE <> "1")
Data       C 008 0 _aTotal[66]
Conta      C 028 0 Substr( CT1->CT1_CONTA , 1, 1 ) + "0" + Substr( CT1->CT1_CONTA , 2, Len(CT1->CT1_CONTA)-1 )
TipoConta  C 001 0 "A"
Conta      C 028 0 CT1->CT1_CONTA
Descricao  C 045 0 CT1->CT1_DESC01

[SI3 Tabela Centro de Custo       ]
(ARQ) &If("CON"$GETMV("MV_MCONTAB"),"493CENTRO.TXT","")
(PREREG) "CON"$GETMV("MV_MCONTAB")  
(PRE) _aTotal[38] := SI3->(FieldPos ("I3_USERLGI"))>0 .And. SI3->(FieldPos ("I3_USERLGA"))>0
(PREREG) !EMPTY(SI3->I3_DESC)
(PREREG) ( Iif( _aTotal[38] , SI3->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39] := Iif( Empty( _aTotal[39] ), dDataBase , _aTotal[39])
Dt_Atualiz C 008 0 _aTotal[66]
Cod_CCusto C 028 0 SI3->I3_CUSTO
Descricao  C 045 0 SI3->I3_DESC
             
[CTT Tabela Centro de Custo       ]
(ARQ) &If("CTB"$GETMV("MV_MCONTAB"),"493CENTRO2.TXT","")
(PREREG) "CTB"$GETMV("MV_MCONTAB")  
(PRE) _aTotal[38] := CTT->(FieldPos ("CTT_USERLGI"))>0 .And. CTT->(FieldPos ("CTT_USERLGA"))>0
(PREREG) !EMPTY(CTT->CTT_DESC01)
(PREREG) ( Iif( _aTotal[38] , CTT->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39] := Iif( Empty( _aTotal[39] ), dDataBase , _aTotal[39])
Dt_Atualiz C 008 0 _aTotal[66]
Cod_CCusto C 028 0 PADR(CTT->CTT_CUSTO,28)
Descricao  C 045 0 PADR(CTT->CTT_DESC01,45)

[SRV Tabela Provento/Desconto     ]
(ARQ) 496PROVENTO.TXT
(PRE) SRV->(dbGoTop())
(PRE) _aTotal[38] := SRV->(FieldPos ("RV_USERLGI"))>0 .And. SRV->(FieldPos ("RV_USERLGA"))>0
(PRE) _aTotal[61] := {"SRV",""}
(PRE) _aTotal[62] := " RV_TIPOCOD ='1' OR RV_TIPOCOD='2'"
(PRE) _aTotal[63] := " RV_TIPOCOD ='1' .OR. RV_TIPOCOD='2'"
(PRE) _aTotal[64] := "RV_FILIAL+RV_COD"
(PRE) FsQuery({"SRV",""},1,_aTotal[62],_aTotal[63],_aTotal[64])
(PREREG) ( Iif( _aTotal[38] , SRV->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39] := Iif( Empty( _aTotal[39] ), dDataBase , _aTotal[39])
Dt_Atualiz C 008 0 _aTotal[66]
Cod_ProDes C 003 0 SRV->RV_Cod
Descricao  C 045 0 SRV->RV_DESC
(POS) FsQuery({"SRV",""}, 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                              ³
//³REGISTRO COMPLEMENTO DE SAIDA DE MERCADORIAS/SERVICOS (4.10.1)³
//³                                                              ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD2 4.10.1 Arquivo complementar de registro de saida de Mercadorias/Servicos]
(ARQ) 4101PISCOFSAIDA.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD2->(dbSetOrder(3))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[87] := "" 
(PRE) _aTotal[90] := {"SD2",""}
(PRE) _aTotal[98] := IndexKey()
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D2_FILIAL = '" + xFilial("SD2") + "' AND D2_TIPO <> '" + "L" + "' AND "
(PRE) _aTotal[91] += "D2_EMISSAO BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02)+ "'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D2_FILIAL == '" + xFilial("SD2") + "' .And. "
(PRE) _aTotal[99] += "DTOS(D2_EMISSAO) >= '"+ DTOS(MV_PAR01) + "' .And. DTOS(D2_EMISSAO)<= '"+ DTOS(MV_PAR02) + "'"
(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) DbGoTop()                                                     
//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD2->D2_TES))
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD2->D2_COD))
(PREREG) SFT->(MsSeek(xFilial("SFT")+"S"+SD2->(D2_SERIE+D2_DOC+D2_CLIENTE+D2_LOJA+D2_ITEM)))
(PREREG) If(SD2->D2_TIPO$"DB",SA2->(MsSeek(xFilial("SA2")+SFT->FT_CLIEFOR+SFT->FT_LOJA)),SA1->(MsSeek(xFilial("SA1")+SFT->FT_CLIEFOR+SFT->FT_LOJA)))
(PREREG) (Iif(ASCAN(_aTotal[85],SD2->D2_TES)==0,AADD(_aTotal[85],SD2->D2_TES),.T.),.T.) 
(PREREG) _aTotal[88]:= Iif(_aTotal[86],0,Iif(_aTotal[87]==SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA,_aTotal[88]+1,1))
(PREREG) _aTotal[87]:= SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA
(PREREG) AModNot(SFT->FT_ESPECIE) <> SPACE(2) .Or. Alltrim(SFT->FT_ESPECIE) == "NFPS" .Or. Alltrim(SFT->FT_ESPECIE) == "NFS"

//--Montagem do arquivo
Modelo_Doc C 002 0 iif(Alltrim(SFT->FT_ESPECIE) == "NFS" .Or. Alltrim(SFT->FT_ESPECIE) == "NFPS", "03", AModNot(SFT->FT_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SD2",2,"D2_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD2->D2_DOC)))+Alltrim(SD2->D2_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD2->D2_EMISSAO)
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD2->D2_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD2->D2_ITEM,3),Str(_aTotal[88])))
Cod_SitPis C 002 0 Iif(!Empty(SFT->FT_CSTPIS),SFT->FT_CSTPIS,Space(2)) 
Aliq_Pis   N 008 4 Iif(SFT->FT_VALPIS>0 .And. !SFT->FT_CSTPIS$"06" ,SFT->FT_ALIQPIS,0)
Base_Pis   N 017 3 SFT->FT_BASEPIS
Vlr_Pis    N 017 2 Iif(SFT->FT_CSTPIS$"06" , 0, SFT->FT_VALPIS  )
Cod_SitCof C 002 0 Iif(!Empty(SFT->FT_CSTCOF),SFT->FT_CSTCOF,Space(2)) 
Aliq_Cof   N 008 4 Iif(SFT->FT_VALCOF>0 .And. !SFT->FT_CSTCOF$"06" ,SFT->FT_ALIQCOF,0)
Base_Cof   N 017 3 SFT->FT_BASECOF
Vlr_Cof    N 017 2 Iif(SFT->FT_CSTCOF$"06" , 0, SFT->FT_VALCOF  )
Dt_Aprop   C 008 0 DataInt(SD2->D2_EMISSAO)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                      ³
//³REGISTRO COMPLEMENTO DE SAIDA DE SERVICOS NAO SUJEITA AO ICMS (4.10.2)³
//³                                                                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD2 4.10.2 Arquivo complementar de registro de saida de Servicos nao sujeita ao ICMS]
(ARQ) 4102COMPSAIDA.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF2->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD2->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[87] := "" 
(PRE) _aTotal[90] := {"SD2",""}
(PRE) _aTotal[98] := "D2_FILIAL+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_COD+D2_ITEM"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D2_FILIAL = '" + xFilial("SD2") + "' AND "
(PRE) _aTotal[91] += "D2_EMISSAO BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "D2_CODISS <>''" 
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D2_FILIAL == '" + xFilial("SD2") + "' .And. "
(PRE) _aTotal[99] += "DTOS(D2_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. DTOS(D2_EMISSAO) <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "D2_CODISS <>''"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()  
//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD2->D2_TES)) .And. SF4->F4_ISS == "S"
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD2->D2_COD))
(PREREG) SFT->(MsSeek(xFilial("SFT")+"S"+SD2->D2_SERIE+SD2->D2_DOC+SD2->D2_CLIENTE+SD2->D2_LOJA+SD2->D2_ITEM))
(PREREG) SF2->(MsSeek(xFilial("SF2")+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA))
(PREREG) Iif(SD2->D2_TIPO$"DB",SA2->(MsSeek(xFilial("SA2")+SF2->F2_CLIENTE+SF2->F2_LOJA)),SA1->(MsSeek(xFilial("SA1")+SF2->F2_CLIENTE+SF2->F2_LOJA)))
(PREREG) (Iif(ASCAN(_aTotal[85],SD2->D2_TES)==0,AADD(_aTotal[85],SD2->D2_TES),.T.),.T.) 
(PREREG) _aTotal[88]:= Iif(_aTotal[86],0,Iif(_aTotal[87]==SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA,_aTotal[88]+1,1))
(PREREG) _aTotal[87]:= SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA
//--Montagem do arquivo
SerSub_Doc C 005 0 SerieNfId("SD2",2,"D2_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD2->D2_DOC)))+Alltrim(SD2->D2_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD2->D2_EMISSAO)
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD2->D2_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD2->D2_ITEM,3),Str(_aTotal[88])))
Cod_SitPis C 002 0 Iif(!Empty(SFT->FT_CSTPIS),SFT->FT_CSTPIS,Space(2)) 
Aliq_Pis   N 008 4 Iif(SFT->FT_VALPIS>0,SFT->FT_ALIQPIS,0)
Base_Pis   N 017 3 SFT->FT_BASEPIS
Vlr_Pis    N 017 2 SFT->FT_VALPIS
Cod_SitCof C 002 0 Iif(!Empty(SFT->FT_CSTCOF),SFT->FT_CSTCOF,Space(2)) 
Aliq_Cof   N 008 4 Iif(SFT->FT_VALCOF>0,SFT->FT_ALIQCOF,0)
Base_Cof   N 017 3 SFT->FT_BASECOF
Vlr_Cof    N 017 2 SFT->FT_VALCOF
Dt_Aprop   C 008 0 DataInt(SD2->D2_EMISSAO)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                          ³
//³REGISTRO COMPLEMENTO SAIDA DE DOCUMENTOS FISCAIS EMITIDOS POR ECF (4.10.3)³
//³                                                                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SFT 4.10.3 Arquivo complementar de registro de saida de documentos fiscais emitidos por ECF]
(ARQ) 4103PISCOFSADECF.TXT

(PRE) _aTotal[105] := RddName() = "TOPCONN"  
(PRE) _aTotal[90]  := {"SFT",""}  
(PRE) _aTotal[98]  := If (_aTotal[105], "" , IndexKey() )
(PRE) _aTotal[104] := If(!Empty(AllTrim(xFilial("SB1")) ), "B1_FILIAL = FT_FILIAL AND" , "" ) 

//--Montagem para o "WHERE" 
(PRE) _aTotal[91] := " FT_FILIAL = '" + cFilAnt + "' AND FT_EMISSAO BETWEEN '" +  Dtos(MV_PAR01) +  "' AND '" + Dtos(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += " (FT_ESPECIE = 'ECF' OR FT_ESPECIE = 'CF') " 
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "FT_FILIAL == '" + xFilial("SFT") + "' .And. "
(PRE) _aTotal[99] += "DTOS(FT_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. DTOS(FT_EMISSAO) <= '" + DTOS(MV_PAR02) + "'"
//-- Montagem para o Order By:
(PRE) _aTotal[102] := IIf(_aTotal[105] ," FT_EMISSAO,FT_PRODUTO " , "" )
//-- Montagem para o Select:
(PRE) _aTotal[101] := " FT_EMISSAO,FT_ESPECIE,FT_PRODUTO, FT_CSTPIS, FT_ALIQPIS,FT_CSTCOF, FT_ALIQCOF, "
(PRE) _aTotal[101] += " SUM(FT_BASEPIS) FT_BASEPIS, SUM(FT_VALPIS) FT_VALPIS , SUM(FT_VALCOF) FT_VALCOF , SUM(FT_BASECOF) FT_BASECOF"

--Agrupamento
(PRE) _aTotal[102] := " FT_EMISSAO,FT_ESPECIE,FT_PRODUTO,FT_CSTPIS,FT_ALIQPIS, FT_CSTCOF,FT_ALIQCOF"

//-- Montagem para o Inner Join
(PRE) _aTotal[103] := { 'SB1', _aTotal[104]  +  " B1_COD = FT_PRODUTO "  }

(PRE) FsQuery(_aTotal[90], 1 ,_aTotal[91], _aTotal[99] ,Nil, Nil , _aTotal[103] ,_aTotal[101],_aTotal[102], Nil )
(PRE) DbGoTop()  

//--Pre-Processamento do Registro de Arquivo
(PREREG) Iif(_aTotal[105] , .T. , SF4->(MsSeek(xFilial("SF4")+SD2->D2_TES)) .And. SF4->F4_PISCOF <> "4" )
(PREREG) Iif(_aTotal[105] , .T. , SB1->(MsSeek(xFilial("SB1")+SD2->D2_COD)) )
(PREREG) Iif(_aTotal[105] , .T. , SFT->(MsSeek(xFilial("SFT")+"S"+SFT->(FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM))) .And. Alltrim(SFT->FT_ESPECIE) == "CF" )
(PREREG) Iif(_aTotal[105] , .T. , SF2->(MsSeek(xFilial("SF2")+SFT->(FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA))) )
(PREREG) Iif(_aTotal[105] , .T. , (Iif(ASCAN(_aTotal[85],SD2->D2_TES)==0,AADD(_aTotal[85],SD2->D2_TES),.T.),.T.) )
(PREREG) Iif(_aTotal[105] , .T. , _aTotal[88]:= Iif(_aTotal[86],0,Iif(_aTotal[87]==SFT->(FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA),_aTotal[88]+1,1)) )
(PREREG) Iif(_aTotal[105] , .T. ,_aTotal[87]:= SFT->(FT_NFISCAL+FT_SERIE+FT_CLIEFOR+FT_LOJA) )
(PREREG) AModNot(SFT->FT_ESPECIE) <> SPACE(2) .Or. Alltrim(SFT->FT_ESPECIE) == "NFS" .Or. Alltrim(SFT->F3_ESPECIE) == "NFPS" 

//-- TABELA TEMPORARIA SUBSTITUINDO A TABELA SFT
//--Montagem do arquivo
Dt_Emi_Doc C 008 0 DataInt(SFT->FT_EMISSAO)
Modelo_Doc C 002 0 iif(Alltrim(SFT->FT_ESPECIE) == "NFS" .Or. Alltrim(SFT->FT_ESPECIE) == "NFPS","03",AModNot(SFT->FT_ESPECIE))
Cod_Servic C 020 0 SFT->FT_PRODUTO
Cod_SitPis C 002 0 Iif(!Empty(SFT->FT_CSTPIS),SFT->FT_CSTPIS,Space(2)) 
Aliq_Pis   N 008 4 Iif(SFT->FT_VALPIS>0,SFT->FT_ALIQPIS,0)
Base_Pis   N 017 3 SFT->FT_BASEPIS
Vlr_Pis    N 017 2 SFT->FT_VALPIS
Cod_SitCof C 002 0 Iif(!Empty(SFT->FT_CSTCOF),SFT->FT_CSTCOF,Space(2)) 
Aliq_Cof   N 008 4 Iif(SFT->FT_VALCOF>0,SFT->FT_ALIQCOF,0)
Base_Cof   N 017 3 SFT->FT_BASECOF
Vlr_Cof    N 017 2 SFT->FT_VALCOF
Dt_Aprop   C 008 0 DataInt(SFT->FT_EMISSAO)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                                      ³
//³REGISTRO COMPLEMENTO DE ENTRADA MERCADORIAS/SERVICOS EMITIDAS PELA PROPRIA PJ (4.10.4)³
//³                                                                                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD1 4.10.4 Arquivo complementar de registro de Entrada de Mercadorias/Servicos emitidas pela propria PJ]
(ARQ) 4104PISCOFENTR.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[87] := "" 
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[98] := IndexKey()
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D1_FILIAL = '"+ xFilial("SD1") +"' AND "
(PRE) _aTotal[91] += If(_aTotal[97],"D1_DTDIGIT","D1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "(D1_CF LIKE '1%' OR D1_CF LIKE '2%' OR D1_CF LIKE '3%') AND D1_FORMUL = 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D1_FILIAL == '" + xFilial("SD1") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "D1_FORMUL == 'S'"
(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) DbGoTop()  

//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) SFT->(MsSeek(xFilial("SFT")+"E"+SD1->D1_SERIE+SD1->D1_DOC+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_ITEM))
(PREREG) Iif(SD1->D1_TIPO$"DB",SA1->(MsSeek(xFilial("SA1")+SD1->D1_FORNECE+SD1->D1_LOJA)),SA2->(MsSeek(xFilial("SA2")+SD1->D1_FORNECE+SD1->D1_LOJA)))
(PREREG) (Iif(ASCAN(_aTotal[85],SD1->D1_TES)==0,AADD(_aTotal[85],SD1->D1_TES),.T.),.T.) 
(PREREG) _aTotal[88]:= Iif(_aTotal[86],0,Iif(_aTotal[87]==SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA,_aTotal[88]+1,1))
(PREREG) _aTotal[87]:= SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA
(PREREG) (_aTotal[55] := Val(_aTotal[012][2][1]) > 0 .Or. Val(_aTotal[012][2][2]) > 0 .Or. Val(_aTotal[012][2][3]) > 0,.T.)
(PREREG) AModNot(SFT->FT_ESPECIE) <> SPACE(2) .Or. Alltrim(SFT->FT_ESPECIE) == "NFS" .Or. Alltrim(SFT->FT_ESPECIE) == "NFPS" 

//--Montagem do arquivo

Modelo_Doc C 002 0 iif(Alltrim(SFT->FT_ESPECIE) == "NFS" .Or. Alltrim(SFT->FT_ESPECIE) == "NFPS" .Or. Alltrim(SFT->FT_ESPECIE) == "NFE","03",AModNot(SFT->FT_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SD1",2,"D1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD1->D1_DOC)))+Alltrim(SD1->D1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD1->D1_EMISSAO)
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))
Cod_SitPis C 002 0 Iif(!Empty(SFT->FT_CSTPIS),SFT->FT_CSTPIS,Space(2)) 
Aliq_Pis   N 008 4 Iif(SFT->FT_VALPIS>0,SFT->FT_ALIQPIS,0)
Base_Pis   N 017 3 SFT->FT_BASEPIS
Vlr_E_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][1])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",SFT->FT_VALPIS,0))
Vlr_I_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][2])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",0,SFT->FT_VALPIS))
Vlr_N_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][3])/100 ),0)
Vlr_T_Pis  N 017 2 SFT->FT_VALPIS
Cod_SitCof C 002 0 Iif(!Empty(SFT->FT_CSTCOF),SFT->FT_CSTCOF,Space(2))
Aliq_Cof   N 008 4 Iif(SFT->FT_VALCOF>0,SFT->FT_ALIQCOF,0)
Base_Cof   N 017 3 SFT->FT_BASECOF
Vlr_E_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][1])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",SFT->FT_VALCOF,0))
Vlr_I_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][2])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",0,SFT->FT_VALCOF))
Vlr_N_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][3])/100 ),0)
Vlr_T_Cof  N 017 2 SFT->FT_VALCOF
Dt_Aprop   C 008 0 DataInt(SD1->D1_DTDIGIT)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                        ³
//³REGISTRO COMPLEMENTO DE ENTRADA DE SERVICOS NAO SUJEITA AO ICMS (4.10.5)³
//³                                                                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD1 4.10.5 Arquivo complementar de registro de Entrada de Servicos nao sujeita ao ICMS]
(ARQ) 4105COMPENTRTERC.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[87] := " " 
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[98] := IndexKey()
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D1_FILIAL='"+xFilial("SD1")+"' AND " 
(PRE) _aTotal[91] += If(_aTotal[97], "D1_DTDIGIT", "D1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "'  AND "
(PRE) _aTotal[91] += "D1_FORMUL <> 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D1_FILIAL == '" +xFilial("SD1") + "' .And. " 
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)","DTOS(D1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)","DTOS(D1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "D1_FORMUL<>'S'"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()  
//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) SFT->(MsSeek(xFilial("SFT")+"E"+SD1->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_ITEM)))
(PREREG) SF1->(MsSeek(xFilial("SF1")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
(PREREG) Iif(SD1->D1_TIPO$"DB",SA1->(MsSeek(xFilial("SA1")+SD1->D1_FORNECE+SD1->D1_LOJA)),SA2->(MsSeek(xFilial("SA2")+SD1->D1_FORNECE+SD1->D1_LOJA)))
(PREREG) (Iif(ASCAN(_aTotal[85],SD1->D1_TES)==0,AADD(_aTotal[85],SD1->D1_TES),.T.),.T.) 
(PREREG) _aTotal[88]:= Iif(_aTotal[86],0,Iif(_aTotal[87]==SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA,_aTotal[88]+1,1))
(PREREG) _aTotal[87]:= SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
(PREREG) (_aTotal[55] := Val(_aTotal[012][2][1]) > 0 .Or. Val(_aTotal[012][2][2]) > 0 .Or. Val(_aTotal[012][2][3]) > 0,.T.)
(PREREG) AModNot(SF1->F1_ESPECIE) <> SPACE(2) .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS" 
(PREREG) _aTotal[30] := Iif(!SD1->D1_TIPO$"DB",Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC))),Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
//--Montagem do arquivo
Modelo_Doc C 002 0 iif(AModNot(SF1->F1_ESPECIE)="01" .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS","03",AModNot(SF1->F1_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SD1",2,"D1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD1->D1_DOC)))+Alltrim(SD1->D1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD1->D1_EMISSAO)
Participa  C 014 0 _aTotal[30]
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))
Cod_SitPis C 002 0 Iif(!Empty(SFT->FT_CSTPIS),SFT->FT_CSTPIS,Space(2)) 
Aliq_Pis   N 008 4 SFT->FT_ALIQPIS
Base_Pis   N 017 3 SFT->FT_BASEPIS
Vlr_E_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][1])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",SFT->FT_VALPIS,0))
Vlr_I_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][2])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",0,SFT->FT_VALPIS))
Vlr_N_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][3])/100 ),0)
Vlr_T_Pis  N 017 2 SFT->FT_VALPIS
Cod_SitCof C 002 0 Iif(!Empty(SFT->FT_CSTCOF),SFT->FT_CSTCOF,Space(2)) 
Aliq_Cof   N 008 4 Iif(SFT->FT_VALCOF>0,SFT->FT_ALIQCOF,0)
Base_Cof   N 017 3 SFT->FT_BASECOF
Vlr_E_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][1])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",SFT->FT_VALCOF,0))
Vlr_I_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][2])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",0,SFT->FT_VALCOF))
Vlr_N_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][3])/100 ),0)
Vlr_T_Cof  N 017 2 SFT->FT_VALCOF
Dt_Aprop   C 008 0 DataInt(SD1->D1_DTDIGIT)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                         ³
//³REGISTRO COMPLEMENTO DE ENTRADA DE SERVICOS NAO SUJEITA AO ICMS  (4.10.6)³
//³                                                                         ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD1 4.10.6 Arquivo complementar de registro de Entrada de Servicos nao sujeita ao ICMS]
(ARQ) 4106COMPENTR.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[87] := "" 
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[98] := IndexKey()
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D1_FILIAL = '" + xFilial("SD1") + "' AND "
(PRE) _aTotal[91] += IIF(_aTotal[97],"D1_DTDIGIT " ,"D1_EMISSAO ") + "BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "D1_CODISS <> '' AND D1_FORMUL <> 'S'" 
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D1_FILIAL == '" + xFilial("SD1") + "' .And. "
(PRE) _aTotal[99] += "DTOS(D1_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += "DTOS(D1_EMISSAO) <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "D1_CODISS <> '' .And. D1_FORMUL = 'S'"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()  

//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES))
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) SFT->(MsSeek(xFilial("SFT")+"E"+SD1->D1_SERIE+SD1->D1_DOC+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_ITEM))
(PREREG) SF1->(MsSeek(xFilial("SF1")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
(PREREG) Iif(SD1->D1_TIPO$"DB",SA1->(MsSeek(xFilial("SA1")+SF1->F1_FORNECE+SF1->F1_LOJA)),SA2->(MsSeek(xFilial("SA2")+SF1->F1_FORNECE+SF1->F1_LOJA)))
(PREREG) (Iif(ASCAN(_aTotal[85],SD1->D1_TES)==0,AADD(_aTotal[85],SD1->D1_TES),.T.),.T.) 
(PREREG) _aTotal[88]:= Iif(_aTotal[86],0,Iif(_aTotal[87]==SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA,_aTotal[88]+1,1))
(PREREG) _aTotal[87]:= SD1->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)
(PREREG) (_aTotal[55] := Val(_aTotal[012][2][1]) > 0 .Or. Val(_aTotal[012][2][2]) > 0 .Or. Val(_aTotal[012][2][3]) > 0,.T.)
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
//--Montagem do arquivo
SerSub_Doc C 005 0 SerieNfId("SD1",2,"D1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SD1->D1_DOC)))+Alltrim(SD1->D1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SD1->D1_EMISSAO)
Participa  C 014 0 _aTotal[30]
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))
Cod_SitPis C 002 0 Iif(!Empty(SFT->FT_CSTPIS),SFT->FT_CSTPIS,Space(2)) 
Aliq_Pis   N 008 4 Iif(SFT->FT_VALPIS>0,SFT->FT_ALIQPIS,0)
Base_Pis   N 017 3 SFT->FT_BASEPIS
Vlr_E_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][1])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",SFT->FT_VALPIS,0))
Vlr_I_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][2])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",0,SFT->FT_VALPIS))
Vlr_N_Pis  N 017 2 Iif(_aTotal[55], (SFT->FT_VALPIS * Val(_aTotal[012][2][3])/100 ),0)
Vlr_T_Pis  N 017 2 SFT->FT_VALPIS
Cod_SitCof C 002 0 Iif(!Empty(SFT->FT_CSTCOF),SFT->FT_CSTCOF,Space(2)) 
Aliq_Cof   N 008 4 Iif(SFT->FT_VALCOF>0,SFT->FT_ALIQCOF,0)
Base_Cof   N 017 3 SFT->FT_BASECOF
Vlr_E_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][1])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",SFT->FT_VALCOF,0))
Vlr_I_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][2])/100 ),Iif(SUBS(SFT->FT_CFOP,1,1)$"7",0,SFT->FT_VALCOF))
Vlr_N_Cof  N 017 2 Iif(_aTotal[55], (SFT->FT_VALCOF * Val(_aTotal[012][2][3])/100 ),0)
Vlr_T_Cof  N 017 2 SFT->FT_VALCOF
Dt_Aprop   C 008 0 DataInt(SD1->D1_DTDIGIT)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                               ³
//³REGISTRO COMPLEMENTO DE ENTRADA DE DOCUMENTOS FISCAIS EMITIDOS POR ECF (4.10.7)³
//³                                                                               ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SD1 4.10.7 Arquivo complementar de registro de entrada de documentos fiscais emitidos por ECF]
(ARQ) 4107PISCOFENTECF.TXT

(PRE) SB1->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))
(PRE) SF4->(dbSetOrder(1))
(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SFT->(dbSetOrder(1))

(PRE) _aTotal[87] := "" 
(PRE) _aTotal[90] := {"SD1",""}
(PRE) _aTotal[98] := IndexKey()
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "D1_FILIAL = '"+ xFilial("SD1") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "D1_DTDIGIT", "D1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "D1_FILIAL == '" + xFilial("SD1") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(D1_DTDIGIT)", "DTOS(D1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "'"

(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) DbGoTop()  
//--Pre-Processamento do Registro de Arquivo
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD1->D1_TES)) .And. SF4->F4_PISCOF <> "4"
(PREREG) SB1->(MsSeek(xFilial("SB1")+SD1->D1_COD))
(PREREG) SFT->(MsSeek(xFilial("SFT")+"E"+SD1->D1_SERIE+SD1->D1_DOC+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_ITEM)) .And. Alltrim(SFT->FT_ESPECIE) == "CF"
(PREREG) SF1->(MsSeek(xFilial("SF1")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA))
(PREREG) SA2->(MsSeek(xFilial("SA2")+SF1->F1_FORNECE+SF1->F1_LOJA))
(PREREG) (Iif(ASCAN(_aTotal[85],SD1->D1_TES)==0,AADD(_aTotal[85],SD1->D1_TES),.T.),.T.) 
(PREREG) _aTotal[88] := Iif(_aTotal[86],0,Iif(_aTotal[87]==SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA,_aTotal[88]+1,1))
(PREREG) _aTotal[87] := SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
(PREREG) AModNot(SF1->F1_ESPECIE) <> SPACE(2) .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS" 

//--Montagem do arquivo
Dt_Emi_Doc C 008 0 DataInt(SD1->D1_EMISSAO)
Participa  C 014 0 _aTotal[30]
Modelo_Doc C 002 0 iif(AModNot(SF1->F1_ESPECIE)="01" .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS","03",AModNot(SF1->F1_ESPECIE))	
Numero_Ite C 003 0 Replicate("0",3-len(AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))))+ AllTrim(Iif(_aTotal[86],Right(SD1->D1_ITEM,3),Str(_aTotal[88])))
Cod_SitPis C 002 0 Iif(!Empty(SFT->FT_CSTPIS),SFT->FT_CSTPIS,Space(2)) 
Aliq_Pis   N 008 4 Iif(SFT->FT_VALPIS>0,SFT->FT_ALIQPIS,0)
Base_Pis   N 017 3 SFT->FT_BASEPIS         
Vlr_Pis    N 017 2 SFT->FT_VALPIS
Cod_SitCof C 002 0 Iif(!Empty(SFT->FT_CSTCOF),SFT->FT_CSTCOF,Space(2)) 
Aliq_Cof   N 008 4 Iif(SFT->FT_VALCOF>0,SFT->FT_ALIQCOF,0)
Base_Cof   N 017 3 SFT->FT_BASECOF
Vlr_Cof    N 017 2 SFT->FT_VALCOF
Dt_Aprop   C 008 0 DataInt(SD1->D1_DTDIGIT)
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                           ³
//³REGISTRO COMPLEMENTO DE SAIDA MERCADORIAS/SERVICOS (4.11.1)³
//³                                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF2 4.11.1 Arquivo complementar de registro de saida de Mercadorias/Servicos]
(ARQ) 4111COMPSAIDA.TXT

(PRE) SF2->(dbSetOrder(1))
(PRE) SE1->(dbSetOrder(1))
(PRE) SED->(dbSetOrder(1))

(PRE) _aTotal[94] := PadR(AllTrim(SuperGetMv("MV_1DUP")), Len(SE1->E1_PARCELA))
(PRE) _aTotal[90] := {"SF2",""}
(PRE) _aTotal[91] := "F2_FILIAL, F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[92] := "F2_FILIAL = '" + xFilial("SF2") + "' AND F2_EMISSAO BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[93] := "F2_FILIAL == '" + xFilial("SF2") + "' .And. DTOS(F2_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. DTOS(F2_EMISSAO) <= '" + DTOS(MV_PAR02) + "'"

(PRE) FsQuery(_aTotal[90], 1, _aTotal[92], _aTotal[93], _aTotal[91])
(PRE) SF2->(DbGoTop())  
//--Pre-Processamento do Registro de Arquivo
(PREREG) FsValidNF( 2, SF2->F2_DOC, SF2->F2_SERIE, SF2->F2_CLIENTE, SF2->F2_LOJA, {"SF4", 1, "xFilial('SF4')+SD2->D2_TES", {|| SF4->F4_ISS <> "S"}})
(PREREG) SE1->(MsSeek(xFilial("SE1")+SF2->(F2_SERIE+F2_DOC+Space(Len(SE1->E1_PARCELA))+MVNOTAFIS))) .Or. SE1->(MsSeek(xFilial("SE1")+SF2->(F2_SERIE+F2_DOC+_aTotal[94]+MVNOTAFIS)))
(PREREG) SED->(MsSeek(xFilial("SED")+SE1->E1_NATUREZ))
(PREREG) (_aTotal[51]:= SED->ED_PERCPIS,.T.)
(PREREG) (_aTotal[52]:= SED->ED_PERCCOF,.T.)
(PREREG) (_aTotal[53]:= SED->ED_PERCIRF,.T.)
(PREREG) (_aTotal[54]:= SED->ED_PERCCSL,.T.)
(PREREG) (_aTotal[41]:= 0,.T.)
(PREREG) (_aTotal[42]:= 0,.T.)
(PREREG) (_aTotal[43]:= 0,.T.)
(PREREG) (_aTotal[44]:= 0,.T.)
(PREREG) (_aTotal[45]:= 0,.T.)
(PREREG) (_aTotal[46]:= 0,.T.)
(PREREG) (_aTotal[47]:= 0,.T.)
(PREREG) (_aTotal[48]:= 0,.T.)
(PREREG) _aTotal[40]:= {|| _aTotal[41] += SE1->E1_BASEPIS, _aTotal[42] += SE1->E1_PIS, _aTotal[43] += SE1->E1_BASECOF, _aTotal[44] += SE1->E1_COFINS, _aTotal[45] += SE1->E1_VALOR, _aTotal[46] += SE1->E1_IRRF, _aTotal[47] += SE1->E1_BASECSL, _aTotal[48] += SE1->E1_CSLL }
(PREREG) (SE1->(DbEval( _aTotal[40] ,, {|| !SE1->(Eof()) .And. SE1->(xFilial("SE1")+E1_CLIENTE+E1_LOJA+E1_PREFIXO+E1_NUM) == xFilial("SE1")+SF2->(F2_CLIENTE+F2_LOJA+F2_SERIE+F2_DOC) .And. SE1->E1_TIPO = MVNOTAFIS }) ), .T.)
(PREREG) AModNot(SF2->F2_ESPECIE) <> SPACE(2) .Or. Alltrim(SF2->F2_ESPECIE) == "NFS" .Or. Alltrim(SF2->F2_ESPECIE) == "NFPS" 

//--Montagem do arquivo
Modelo_Doc C 002 0 iif(Alltrim(SF2->F2_ESPECIE) == "NFS" .Or. Alltrim(SF2->F2_ESPECIE) == "NFPS","03",AModNot(SF2->F2_ESPECIE))	
SerSub_Doc C 005 0 SerieNfId("SF2",2,"F2_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF2->F2_DOC)))+Alltrim(SF2->F2_DOC)
Dt_Emi_Doc C 008 0 DataInt(SF2->F2_EMISSAO)
Aliq_Pis   N 005 2 _aTotal[51]
Base_Pis   N 017 2 _aTotal[41]
Vlr_Pis    N 017 2 _aTotal[42]
Aliq_Cof   N 005 2 _aTotal[52]
Base_Cof   N 017 2 _aTotal[43]
Vlr_Cof    N 017 2 _aTotal[44]
Aliq_Irrf  N 005 2 _aTotal[53]
Base_Irrf  N 017 2 _aTotal[45]
Vlr_Irrf   N 017 2 _aTotal[46]
Aliq_Csll  N 005 2 _aTotal[54]
Base_Csll  N 017 2 _aTotal[47]
Vlr_Csll   N 017 2 _aTotal[48]
Base_Ret   N 017 2 0
Vlr_RetPr  N 017 2 0
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                      ³
//³REGISTRO COMPLEMENTO DE SAIDA DE SERVICOS NAO SUJEITA AO ICMS (4.11.2)³
//³                                                                      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF2 4.11.2 Arquivo complementar de registro de saida de Servicos nao sujeito ao ICMS]
(ARQ) 4112COMPSAIDASER.TXT

(PRE) SF2->(dbSetOrder(1))
(PRE) SD2->(dbSetOrder(1))
(PRE) SE1->(dbSetOrder(1))
(PRE) SED->(dbSetOrder(1))

(PRE) _aTotal[94] := PadR(AllTrim(SuperGetMv("MV_1DUP")), Len(SE1->E1_PARCELA))
(PRE) _aTotal[90] := {"SF2",""}
(PRE) _aTotal[91] := "F2_FILIAL, F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[92] := "F2_FILIAL = '" + xFilial("SF2") + "' AND F2_EMISSAO BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[93] := "F2_FILIAL == '" + xFilial("SF2") + "' .And. DTOS(F2_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. DTOS(F2_EMISSAO) <= '" + DTOS(MV_PAR02) + "'"

(PRE) FsQuery(_aTotal[90], 1, _aTotal[92], _aTotal[93], _aTotal[91])
(PRE) SF2->(DbGoTop())  
//--Pre-Processamento do Registro de Arquivo
(PREREG) FsValidNF( 2, SF2->F2_DOC, SF2->F2_SERIE, SF2->F2_CLIENTE, SF2->F2_LOJA, {"",,, {|| SD2->D2_CODISS <> ''}})
(PREREG) FsValidNF( 2, SF2->F2_DOC, SF2->F2_SERIE, SF2->F2_CLIENTE, SF2->F2_LOJA, {"SF4", 1, "xFilial('SF4')+SD2->D2_TES", {|| SF4->F4_PISCOF <> '4' .And. SF4->F4_ISS = 'S'}})
(PREREG) SE1->(MsSeek(xFilial("SE1")+SF2->(F2_SERIE+F2_DOC+Space(Len(SE1->E1_PARCELA))+MVNOTAFIS))) .Or. SE1->(MsSeek(xFilial("SE1")+SF2->(F2_SERIE+F2_DOC+_aTotal[94]+MVNOTAFIS)))
(PREREG) SED->(MsSeek(xFilial("SED")+SE1->E1_NATUREZ))
(PREREG) (_aTotal[51]:= SED->ED_PERCPIS,.T.)
(PREREG) (_aTotal[52]:= SED->ED_PERCCOF,.T.)
(PREREG) (_aTotal[53]:= SED->ED_PERCCSL,.T.)
(PREREG) (_aTotal[41]:= 0,.T.)
(PREREG) (_aTotal[42]:= 0,.T.)
(PREREG) (_aTotal[43]:= 0,.T.)
(PREREG) (_aTotal[44]:= 0,.T.)
(PREREG) (_aTotal[45]:= 0,.T.)
(PREREG) (_aTotal[46]:= 0,.T.)
(PREREG) (_aTotal[47]:= 0,.T.)
(PREREG) (_aTotal[48]:= 0,.T.)
(PREREG) _aTotal[40]:= {|| _aTotal[41] += SE1->E1_BASEPIS, _aTotal[42] += SE1->E1_PIS, _aTotal[43] += SE1->E1_BASECOF, _aTotal[44] += SE1->E1_COFINS, _aTotal[45] += SE1->E1_BASECSL, _aTotal[46] += SE1->E1_CSLL }
(PREREG) (SE1->(DbEval( _aTotal[40] ,, {|| !SE1->(Eof()) .And. SE1->(xFilial("SE1")+E1_CLIENTE+E1_LOJA+E1_PREFIXO+E1_NUM) == xFilial("SE1")+SF2->(F2_CLIENTE+F2_LOJA+F2_SERIE+F2_DOC) .And. SE1->E1_TIPO = MVNOTAFIS }) ), .T.)
//--Montagem do arquivo
SerSub_Doc C 005 0 SerieNfId("SF2",2,"F2_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF2->F2_DOC)))+Alltrim(SF2->F2_DOC)
Dt_Emi_Doc C 008 0 DataInt(SF2->F2_EMISSAO)
Aliq_Pis   N 005 2 _aTotal[51]
Base_Pis   N 017 2 _aTotal[41]
Vlr_Pis    N 017 2 _aTotal[42]
Aliq_Cof   N 005 2 _aTotal[52]
Base_Cof   N 017 2 _aTotal[43]
Vlr_Cof    N 017 2 _aTotal[44]
Aliq_Csll  N 005 2 _aTotal[53]
Base_Csll  N 017 2 _aTotal[45]
Vlr_Csll   N 017 2 _aTotal[46]
Base_Ret   N 017 2 0
Vlr_RetPr  N 017 2 0
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                                                ³
//³REGISTRO COMPLEMENTO DE REGISTRO DE ENTRADA MERCADORIA/SERVICO EMITIDAS PELA PROPRIA PJ (4.11.3)³
//³                                                                                                ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF1 4.11.3 Arquivo complementar de registro de entrada de Mercadoria/Servicos emitidas pela propria PJ]
(ARQ) 4113COMPENT.TXT
             
(PRE) SE2->(dbSetOrder(1))
(PRE) SF1->(dbSetOrder(1))

(PRE) _aTotal[94] := PadR(AllTrim(SuperGetMv("MV_1DUP")), Len(SE2->E2_PARCELA))
(PRE) _aTotal[90] := {"SF1",""}
(PRE) _aTotal[98] := SF1->(IndexKey())
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "F1_FILIAL = '" + xFilial("SF1") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "F1_DTDIGIT", "F1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "F1_FORMUL = 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "F1_FILIAL == '" + xFilial("SF1") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F1_DTDIGIT)", "DTOS(F1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F1_DTDIGIT)", "DTOS(F1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "F1_FORMUL == 'S'"

(PRE) FsQuery(_aTotal[90], 1, _aTotal[91], _aTotal[99], _aTotal[98])
(PRE) SF1->(DbGoTop())  
//--Pre-Processamento do Registro de Arquivo
(PREREG) SE2->(MsSeek(xFilial("SE2")+SF1->(F1_SERIE+F1_DOC+Space(Len(SE2->E2_PARCELA))+MVNOTAFIS))) .Or. SE2->(MsSeek(xFilial("SE2")+SF1->(F1_SERIE+F1_DOC+_aTotal[94]+MVNOTAFIS)))
(PREREG) SED->(MsSeek(xFilial("SED")+SE2->E2_NATUREZ))
(PREREG) (_aTotal[51]:= SED->ED_PERCPIS,.T.)
(PREREG) (_aTotal[52]:= SED->ED_PERCCOF,.T.)
(PREREG) (_aTotal[53]:= SED->ED_PERCIRF,.T.)
(PREREG) (_aTotal[54]:= SED->ED_PERCCSL,.T.)
(PREREG) (_aTotal[41]:= 0,.T.)
(PREREG) (_aTotal[42]:= 0,.T.)
(PREREG) (_aTotal[43]:= 0,.T.)
(PREREG) (_aTotal[44]:= 0,.T.)
(PREREG) (_aTotal[45]:= 0,.T.)
(PREREG) (_aTotal[46]:= 0,.T.)
(PREREG) (_aTotal[47]:= 0,.T.)
(PREREG) (_aTotal[48]:= 0,.T.)
(PREREG) _aTotal[40]:= {|| _aTotal[41] += SE2->E2_BASEPIS, _aTotal[42] += SE2->E2_PIS, _aTotal[43] += SE2->E2_BASECOF, _aTotal[44] += SE2->E2_COFINS, _aTotal[45] += SE2->E2_VALOR, _aTotal[46] += SE2->E2_IRRF, _aTotal[47] += SE2->E2_BASECSL, _aTotal[48] += SE2->E2_CSLL }
(PREREG) (SE2->(DbEval( _aTotal[40] ,, {|| !SE2->(Eof()) .And. SE2->(xFilial("SE2")+E2_FORNECE+E2_LOJA+E2_PREFIXO+E2_NUM) == xFilial("SE2")+SF1->(F1_FORNECE+F1_LOJA+F1_SERIE+F1_DOC) .And. SE2->E2_TIPO = MVNOTAFIS }) ), .T.)
(PREREG) AModNot(SF1->F1_ESPECIE) <> SPACE(2) .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS" 

//--Montagem do arquivo
Modelo_Doc C 002 0 iif(AModNot(SF1->F1_ESPECIE)="01" .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS","03",AModNot(SF1->F1_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SF1",2,"F1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF1->F1_DOC)))+Alltrim(SF1->F1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SF1->F1_EMISSAO)
Aliq_Pis   N 005 2 _aTotal[51]
Base_Pis   N 017 2 _aTotal[41]
Vlr_Pis    N 017 2 _aTotal[42]
Aliq_Cof   N 005 2 _aTotal[52]
Base_Cof   N 017 2 _aTotal[43]
Vlr_Cof    N 017 2 _aTotal[44]
Aliq_Irrf  N 005 2 _aTotal[53]
Base_Irrf  N 017 2 _aTotal[45]
Vlr_Irrf   N 017 2 _aTotal[46]
Aliq_Csll  N 005 2 _aTotal[54]
Base_Csll  N 017 2 _aTotal[47]
Vlr_Csll   N 017 2 _aTotal[48]
Base_Ret   N 017 2 0
Vlr_RetPr  N 017 2 0
Aliq_rura  N 005 2 0
Base_rura  N 017 2 0
Vlr_rura   N 017 2 0
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                                    ³
//³REGISTRO COMPLEMENTO DE ENTRADA DE MERCADORIA/SERVICOS EMITIDAS P/ TERCEIRO (4.11.4)³
//³                                                                                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF1 4.11.4 Arquivo complementar de registro de entrada de Mercadoria/Servicos emitidas por terceiros]
(ARQ) 4114COMPENT.TXT

(PRE) SA1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SE2->(dbSetOrder(1))
(PRE) SED->(dbSetOrder(1))
           
(PRE) _aTotal[94] := PadR(AllTrim(SuperGetMv("MV_1DUP")), Len(SE2->E2_PARCELA))
(PRE) _aTotal[90] := {"SF1",""}
(PRE) _aTotal[98] := SF1->(IndexKey())
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[91] := "F1_FILIAL = '" + xFilial("SF1") + "' AND "
(PRE) _aTotal[91] += If(_aTotal[97], "F1_DTDIGIT", "F1_EMISSAO") + " BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' AND "
(PRE) _aTotal[91] += "F1_FORMUL <> 'S'"
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[99] := "F1_FILIAL == '" + xFilial("SF1") + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F1_DTDIGIT)", "DTOS(F1_EMISSAO)") + " >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[99] += If(_aTotal[97], "DTOS(F1_DTDIGIT)", "DTOS(F1_EMISSAO)") + " <= '" + DTOS(MV_PAR02) + "' .And. "
(PRE) _aTotal[99] += "F1_FORMUL <> 'S'"
    
(PRE) FsQuery(_aTotal[90],1,_aTotal[91],,_aTotal[98])
(PRE) SF1->(DbGoTop())  

//--Pre-Processamento do Registro de Arquivo
(PREREG) SE2->(MsSeek(xFilial("SE2")+SF1->(F1_SERIE+F1_DOC+Space(Len(SE2->E2_PARCELA))+MVNOTAFIS))) .Or. SE2->(MsSeek(xFilial("SE2")+SF1->(F1_SERIE+F1_DOC+_aTotal[94]+MVNOTAFIS)))
(PREREG) SED->(MsSeek(xFilial("SED")+SE2->E2_NATUREZ))

(PREREG) If(SF1->F1_TIPO$"DB",SA1->(MsSeek(xFilial("SA1")+SF1->F1_FORNECE+SF1->F1_LOJA)),SA2->(MsSeek(xFilial("SA2")+SF1->F1_FORNECE+SF1->F1_LOJA)))
(PREREG) SF3->(DbSeek(xFilial("SF3")+SF1->(DTOS(F1_DTDIGIT)+F1_DOC+F1_SERIE+F1_FORNECE+F1_LOJA))) 

(PREREG) (_aTotal[51]:= SED->ED_PERCPIS,.T.)
(PREREG) (_aTotal[52]:= SED->ED_PERCCOF,.T.)
(PREREG) (_aTotal[53]:= SED->ED_PERCIRF,.T.)
(PREREG) (_aTotal[54]:= SED->ED_PERCCSL,.T.)
(PREREG) (_aTotal[41]:= 0,.T.)
(PREREG) (_aTotal[42]:= 0,.T.)
(PREREG) (_aTotal[43]:= 0,.T.)
(PREREG) (_aTotal[44]:= 0,.T.)
(PREREG) (_aTotal[45]:= 0,.T.)
(PREREG) (_aTotal[46]:= 0,.T.)
(PREREG) (_aTotal[47]:= 0,.T.)
(PREREG) (_aTotal[48]:= 0,.T.)
(PREREG) _aTotal[40]:= {|| _aTotal[41] += SE2->E2_BASEPIS, _aTotal[42] += SE2->E2_PIS, _aTotal[43] += SE2->E2_BASECOF, _aTotal[44] += SE2->E2_COFINS, _aTotal[45] += SE2->E2_VALOR, _aTotal[46] += SE2->E2_IRRF, _aTotal[47] += SE2->E2_BASECSL, _aTotal[48] += SE2->E2_CSLL }

(PREREG) (SE2->(DbEval( _aTotal[40] ,, {|| !SF3->(Eof()) .And. !SE2->(Eof()) .And. SE2->(xFilial("SE2")+E2_FORNECE+E2_LOJA+E2_PREFIXO+E2_NUM) == xFilial("SE2")+SF1->(F1_FORNECE+F1_LOJA+F1_SERIE+F1_DOC) .And. SE2->E2_TIPO = MVNOTAFIS }) ), .T.)
(PREREG) AModNot(SF1->F1_ESPECIE) <> SPACE(2) .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS" 

(PREREG) _aTotal[30] := If(SF1->F1_TIPO$"DB",Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC))),Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC))))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)

//--Montagem do arquivo
Modelo_Doc C 002 0 iif(AModNot(SF1->F1_ESPECIE)="01" .Or. Alltrim(SF1->F1_ESPECIE) == "NFS" .Or. Alltrim(SF1->F1_ESPECIE) == "NFPS","03",AModNot(SF1->F1_ESPECIE))
SerSub_Doc C 005 0 SerieNfId("SF1",2,"F1_SERIE")
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF1->F1_DOC)))+Alltrim(SF1->F1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SF1->F1_EMISSAO)
Participa  C 014 0 _aTotal[30]
Aliq_Pis   N 005 2 _aTotal[51]
Base_Pis   N 017 2 _aTotal[41]
Vlr_Pis    N 017 2 _aTotal[42]
Aliq_Cof   N 005 2 _aTotal[52]
Base_Cof   N 017 2 _aTotal[43]
Vlr_Cof    N 017 2 _aTotal[44]
Aliq_Irrf  N 005 2 _aTotal[53]
Base_Irrf  N 017 2 _aTotal[45]
Vlr_Irrf   N 017 2 _aTotal[46]
Aliq_Csll  N 005 2 _aTotal[54]
Base_Csll  N 017 2 _aTotal[47]
Vlr_Csll   N 017 2 _aTotal[48]
Base_Ret   N 017 2 0
Vlr_RetPr  N 017 2 0
(POS) FsQuery(_aTotal[90], 2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³                                                                        ³
//³REGISTRO COMPLEMENTO DE ENTRADA DE SERVICOS NAO SUJEITO AO ICMS (4.11.5)³
//³                                                                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[SF1 4.11.5 Arquivo complementar de registro de entrada de Servicos nao sujeito ao ICMS]
(ARQ) 4115COMPENT.TXT

(PRE) SF1->(dbSetOrder(1))
(PRE) SA2->(dbSetOrder(1))
(PRE) SD1->(dbSetOrder(1))
(PRE) SE2->(dbSetOrder(1))

(PRE) _aTotal[94] := PadR(AllTrim(SuperGetMv("MV_1DUP")), Len(SE2->E2_PARCELA))
(PRE) _aTotal[90] := {"SF1",""}
(PRE) _aTotal[91] := "F1_FILIAL,F1_DOC,F1_SERIE,F1_FORNECE,F1_LOJA"
//--Clausula "WHERE" para selecao dos registros:
(PRE) _aTotal[92] := "F1_FILIAL = '" + xFilial("SD1") + "' AND " 
(PRE) _aTotal[92] += IIF(_aTotal[97],"F1_DTDIGIT " ,"F1_EMISSAO ") + "BETWEEN '" + DTOS(MV_PAR01) + "' AND '" + DTOS(MV_PAR02) + "' "
//--Instrucao de filtro p/ IndRegua():
(PRE) _aTotal[93] := "F1_FILIAL == '" + xFilial("SF1") + "' .And. "
(PRE) _aTotal[93] += "DTOS(F1_EMISSAO) >= '" + DTOS(MV_PAR01) + "' .And. "
(PRE) _aTotal[93] += "DTOS(F1_EMISSAO) <= '" + DTOS(MV_PAR02) + "'"
//--Seleciona
(PRE) FsQuery( _aTotal[90], 1, _aTotal[92], _aTotal[93], _aTotal[91] )
(PRE) SF1->(DbGoTop())

//--Pre-Processamento do Registro de Arquivo
(PREREG) FsValidNF(1,SF1->F1_DOC,SF1->F1_SERIE,SF1->F1_FORNECE,SF1->F1_LOJA,{,,,{|| !Empty(SD1->D1_CODISS) .And. SD1->D1_FORMUL<>'S'}})
(PREREG) FsValidNF(1,SF1->F1_DOC,SF1->F1_SERIE,SF1->F1_FORNECE,SF1->F1_LOJA,{"SF4", 1, "xFilial('SF4')+SD1->D1_TES", {|| SF4->F4_PISCOF<>'4'}})

(PREREG) SA2->(MsSeek(xFilial("SA2")+SF1->(F1_FORNECE+F1_LOJA)))
(PREREG) SE2->(MsSeek(xFilial("SE2")+SF1->(F1_SERIE+F1_DOC+Space(Len(SE2->E2_PARCELA))+MVNOTAFIS))) .Or. SE2->(MsSeek(xFilial("SE2")+SF1->(F1_SERIE+F1_DOC+_aTotal[94]+MVNOTAFIS)))
(PREREG) SED->(MsSeek(xFilial("SED")+SE2->E2_NATUREZ))
        
(PREREG) (_aTotal[51]:= SED->ED_PERCPIS,.T.)
(PREREG) (_aTotal[52]:= SED->ED_PERCCOF,.T.)
(PREREG) (_aTotal[53]:= SED->ED_PERCIRF,.T.)
(PREREG) (_aTotal[54]:= SED->ED_PERCCSL,.T.)

(PREREG) (_aTotal[41]:= 0,.T.)
(PREREG) (_aTotal[42]:= 0,.T.)
(PREREG) (_aTotal[43]:= 0,.T.)
(PREREG) (_aTotal[44]:= 0,.T.)
(PREREG) (_aTotal[45]:= 0,.T.)
(PREREG) (_aTotal[46]:= 0,.T.)
(PREREG) (_aTotal[47]:= 0,.T.)
(PREREG) (_aTotal[48]:= 0,.T.)

(PREREG) _aTotal[40]:= {|| _aTotal[41] += SE2->E2_BASEPIS, _aTotal[42] += SE2->E2_PIS, _aTotal[43] += SE2->E2_BASECOF, _aTotal[44] += SE2->E2_COFINS, _aTotal[45] += SE2->E2_VALOR, _aTotal[46] += SE2->E2_IRRF, _aTotal[47] += SE2->E2_BASECSL, _aTotal[48] += SE2->E2_CSLL }
(PREREG) (SE2->(DbEval( _aTotal[40] ,, {|| !SE2->(Eof()) .And. SE2->(xFilial("SE2")+E2_FORNECE+E2_LOJA+E2_PREFIXO+E2_NUM) == xFilial("SE2")+SF1->(F1_FORNECE+F1_LOJA+F1_SERIE+F1_DOC) .And. SE2->E2_TIPO = MVNOTAFIS }) ), .T.)
(PREREG) _aTotal[30] := Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) If(AScan(_aTotal[31],_aTotal[30])==0,(AAdd(_aTotal[31],_aTotal[30]),.T.),.T.)
//--Montagem do arquivo
SerSub_Doc C 005 0 SerieNfId("SF1",2,"F1_SERIE")               		
Numero_Doc C 009 0 Replicate("0",9-Len(Alltrim(SF1->F1_DOC)))+Alltrim(SF1->F1_DOC)
Dt_Emi_Doc C 008 0 DataInt(SF1->F1_EMISSAO)
Participa  C 014 0 _aTotal[30]
Aliq_Pis   N 005 2 _aTotal[51]
Base_Pis   N 017 2 _aTotal[41]
Vlr_Pis    N 017 2 _aTotal[42]
Aliq_Cof   N 005 2 _aTotal[52]
Base_Cof   N 017 2 _aTotal[43]
Vlr_Cof    N 017 2 _aTotal[44]
Aliq_Csll  N 005 2 _aTotal[54]
Base_Csll  N 017 2 _aTotal[47]
Vlr_Csll   N 017 2 _aTotal[48]
Base_Ret   N 017 2 0
Vlr_RetPr  N 017 2 0
(POS) FsQuery(_aTotal[90], 2)

[SA4 Cadastro de transportadora     ]
(PRE) _aTotal[38] := SA4->(FieldPos ("A4_USERLGI"))>0 .And. SA4->(FieldPos ("A4_USERLGA"))>0
(PREREG) ( Iif( _aTotal[38] , SA4->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39]		:= Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39]		:= Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39]		:= Iif( Empty( _aTotal[39] ), MV_PAR01 , _aTotal[39])
(PREREG) ( _aTotal[50]	:= Upper(Posicione("SYA",1,xFilial("SYA")+SA4->A4_CODPAIS,"YA_DESCR")), .T. )
(PREREG) _aTotal[30]		:= Iif(_aTotal[06],"SA4"+StrZero(SA4->(Recno()),11),Iif(_aTotal[05].Or.SA4->A4_EST=="EX","SA4"+AllTrim(xFilial("SA4"))+RIGHT(SA4->A4_COD,9),space(14-len(alltrim(SA4->A4_CGC)))+alltrim(SA4->A4_CGC)))
(PREREG) AScan(_aTotal[31], _aTotal[30]) > 0
Data       C 008 0 _aTotal[66]
Participa  C 014 0 _aTotal[30]
Cnpj/Cpf   C 014 0 space(14-len(alltrim(SA4->A4_CGC)))+alltrim(SA4->A4_CGC)
Inscricao  C 014 0 StrTran(StrTran(SA4->A4_INSEST,".",""),"-","")
Municipal  C 014 0 SA4->(Iif(FieldPos("A4_INSCRM")>0,A4_INSCRM,""))
Nome/Razao C 070 0 SA4->A4_NOME
Endereco   C 060 0 SA4->A4_END
Bairro     C 020 0 SA4->A4_BAIRRO
Municipio  C 020 0 SA4->A4_MUN
Estado     C 002 0 Iif( SA4->A4_EST=="EX" , "  ", SA4->A4_EST )
Pais       C 020 0 IIf(!Empty(SA4->A4_CODPAIS) .And. !("BRASIL"$_aTotal[50]),Posicione("SYA",1,xFilial("SYA")+SA4->A4_CODPAIS,"YA_DESCR"),"")
Cep        C 008 0 SA4->A4_CEP
(POS) SA1->(MsSeek(xFilial("SA1")))
             
[SA1 Cadastro de Clientes         ]
(PRE) _aTotal[38] := SA1->(FieldPos ("A1_USERLGI"))>0 .And. SA1->(FieldPos ("A1_USERLGA"))>0
(PREREG) ( Iif( _aTotal[38] , SA1->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39]		:= Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39]		:= Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39]		:= Iif( Empty( _aTotal[39] ), IIf(!Empty(SA1->A1_ULTCOM),SA1->A1_ULTCOM,MV_PAR01) , _aTotal[39])
(PREREG) ( _aTotal[50]	:= Upper(Posicione("SYA",1,xFilial("SYA")+SA1->A1_PAIS,"YA_DESCR")), .T. )
(PREREG) _aTotal[30]		:= Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC)))
(PREREG) AScan(_aTotal[31], _aTotal[30]) > 0
Data       C 008 0 _aTotal[66]
Participa  C 014 0 Iif(_aTotal[06],"SA1"+StrZero(SA1->(Recno()),11),Iif(_aTotal[05].Or.SA1->A1_EST=="EX","SA1"+AllTrim(xFilial("SA1"))+RIGHT(SA1->A1_COD,9),space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC)))
Cnpj/Cpf   C 014 0 space(14-len(alltrim(SA1->A1_CGC)))+alltrim(SA1->A1_CGC)
Inscricao  C 014 0 StrTran(StrTran(SA1->A1_INSCR,".",""),"-","")
Municipal  C 014 0 SA1->A1_INSCRM
Nome/Razao C 070 0 SA1->A1_NOME
Endereco   C 060 0 SA1->A1_END
Bairro     C 020 0 SA1->A1_BAIRRO
Municipio  C 020 0 SA1->A1_MUN
Estado     C 002 0 Iif( SA1->A1_EST=="EX" , "  ", SA1->A1_EST )
Pais       C 020 0 IIf(!Empty(SA1->A1_PAIS) .And. !("BRASIL"$_aTotal[50]),Posicione("SYA",1,xFilial("SYA")+SA1->A1_PAIS,"YA_DESCR"),"")
Cep        C 008 0 SA1->A1_CEP
(POS) SA2->(MsSeek(xFilial("SA2")))

[SA2 Arquivo de Fornecedores      ]
(ARQ) 491CLIFOR.TXT
(PRE) _aTotal[38] := SA2->(FieldPos ("A2_USERLGI"))>0 .And. SA2->(FieldPos ("A2_USERLGA"))>0
(PREREG) ( Iif( _aTotal[38] , SA2->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39]		:= Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39]		:= Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39]		:= Iif( Empty( _aTotal[39] ), IIf(!Empty(SA2->A2_ULTCOM),SA2->A2_ULTCOM,MV_PAR01) , _aTotal[39])
(PREREG) ( _aTotal[50]	:= Upper(Posicione("SYA",1,xFilial("SYA")+SA2->A2_PAIS,"YA_DESCR")), .T. )
(PREREG) _aTotal[30]		:= Iif(_aTotal[06],"SA2"+StrZero(SA2->(Recno()),11),Iif(_aTotal[05].Or.SA2->A2_EST=="EX","SA2"+AllTrim(xFilial("SA2"))+RIGHT(SA2->A2_COD,9),space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)))
(PREREG) AScan(_aTotal[31], _aTotal[30]) > 0 .and. (!empty(alltrim(SA2->A2_CGC)) .or. SA2->A2_EST=="EX")
DtaAtuli   C 008 0 _aTotal[66]
Participa  C 014 0 _aTotal[30]
Cgc/Cpf    C 014 0 space(14-len(alltrim(SA2->A2_CGC)))+alltrim(SA2->A2_CGC)
InscrEst   C 014 0 StrTran(StrTran(SA2->A2_INSCR,".",""),"-","")
InscrMun   C 014 0 SA2->A2_INSCRM
NomRazSoc  C 070 0 SA2->A2_NOME
NomLogra   C 060 0 SA2->A2_END
Bairro     C 020 0 SA2->A2_BAIRRO
Municipio  C 020 0 SA2->A2_MUN
Estado     C 002 0 Iif( SA2->A2_EST=="EX" , "  ", SA2->A2_EST ) 
Pais       C 020 0 IIf(!Empty(SA2->A2_PAIS) .And. !("BRASIL"$_aTotal[50]),Posicione("SYA",1,xFilial("SYA")+SA2->A2_PAIS,"YA_DESCR"),"")
Cep        C 008 0 SA2->A2_CEP

[SF4 Tabela CFOP                  ]
(ARQ) 494CFOP.TXT
(PRE) dbGoTop()
(PREREG) SF4->F4_FILIAL == xFilial("SF4").AND.(ASCAN(_aTotal[85],SF4->F4_CODIGO)>0)
Dt_Atualiz C 008 0 _aTotal[66]
Cod_Nat_Op C 006 0 SF4->F4_CODIGO
Descricao  C 045 0 SF4->F4_TEXTO

[SB1 Tabela Mercadorias/Servicos  ]
(ARQ) 495PRODUTO.TXT          
(PRE) SB1->(dbSetOrder(1)) 
(PRE) SB1->(MsSeek(xFilial("SB1")))
(PRE) _aTotal[38] := SB1->(FieldPos ("B1_USERLGI"))>0 .And. SB1->(FieldPos ("B1_USERLGA"))>0
(PREREG) SB1->B1_FILIAL == xFilial("SB1")
(PREREG) ( Iif( _aTotal[38] , SB1->(LeLog(@_aTotal[33], @_aTotal[34], @_aTotal[35], @_aTotal[36], @_aTotal[37], "3")),), .T. )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. !Empty( _aTotal[37] ), _aTotal[37] , "" )
(PREREG) _aTotal[39] := Iif( _aTotal[38] .And. Empty( _aTotal[39] ), _aTotal[36] , _aTotal[39])
(PREREG) _aTotal[39] := Iif( Empty( _aTotal[39] ), MV_PAR01 , _aTotal[39])
(PREREG) ASCAN(_aTotal[32], RIGHT(Trim(SB1->B1_COD),20)) > 0
Dt_Atualiz C 008 0 _aTotal[66]
Cod_MeInSe C 020 0 RIGHT(Trim(SB1->B1_COD),20)       
Descricao  C 045 0 SUBS(SB1->B1_DESC,1,45)

[XXX Dump/Relatorio Acompanhamento]                          
(PRE) _aTotal[02] := MsgYesNo("Deseja Gerar Arquivo DUMP/Acompanhamento ?","DUMP/Acompanhamento")
(PRE) _aTotal[60] := Iif(cDirNorma == Nil,MV_PAR05,cDirNorma)
(PRE) DumpIni86(_aTotal[2],MV_PAR04,_aTotal[60])