?{"Nome do Arquivo INI","GISRS03.INI"}
?{"Descicao Completa do Arquivo Magnetico","Guia Informativa Simplificada do estado do Rio Grande do Sul."}
?{"A Quem se Destina","Aos contribuintes enquadrados na categoria EPP, referente a cada um dos estabelecimentos."}
?{"Objetivo","Validar e transferir a Secretaria de Estado da Fazenda do Rio Grande do Sul os arquivos da Guia Informativa Simplificada."}
?{"Prazo de Entrega","Mensal - ate o dia 23 do mes subsequente ao da ocorrencia do fato gerador."}
?{"Aplicativo Disponibilizado pelo Fisco","GIS"}
?{"Versao do Aplicativo Contemplada pela Microsiga",""}
?{"Comentarios",""}

[XXX Inicializacao]     
(PRE) _aTotal[04] := {}
(PRE) _aTotal[05] := {}
(PRE) _aTotal[06] := "GISRS03"
(PRE) _aTotal[07] := .T.
(PRE) _aTotal[08] := {}
(PRE) _aTotal[09] := 0
(PRE) _aTotal[10] := 0
(PRE) _aTotal[11] := 0
(PRE) _aTotal[12] := 0  
(PRE) _aTotal[13] := 0
(PRE) _aTotal[14] := 0
(PRE) _aTotal[15] := 0
(PRE) _aTotal[16] := 0  
(PRE) _aTotal[17] := 0
(PRE) _aTotal[18] := 0
(PRE) _aTotal[19] := 0
(PRE) _aTotal[20] := 0  
(PRE) _aTotal[21] := 0
(PRE) _aTotal[22] := 0
(PRE) _aTotal[23] := 0
(PRE) _aTotal[24] := 0 
(PRE) _aTotal[33] := 0 
(PRE) _aTotal[37] := 0
(PRE) _aTotal[40] := 0
(PRE) _aTotal[41] := 0  
(PRE) _aTotal[42] := 0 
(PRE) _aTotal[43] := 0
(PRE) _aTotal[44] := 0  
(PRE) _aTotal[45] := GetNewPar("MV_UPFRS","")
(PRE) _aTotal[46] := 0
(PRE) _aTotal[47] := 0
(PRE) _aTotal[48] := 0
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³TELA PRINCIPAL³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ      
[XXX Montagem do CFP Utilizado pela rotina - PRINCIPAL]
(PRE) aAdd (_aTotal[04], "Processamento da GIS - Guia de Informativa Simplificada - RS")
(PRE) aAdd (_aTotal[04], "")
(PRE) aAdd (_aTotal[04], "Preencha corretamente as informações solicitadas.")
(PRE) aAdd (_aTotal[04], "Informações necessárias para a geração automática do meio-magnético de que trata a GIS - Guia de Informativa Simplificada.")
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³TELA SECUNDARIA³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]   
(PRE) aAdd (_aTotal[05], {})
(PRE) aAdd (_aTotal[05][1], "Processamento da GIS")
(PRE) aAdd (_aTotal[05][1], "Informações necessárias para a identificação e geração desta declaração.")
(PRE) aAdd (_aTotal[05][1], {})   
(PRE) aAdd (_aTotal[05][1][3], {1, "Registro Principal",,,,,,})   
(PRE) aAdd (_aTotal[05][1][3], {1, "",,,,,,})
(PRE) aAdd (_aTotal[05][1][3], {1, "Tipo da GIS",,,,,,})
(PRE) aAdd (_aTotal[05][1][3], {1, "Insc. Estadual do Centralizador",,,,,,})
(PRE) aAdd (_aTotal[05][1][3], {3,,,,,{"N-Normal","R-Retificadora"},,})
(PRE) aAdd (_aTotal[05][1][3], {2,,"9999999999",1,,,,10})
(PRE) aAdd (_aTotal[05][1][3], {1, "Nº de Estab. da Empresa",,,,,,})
(PRE) aAdd (_aTotal[05][1][3], {1, "",,,,,,})
(PRE) aAdd (_aTotal[05][1][3], {2,,"999",2,0,,,3})

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[05], {})
(PRE) aAdd (_aTotal[05][2], "Processamento da GIS")
(PRE) aAdd (_aTotal[05][2], "Informações necessárias para a identificação e geração desta declaração.")
(PRE) aAdd (_aTotal[05][2], {})
(PRE) aAdd (_aTotal[05][2][3], {1, "Informações e Resumo",,,,,,})   
(PRE) aAdd (_aTotal[05][2][3], {1, "",,,,,,})
(PRE) aAdd (_aTotal[05][2][3], {1, "Receita Bruta do Ano Anterior",,,,,,})
(PRE) aAdd (_aTotal[05][2][3], {1, "Receita Bruta Acumulada no Ano",,,,,,}) 
(PRE) aAdd (_aTotal[05][2][3], {2,,"@E 999999999999.99",2,2,,,15})
(PRE) aAdd (_aTotal[05][2][3], {2,,"@E 999999999999.99",2,2,,,15}) 
(PRE) aAdd (_aTotal[05][2][3], {1, "Déb Prop Venc FG não Pg",,,,,,})  
(PRE) aAdd (_aTotal[05][2][3], {1, "Nº de Ocorrencias do FG não Pg",,,,,,}) 
(PRE) aAdd (_aTotal[05][2][3], {2,,"@E 999999999999.99",2,2,,,15}) 
(PRE) aAdd (_aTotal[05][2][3], {2,,"99",2,0,,,2}) 
(PRE) aAdd (_aTotal[05][2][3], {1, "Pg Antecipado e Responsabilidade",,,,,,}) 
(PRE) aAdd (_aTotal[05][2][3], {1, "Pg na Ocorrencia do FG",,,,,,})
(PRE) aAdd (_aTotal[05][2][3], {2,,"@E 999999999999.99",2,2,,,15}) 
(PRE) aAdd (_aTotal[05][2][3], {2,,"@E 999999999999.99",2,2,,,15}) 

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[05], {})  
(PRE) aAdd (_aTotal[05][3], "Processamento da GIS")
(PRE) aAdd (_aTotal[05][3], "Informações necessárias para a identificação e geração desta declaração.")
(PRE) aAdd (_aTotal[05][3], {})
(PRE) aAdd (_aTotal[05][3][3], {1, "Despesas e Receitas",,,,,,})   
(PRE) aAdd (_aTotal[05][3][3], {1, "",,,,,,}) 
(PRE) aAdd (_aTotal[05][3][3], {1, "",,,,,,}) 
(PRE) aAdd (_aTotal[05][3][3], {1, "",,,,,,}) 
(PRE) aAdd (_aTotal[05][3][3], {1, "Total de Despesas do Mês",,,,,,})
(PRE) aAdd (_aTotal[05][3][3], {1, "Numero de Empregados",,,,,,}) 
(PRE) aAdd (_aTotal[05][3][3], {2,,"@E 999999999999.99",2,2,,,15})
(PRE) aAdd (_aTotal[05][3][3], {2,,"999",2,0,,,3})
(PRE) aAdd (_aTotal[05][3][3], {1, "Folha de Salarios",,,,,,})
(PRE) aAdd (_aTotal[05][3][3], {1, "ICMS diferido Mês Anterior",,,,,,})
(PRE) aAdd (_aTotal[05][3][3], {2,,"@E 999999999999.99",2,2,,,15})
(PRE) aAdd (_aTotal[05][3][3], {2,,"@E 999999999999.99",2,2,,,15})
(PRE) aAdd (_aTotal[05][3][3], {1, "Vlr da Atuali. Monetária do Mês Anterior",,,,,,})
(PRE) aAdd (_aTotal[05][3][3], {1, "Indicador de Sistema ",,,,,,})
(PRE) aAdd (_aTotal[05][3][3], {2,,"@E 999999999999.99",2,2,,,15})
(PRE) aAdd (_aTotal[05][3][3], {3,,,,,{"P-Próprio","I-Importado"},,})

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³CHAMADA WIZARD³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
(PRE) _aTotal[07] := xMagWizard (_aTotal[04], _aTotal[05], _aTotal[06])
(PRE) Iif (_aTotal[07], xMagLeWiz (_aTotal[06], @_aTotal[08], .T.), Nil)
(PRE) lAbtMT950	:= !_aTotal[07]

[XXX Resumo das Operacoes e Prestacoes]
(PRE) _aTotal[95]:= FisApur("IC",val(Substr(DTOS(dDmaFin),1,4)),val(Substr(DTOS(dDmaFin),5,2)),2,0,"*",.F.,{},1,.T.,"R01","")
(PRE) _atotal[96]:= ResumeF3("IC",dDmainc,dDmaFin,"*",.F.,.T.,1,.F.,2,Nil,Nil,{},{},"",.T.,"R02",.F.)

[R01 Apuracao de ICMS]                 
(PRE) R01->(DbGoTop())
(PRE) R01->(DBSEEK("001"))
(PRE) _aTotal[34] := R01->VALOR 
(PRE) R01->(DBSEEK("002"))
(PRE) _aTotal[35] := R01->VALOR 
(PRE) R01->(DBSEEK("018"))
(PRE) _aTotal[36] := R01->VALOR
(PRE) R01->(DBSEEK("013"))
(PRE) _aTotal[37] := R01->VALOR  
(PRE) R01->(DBSEEK("005"))
(PRE) _aTotal[38] := R01->VALOR
(PRE) R01->(DBSEEK("006"))
(PRE) _aTotal[39] := R01->VALOR 

[SD2  Despesas e Receitas] 
(PRE) dbSelectArea("SF4")
(PRE) _aTotal[98] := SD2->(IndexKey())
(PRE) _aTotal[90] := {"SD2",""}
(PRE) _aTotal[91] := "D2_FILIAL='"+ xFilial("SD2") +"' AND D2_EMISSAO>='"+DTOS(MV_PAR01)+"' AND D2_EMISSAO<='"+DTOS(MV_PAR02)+"'"
(PRE) _aTotal[99] := "D2_FILIAL=='"+ xFilial("SD2") +"' .And. DTOS(D2_EMISSAO)>='"+ DTOS(MV_PAR01) +"' .And. DTOS(D2_EMISSAO)<='"+DTOS(MV_PAR02)+"'"
(PRE) FsQuery(_aTotal[90],1,_aTotal[91],_aTotal[99],_aTotal[98])
(PRE) SD2->(dbGoTop())
(PREREG) SubStr(SD2->D2_CF, 1, 1)>='5'
(PREREG) SF4->(MsSeek(xFilial("SF4")+SD2->D2_TES))
(PREREG) (_aTotal[23] := Iif(!Empty(SF4->F4_BASEICM),_aTotal[23]+ SD2->D2_TOTAL,_aTotal[23]), .T.)
(POS) FsQuery(_aTotal[90],2)
 
[SF3 - INFORMACOES RESUMO]
(PRE) _aTotal[88] := {"SF3", ""}
(PRE) FsQuery (_aTotal[88],1,"F3_FILIAL ='"+xFilial("SF3")+"' AND F3_EMISSAO>='"+DTOS(mv_par01)+"' AND F3_EMISSAO<='"+DTOS(mv_par02)+"'","F3_FILIAL=='"+xFilial("SF3")+"' .AND. DTOS(F3_EMISSAO) >= '" + DTOS(mv_par01)+"' .AND. DTOS(F3_EMISSAO)<='"+DTOS(mv_par02)+"'",SF3->(IndexKey()))
(PRE) SF3->(dbGoTop())
(PREREG) (_aTotal[09]:= Iif (SubStr(SF3->F3_CFO, 1, 1)>='5' .AND. SF3->F3_TIPO<>'S' , _aTotal[09]+ SF3->F3_VALCONT, _aTotal[09]), .T.)  
(PREREG) (_aTotal[10]:= Iif (SubStr(SF3->F3_CFO, 1, 1)<'5' , _aTotal[10]+ SF3->F3_VALCONT, _aTotal[10]), .T.) 
(PREREG) (_aTotal[20]:= Iif (SubStr(SF3->F3_CFO, 1, 1)$'3' , _aTotal[20]+ SF3->F3_VALCONT, _aTotal[20]), .T.) 
(PREREG) (_aTotal[21]:= Iif (SubStr(SF3->F3_CFO, 1, 1)>='5' , _aTotal[21]+ SF3->F3_VALCONT, _aTotal[21]), .T.)  
(PREREG) (_aTotal[13]:= Iif (SubStr(SF3->F3_CFO, 1, 1)>='5' , _aTotal[13]+ SF3->F3_VALICM, _aTotal[13]), .T.) 
(POS) FsQuery (_aTotal[88],2)

//[XXX - Despesas e Receitas]
(PREREG) (_aTotal[11] := Iif(SubStr(SF3->F3_CFO, 1, 1)>='5', _aTotal[11]+ SF3->F3_VALCONT, _aTotal[11]),.T.)  
(PREREG) (_aTotal[12] := Iif(SubStr(SF3->F3_CFO, 1, 1)>='5' .AND. !Empty(SF3->F3_ISENICM), _aTotal[12]+ SF3->F3_VALCONT,_aTotal[12]), .T.)
(PREREG) (_aTotal[14] := Iif(SubStr(SF3->F3_CFO, 1, 1)>='5' .AND. !Empty(SF3->F3_ICMSRET), _aTotal[14]+ SF3->F3_VALCONT,_aTotal[14]), .T.)
(PREREG) (_aTotal[15] := Iif(SubStr(SF3->F3_CFO, 1, 1)>='5' .AND. !Empty(SF3->F3_ICMSRET), _aTotal[15]+ SF3->F3_ICMSRET,_aTotal[15]), .T.)
(PREREG) (_aTotal[16] := Iif(SF3->F3_TIPO='S' , _aTotal[16]+ SF3->F3_VALCONT,_aTotal[16]), .T.)    
(PREREG) (_aTotal[22] := Iif(SubStr(SF3->F3_CFO, 1, 1)>='5' .AND. !Empty(SF3->F3_ICMSDIF), _aTotal[22]+ SF3->F3_VALCONT,_aTotal[22]), .T.)
//total valor excluidos
(PREREG) (_aTotal[33] := _aTotal[16]+_aTotal[12]+_aTotal[23]+_aTotal[14]+_aTotal[22]+_aTotal[15],.T.)

[XXX Registro Principal]
(PREREG) _aTotal[01]:= DTOS(dDmaFin)

[XXX ICMS a Recolher]
(PRE) _aTotal[96]:= NmArqApur("IC",val(Substr(DTOS(dDmaFin),1,4)),val(Substr(DTOS(dDmaFin),5,2)),2,0,"*")
(PRE) _aTotal[95]:= LoadDtVenc(_aTotal[96])
(PRE) _aTotal[95]:= If(!Empty(_aTotal[95]),_aTotal[95],dDataBase)
(PREREG) _aTotal[95]:= If(!Empty(_aTotal[95]),_aTotal[95],dDataBase)                                  
//Receita Bruta Mensal Tributavel
(PREREG) (_aTotal[41] := _aTotal[11] - _aTotal[33],.T.) 

(PREREG) (_aTotal[47] := Substr(_aTotal[45],AT(Substr(_aTotal[01],1,4),_aTotal[45])+5,7),.T.)

//vALOR UPFS
(PREREG) (_aTotal[46] := Int(_aTotal[41] / Val(_aTotal[47])),.T.) 

//Aliquota
(PREREG) (_aTotal[40] := Iif(_aTotal[46]<=2100,0,Iif(_aTotal[46]>2100 .AND. _aTotal[46]<=6250,0.02,Iif(_aTotal[46]>6250 .AND. _aTotal[46]<=12500,0.03,0.04))),.T.)
 //deducoes
(PREREG) (_aTotal[42] := Iif(_aTotal[46]<=2100,0,Iif(_aTotal[46]>2100 .AND. _aTotal[46]<=6250,42,Iif(_aTotal[46]>6250 .AND. _aTotal[46]<=12500,104.50,229.50))),.T.)
 
(PREREG) (_aTotal[43] := Iif(_aTotal[40]>0,_aTotal[46] *  _aTotal[40] - _aTotal[42],0),.T.)  
//Valor ICMS
(PREREG) (_aTotal[48] := Iif(_aTotal[40]>0,_aTotal[43] *  Val(_aTotal[47]),0),.T.)
 //icms a recolher
(PREREG) (_aTotal[44] := Iif(_aTotal[48]+Val(_aTotal[08][3][4])+Val(_aTotal[08][3][5])>Val(_aTotal[08][2][6])+Val(_aTotal[08][2][3]),(_aTotal[48]+Val(_aTotal[08][3][4])+Val(_aTotal[08][3][5]))-(Val(_aTotal[08][2][6])+Val(_aTotal[08][2][3])),0),.T.)

[XXX Registro Principal]
ID_Reg     C 002 0 "D0"
ID_Arquivo C 003 0 "GIS"
Versao     C 002 0 "03"
Periodo    C 006 0 Substr(DTOS(dDmaFin),5,2)+Substr(DTOS(dDmaFin),1,4)
CNPJ       C 014 0 ALLTRIM(SM0->M0_CGC)
RAZAO      C 050 0 ALLTRIM(SM0->M0_NOMECOM)
CGC        C 010 0 ALLTRIM(SM0->M0_INSC)
CGCCENT    C 010 0 Iif(!Empty(_aTotal[08][1][2]),_aTotal[08][1][2],SM0->M0_INSC)
NESTAB     N 002 0 Iif(!Empty(_aTotal[08][1][3]),Val(_aTotal[08][1][3]),0)
Retific    C 001 0 Iif(Substr(_aTotal[08][1][3],1,1)=="R","X","")

//[XXX - INFORMACOES RESUMO]
RECBRAA    N 015 2 Iif(!Empty(_aTotal[08][2][1]),Val(_aTotal[08][2][1]),0)
RECBRAC    N 015 2 Iif(!Empty(_aTotal[08][2][2]),Val(_aTotal[08][2][2]),0)
TOTENTR    N 015 2 _aTotal[10]
TOTSAID    N 015 2 _aTotal[09]
DEBIMP     N 015 2 _aTotal[20]+ Iif(!Empty(_aTotal[08][2][5]),Val(_aTotal[08][2][5]),0)
PAGFTGER   N 015 2 Iif(!Empty(_aTotal[08][2][6]),Val(_aTotal[08][2][6]),0)
DEBFTGER   N 015 2 Iif(!Empty(_aTotal[08][2][3]),Val(_aTotal[08][2][3]),0)

//[XXX - Despesas e Receitas]
TOTDESP    N 015 2 Iif(!Empty(_aTotal[08][3][1]),Val(_aTotal[08][3][1]),0)
NUMEMP     N 003 0 Iif(!Empty(_aTotal[08][3][2]),Val(_aTotal[08][3][2]),0)
FOLHA      N 015 2 Iif(!Empty(_aTotal[08][3][3]),Val(_aTotal[08][3][3]),0)
RMENSAL    N 015 2 _aTotal[11]
//[XXX - Valores a Excluir]
PRESTACAO  N 015 2 _aTotal[16]
SAIISEN    N 015 2 _aTotal[12]
SAIRED     N 015 2 _aTotal[23] 
SUBTRIB    N 015 2 _aTotal[14]
DIFE       N 015 2 _aTotal[22]
DEBST      N 015 2 _aTotal[15]                                               

//[XXX - Apuracao ICMS]
RECTRIB    N 015 2 _aTotal[11] - (_aTotal[16]+_aTotal[12]+_aTotal[23]+_aTotal[14]+_aTotal[22]+_aTotal[15])
ICMCALC    N 015 2 _aTotal[48]
ICMDIF     N 015 2 Iif(!Empty(_aTotal[08][3][4]),Val(_aTotal[08][3][4]),0)
ATMONET    N 015 2 Iif(!Empty(_aTotal[08][3][5]),Val(_aTotal[08][3][5]),0)
ICMPROP    N 015 2 _aTotal[44]
ICMST      N 015 2 0
ICMDIF     N 015 2 _aTotal[36]

Data1Venc  C 008 0 Substr(DTOS(_aTotal[95]),7,2) + Substr(DTOS(_aTotal[95]),5,2) + Substr(DTOS(_aTotal[95]),1,4)
ValPr1V    N 015 2 _aTotal[44]
ValST1V    N 015 2 0
Data2Venc  N 008 0 0
ValPr2V    N 015 2 0
ValST2V    N 015 2 0
Data3Venc  N 008 0 0
ValPr3V    N 015 2 0
ValST3V    N 015 2 0
Data4Venc  N 008 0 0
ValPr4V    N 015 2 0
ValST4V    N 015 2 0
Data4Venc  N 008 0 0
ValPr5V    N 015 2 0
ValST5V    N 015 2 0 
Indicador  C 001 0 Iif(Substr(_aTotal[08][3][6],1,1)='I',"X","")

[XXX Parte2]
ID_Reg     C 002 0 "D2"  
NOcorr     N 002 0 Iif(Val(_aTotal[08][2][3])>0,Iif(!Empty(_aTotal[08][2][4]),Val(_aTotal[08][2][4]),0),0)
DiaVenc    C 002 0 Iif(VAl(_aTotal[08][2][3])>0,Substr(DTOS(_aTotal[95]),7,2),"0")
DebProprio N 015 2 Iif(VAl(_aTotal[08][2][3])>0,Val(_aTotal[08][2][3]),0)
Compl      C 618 0 Replicate("0",618)
