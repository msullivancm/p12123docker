?{"Nome do Ficheiro INI","DPIVA.INI"}
?{"Descrição Completa do Ficheiro Magnético","Declaração Periódica de IVA"}
?{"A Quem se Destina","Contribuintes Sujeitos Passivos do IVA."}
?{"Objectivo","A informação sobre a situação tributária dos contribuintes por meio electrónicos, constitui uma forma importante de desburocratização administrativa, facilitando a obtenção dessa informação."}
?{"Prazo de Entrega","Mensal ou Trimestral dependendo do regime de recolhimento."}
?{"Aplicativo Disponibilizado pelo DGCI","DPI - Versão 3.4"}
?{"Versão do Aplicativo Contemplada pela Microsiga","3.4"}
?{"Legislação", "Despacho nº 18 751/98."}
?{"A ser encontrada", "www.e-financas.gov.pt"}

[XXX Inicializacao]
(PRE) _aTotal[001] := {}
(PRE) _aTotal[002] := {}
(PRE) _aTotal[003] := .F.
(PRE) _aTotal[004] := {}
(PRE) _aTotal[005] := ""
(PRE) _aTotal[006] := {}
(PRE) _aTotal[007] := 0 
(PRE) _aTotal[008] := 0
(PRE) _aTotal[009] := 0
(PRE) _aTotal[010] := 0
(PRE) _aTotal[011] := 0
(PRE) _aTotal[012] := 0
(PRE) _aTotal[013] := 0
(PRE) _aTotal[014] := 0
(PRE) _aTotal[015] := 0
(PRE) _aTotal[016] := 0
(PRE) _aTotal[017] := 0
(PRE) _aTotal[018] := 0
(PRE) _aTotal[019] := 0
(PRE) _aTotal[020] := 0 
(PRE) _aTotal[021] := 0 
(PRE) _aTotal[022] := ""
(PRE) _aTotal[023] := ""
(PRE) _aTotal[024] := 0
(PRE) _aTotal[025] := 0 
(PRE) _aTotal[026] := {}


[XXX Montagem do CFP Utilizado pela rotina - PRINCIPAL]
(PRE) aAdd (_aTotal[001], "Processamento da DPI")
(PRE) aAdd (_aTotal[001], "")
(PRE) aAdd (_aTotal[001], "Preencha correctamente as informações solicitadas.")
(PRE) aAdd (_aTotal[001], "Informações necessárias para o preenchimento automático da DPI           Declaração Periódica de IVA.")

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[002], {})
(PRE) aAdd (_aTotal[002][1], "Processamento da DPI")
(PRE) aAdd (_aTotal[002][1], "Prazo da Declaração - Quadro 01")
(PRE) aAdd (_aTotal[002][1], {})
(PRE) aAdd (_aTotal[002][1][3], {1, "Prazo da declaração",,,,,,})
(PRE) aAdd (_aTotal[002][1][3], {3,,,,,{"01-Dentro", "02-Fora"},,})

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[002], {})
(PRE) aAdd (_aTotal[002][2], "Processamento da DPI")
(PRE) aAdd (_aTotal[002][2], "Localização da Sede - Quadro 03")
(PRE) aAdd (_aTotal[002][2], {})
(PRE) aAdd (_aTotal[002][2][3], {1, "Localização da Sede",,,,,,})
(PRE) aAdd (_aTotal[002][2][3], {3,,,,,{"01-Continente", "02-Açores", "03-Madeira"},,}) 

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[002], {})
(PRE) aAdd (_aTotal[002][3], "Processamento da DPI")
(PRE) aAdd (_aTotal[002][3], "Anexos Entregues - Quadro 04")
(PRE) aAdd (_aTotal[002][3], {})
(PRE) aAdd (_aTotal[002][3][3], {1, "Operações efectuadas em Continente",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {3,,,,,{"01-Sim", "02-Não"},,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {1, "Operações efectuadas em Açores",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {3,,,,,{"01-Sim", "02-Não"},,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {1, "Operações efectuadas em Madeira",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {3,,,,,{"01-Sim", "02-Não"},,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {1, "Regime do IVA transacções intracomunitárias",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {3,,,,,{"01-Sim", "02-Não"},,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {1, "Relação de Clientes",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {3,,,,,{"01-Sim", "02-Não"},,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {1, "Relação de Fornecedores",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {3,,,,,{"01-Sim", "02-Não"},,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {1, "Relação Suj. Passivos",,,,,,})
(PRE) aAdd (_aTotal[002][3][3], {3,,,,,{"01-Sim", "02-Não"},,})

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[002], {})
(PRE) aAdd (_aTotal[002][4], "Processamento da DPI")
(PRE) aAdd (_aTotal[002][4], "Inexistência de operações - Quadro 05A")
(PRE) aAdd (_aTotal[002][4], {})
(PRE) aAdd (_aTotal[002][4][3], {1, "Não realizou operações activas nem passivas",,,,,,})
(PRE) aAdd (_aTotal[002][4][3], {4,"",,,,,.F.,})

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[002], {})
(PRE) aAdd (_aTotal[002][5], "Processamento da DPI")
(PRE) aAdd (_aTotal[002][5], "Apuramento do imposto respeitante ao período a que respeita a declaração - Quadro 06")
(PRE) aAdd (_aTotal[002][5], {})
(PRE) aAdd (_aTotal[002][5][3], {1, "Informe o livro contábil do Quadro 06?",,,,,,})
(PRE) aAdd (_aTotal[002][5][3], {2,,"XXX",1,,,,3})
(PRE) aAdd (_aTotal[002][5][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][5][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][5][3], {1, "Informe a Moeda",,,,,,})
(PRE) aAdd (_aTotal[002][5][3], {2,,"99",1,,,,2})

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[002], {})
(PRE) aAdd (_aTotal[002][6], "Processamento da DPI")
(PRE) aAdd (_aTotal[002][6], "Operações referidas nas alíneas F e G do N.3 do Art.3 e nas alíneas A e B do N.2 do Art. 4 - Quadro 10")
(PRE) aAdd (_aTotal[002][6], {})
(PRE) aAdd (_aTotal[002][6][3], {1, "Houve Operações desta natureza?",,,,,,})
(PRE) aAdd (_aTotal[002][6][3], {3,,,,,{"01-Sim", "02-Não"},,})    
(PRE) aAdd (_aTotal[002][6][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][6][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][6][3], {1, "Montante do Imposto Liquidado",,,,,,})
(PRE) aAdd (_aTotal[002][6][3], {2,,"@E 99,999,999.99",2,2,,,13})

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[002], {})
(PRE) aAdd (_aTotal[002][7], "Processamento da DPI")
(PRE) aAdd (_aTotal[002][7], "Quadro 13")
(PRE) aAdd (_aTotal[002][7], {})
(PRE) aAdd (_aTotal[002][7][3], {1, "É a primeira declaração que apresenta?",,,,,,})
(PRE) aAdd (_aTotal[002][7][3], {3,,,,,{"01-Sim", "02-Não"},,})
(PRE) aAdd (_aTotal[002][7][3], {1, "Indique a data de início de actividade",,,,,,})
(PRE) aAdd (_aTotal[002][7][3], {2,,,3,,,,})
(PRE) aAdd (_aTotal[002][7][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][7][3], {0, "",,,,,,})
(PRE) aAdd (_aTotal[002][7][3], {1, "É a última declaração que apresenta?",,,,,,})
(PRE) aAdd (_aTotal[002][7][3], {3,,,,,{"01-Sim", "02-Não"},,})
(PRE) aAdd (_aTotal[002][7][3], {1, "Indique a data de cessação de actividade",,,,,,})
(PRE) aAdd (_aTotal[002][7][3], {2,,,3,,,,}) 

[XXX Montagem do CFP Utilizado pela rotina - COMPLEMENTAR]
(PRE) aAdd (_aTotal[002], {})
(PRE) aAdd (_aTotal[002][8], "Processamento da DPI")
(PRE) aAdd (_aTotal[002][8], "Identificação do Técnico Oficial de Contas - Quadro 20")
(PRE) aAdd (_aTotal[002][8], {})
(PRE) aAdd (_aTotal[002][8][3], {1, "NIF do Técnico Oficial de Contas",,,,,,})
(PRE) aAdd (_aTotal[002][8][3], {2,,"XXXXXXXXXXXXXXXXXXXX",1,,,,20})


[XXX Chamada do Wizard]
(PRE) _atotal[003] := xMagWizard( _aTotal[001] , _aTotal[002] , "DPIVA" )
(PRE) Iif (_atotal[003], xMagLeWiz ("DPIVA", @_aTotal[004], .T.), Nil)
(PRE) lAbtMT950	:= !_atotal[003]
                                           
[XXX Registro Tipo 01 - Header de ficheiro]
TPOREG     C 002 0 "01"
TPOFIC     C 005 0 "ASCII"
VERFIC     C 002 0 "02"
DTFIC      C 008 0 DTOS(dDataBase)
ESP        C 117 0 " "                
                                           
[XXX Registro Tipo 02 - Header de declaracao]
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "02"
TPODEC     C 005 0 "DPIVA"
NUMNIF     C 009 0 SM0->M0_CGC
PRAZO      C 001 0 If ("01"$_aTotal[004][1][1],"1","2")
ESP        C 117 0 " "                

[XXX Registro Tipo 03 - Header Declaracao Periodica de IVA]
(PRE)  _aTotal[005]:= If ("01"$_aTotal[004][3][1],"1","0")
(PRE)  _aTotal[005]+= If ("01"$_aTotal[004][3][2],"2","0")
(PRE)  _aTotal[005]+= If ("01"$_aTotal[004][3][3],"3","0") 
//Pegar o Ano de referencia
(PRE)	_aTotal[022] := StrZero(Year (MV_PAR02),4)
//Se a Data De / Ate compreenderem um intervalo de 1 mes 
(PRE)	If (SubStr (Padr (MV_PAR01, 8), 4, 6)==SubStr (Padr (MV_PAR02, 8), 4, 6),_aTotal[023]:= StrZero (Month (MV_PAR02),2)+" ","")
//Quando se tratar de Trimestral, somente os meses de 1-3 ou 4-6 ou 7-9 ou 10-12 deverao ser aceitos.
(PRE)	If (Month (MV_PAR01)==1 .And. Month (MV_PAR02)==3,_aTotal[023]:="03T","" )
(PRE)	If (Month (MV_PAR01)==4 .And. Month (MV_PAR02)==6,_aTotal[023]:="06T","" )
(PRE)	If (Month (MV_PAR01)==7 .And. Month (MV_PAR02)==9,_aTotal[023]:="09T","" )
(PRE)	If (Month (MV_PAR01)==10 .And. Month (MV_PAR02)==12,_aTotal[023]:="12T","")
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "03"
LOCSED     C 001 0 If ("01"$_aTotal[004][2][1],"1",If("02"$_aTotal[004][2][1],"2","3")) 
OPDIF      C 003 0  _aTotal[005]
ACTIMO     C 001 0 "0"
REGINT     C 001 0 If ("01"$_aTotal[004][3][4],"5","0")
RELCLI     C 001 0 If ("01"$_aTotal[004][3][5],"1","0")
RELFOR     C 001 0 If ("01"$_aTotal[004][3][6],"1","0")
RELSUJ     C 001 0 If ("01"$_aTotal[004][3][7],"1","0")
INEXOP     C 001 0 If("F"$_aTotal[004][4][1],"0","1")
ANODEC     C 004 0 _aTotal[022]
PERDEC     C 003 0 _aTotal[023]
ESP        C 115 0 " "
                                                           
[XXX Registro Tipo 04 - Header Declaracao Periodica de IVA]
(PRE)	_aTotal[026] := GetSldPlGer( _aTotal[004][5][1] , MV_PAR01 , MV_PAR02 ,  _aTotal[004][5][2])
(PREREG) _aTotal[025]++
(PREREG) _aTotal[024]++
TPOREG     C 002 0 "04"
CPO01      N 012 2 _aTotal[026][1][4]
CPO05      N 012 2 _aTotal[026][5][4]
CPO03      N 012 2 _aTotal[026][3][4]
CPO07      N 012 2 _aTotal[026][7][4]
CPO08      N 012 2 _aTotal[026][8][4]
CPO09      N 012 2 _aTotal[026][9][4]
CPO10      N 012 2 _aTotal[026][10][4]
CPOTOT     N 012 2 _aTotal[026][1][4]+_aTotal[026][5][4]+_aTotal[026][3][4]+_aTotal[026][7][4]+_aTotal[026][8][4]+_aTotal[026][9][4]+_aTotal[026][10][4]

[XXX Registro Tipo 05 - Header Declaracao Periodica de IVA]
(PREREG) _aTotal[025]++
(PREREG) _aTotal[024]++
TPOREG     C 002 0 "05"
CPO20      N 012 2 _aTotal[026][20][4]
CPO21      N 012 2 _aTotal[026][21][4]
CPO23      N 012 2 _aTotal[026][23][4]
CPO22      N 012 2 _aTotal[026][22][4]
CPO24      N 012 2 _aTotal[026][24][4]
CPO40      N 012 2 _aTotal[026][40][4]
CPO61      N 012 2 _aTotal[026][61][4]
CPO65      N 012 2 _aTotal[026][65][4]
CPO67      N 012 2 _aTotal[026][67][4]
CPO81      N 012 2 _aTotal[026][81][4]
CPOTOT     N 012 2 _aTotal[026][20][4]+_aTotal[026][21][4]+_aTotal[026][23][4]+_aTotal[026][22][4]+_aTotal[026][24][4]+_aTotal[026][40][4]+_aTotal[026][61][4]+_aTotal[026][65][4]+_aTotal[026][67][4]+_aTotal[026][81][4]

[XXX Registro Tipo 06 - Header Declaracao Periodica de IVA]
(PREREG) _aTotal[025]++
(PREREG) _aTotal[024]++
TPOREG     C 002 0 "06"
CPO02      N 012 2 _aTotal[026][2][4]
CPO06      N 012 2 _aTotal[026][6][4]
CPO04      N 012 2 _aTotal[026][4][4]
CPO11      N 012 2 _aTotal[026][11][4]
CPO41      N 012 2 _aTotal[026][41][4]
CPO66      N 012 2 _aTotal[026][66][4]
CPO68      N 012 2 _aTotal[026][68][4]
CPOTOT     N 012 2 _aTotal[026][2][4]+_aTotal[026][6][4]+_aTotal[026][4][4]+_aTotal[026][11][4]+_aTotal[026][41][4]+_aTotal[026][66][4]+_aTotal[026][68][4]
CPOTOT1    N 012 2 ((_aTotal[026][2][4]+_aTotal[026][6][4]+_aTotal[026][4][4]+_aTotal[026][11][4]+_aTotal[026][41][4]+_aTotal[026][66][4]+_aTotal[026][68][4]) - (_aTotal[026][20][4]+_aTotal[026][21][4]+_aTotal[026][23][4]+_aTotal[026][22][4]+_aTotal[026][24][4]+_aTotal[026][40][4]+_aTotal[026][61][4]+_aTotal[026][65][4]+_aTotal[026][67][4]+_aTotal[026][81][4]))
CPOTOT2    N 012 2 ((_aTotal[026][20][4]+_aTotal[026][21][4]+_aTotal[026][23][4]+_aTotal[026][22][4]+_aTotal[026][24][4]+_aTotal[026][40][4]+_aTotal[026][61][4]+_aTotal[026][65][4]+_aTotal[026][67][4]+_aTotal[026][81][4]) - (_aTotal[026][2][4]+_aTotal[026][6][4]+_aTotal[026][4][4]+_aTotal[026][11][4]+_aTotal[026][41][4]+_aTotal[026][66][4]+_aTotal[026][68][4]))
CPO95      N 012 2 _aTotal[026][95][4]

[XXX Registro Tipo 07 - Header Declaracao Periodica de IVA]
(PREREG) _aTotal[025]++
(PREREG) _aTotal[024]++
TPOREG     C 002 0 "07"
CPO096     N 012 2 _aTotal[026][96][4]
CPO0262    N 012 2 _aTotal[026][262][4]
CPO0263    N 012 2 _aTotal[026][263][4]
CP101      C 001 0 iif("01"$_aTotal[004][6][1],"1","0")
CP102      C 001 0 "0"
CP264      N 012 2 Val( _aTotal[004][6][2] )

[XXX Registro Tipo 20 - Header Anexo I a Declaração Periódica de IVA] 
(PREREG) ("01"$_aTotal[004][3][4])
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
//Monta e alimenta o arquivo de trabalho - função no fonte DTRANSIN
(PRE) MontTR(1,,@_aTotal[006],,MV_PAR01,MV_PAR02)
TPOREG     C 002 0 "20"
NUMNIF     C 009 0 SM0->M0_CGC
ANODEC     C 004 0 _aTotal[022]
PERDEC     C 003 0 _aTotal[023]
ESP        C 116 0 " "

[TMP Registro Tipo 21 - Detalhe Anexo I a DP de IVA (1)]
(PREREG) ("01"$_aTotal[004][3][4])
(PRE) TMP->(dbGoTop()) 
(PREREG) _aTotal[008] += If (TMP->TMP_TPOPER==1,TMP->TMP_VLR,0)
(PREREG) _aTotal[009] += TMP->TMP_VLRTR
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "21"
NUMLIN     N 005 0 _aTotal[007]
PAISDE     C 002 0 TMP->TMP_PAIS
NIFADQ     C 012 0 TMP->TMP_NIF
SINAL      C 001 0 If (TMP->TMP_VLR >= 0,"+","-")
VALOPE     N 012 2 TMP->TMP_VLR
INDOPE     N 001 0 TMP->TMP_TPOPER
ESP        C 099 0 " "


[XXX Registro Tipo 22 - Trailer Anexo I a DP de IVA]
(PREREG) ("01"$_aTotal[004][3][4])
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "22"
NUMREG     N 005 0 _aTotal[007]
SINALS     C 001 0 If (_aTotal[008] >= 0,"+","-")
SOMOPE     N 012 2 _aTotal[008]
SINALT     C 001 0 If (_aTotal[009] >= 0,"+","-")
TOTVEN     N 012 2 _aTotal[009]
ESP        C 101 0 " "                                                                           
//Apaga o arquivo de trabalho gerado
(POS) MontTR(2,,_aTotal[006]) 


[XXX Registro Tipo 40 - Header Anexo Relação de Clientes a DP de IVA]
(PREREG) ("01"$_aTotal[004][3][5])
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
//Monta e alimenta o arquivo de trabalho - função no fonte DCLIPTG
(PRE) TempCLI(1,,@_aTotal[006],,MV_PAR01,MV_PAR02)
TPOREG     C 002 0 "40"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMNIF     C 009 0 SM0->M0_CGC
ANODEC     C 004 0 _aTotal[022]
PERDEC     C 003 0 _aTotal[023]
ESP        C 109 0 " "

[TMP Registro Tipo 41 - Detalhe Anexo Relação de Clientes a DP de IVA(1)]
(PREREG) ("01"$_aTotal[004][3][5])
(PRE) TMP->(dbGoTop())
(PRE) _aTotal[007]:=0  
(PREREG) (TMP->TMP_VLR>0)
(PREREG) If(TMP->TMP_VLR<5000,_aTotal[010]+=TMP->TMP_VLR,_aTotal[010]+=0)
(PREREG) (_aTotal[011]+=TMP->TMP_VLR)
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "41"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMLIN     N 005 0 _aTotal[007]
NUMNIF     C 009 0 If(!Empty(AllTrim(TMP->TMP_DE)),"",TMP->TMP_NIF)
VALOPE     N 012 2 TMP->TMP_VLR
ESP        C 099 0 " "
 

[TMP Registro Tipo 42 - Detalhe Anexo Relação de Clientes a DP de IVA(2)]
(PREREG) ("01"$_aTotal[004][3][5])
(PRE) TMP->(dbGoTop())
(PREREG) (TMP->TMP_EXP>0)
(PREREG) (_aTotal[011]+=TMP->TMP_EXP)
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "42"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMLIN     N 005 0 _aTotal[007]
NUMDE      C 020 0 If(!Empty(AllTrim(TMP->TMP_NIF)),"",TMP->TMP_DE)
VALOPE     N 012 2 TMP->TMP_EXP
ESP        C 088 0 " "


[XXX Registro Tipo 49 - Trailer Anexo Relação de Clientes a DP de IVA]
(PREREG) ("01"$_aTotal[004][3][5])
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "49"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMREG     N 009 0 _aTotal[007]
SOMCLI     N 012 2 _aTotal[010]
SOMEST     N 012 2 0
SOMISE     N 012 2 0
TOTAL      N 014 2 _aTotal[011]
ESP        C 066 0 " "
//Apaga o arquivo de trabalho gerado
(POS) TempCLI(2,,_aTotal[006])

[XXX Registro Tipo 50 - Header Anexo Relação de Fornecedores a DP de IVA]
(PREREG) ("01"$_aTotal[004][3][6])
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
//Monta e alimenta o arquivo de trabalho - função no fonte DFORPTG
(PRE) TempFOR(1,,@_aTotal[006],,MV_PAR01,MV_PAR02)
TPOREG     C 002 0 "50"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMNIF     C 009 0 SM0->M0_CGC
ANODEC     C 004 0 _aTotal[022]
PERDEC     C 003 0 _aTotal[023]
ESP        C 109 0 " " 
			
[TMP Registro Tipo 51 - Detalhe Anexo Relação de Fornecedores a DP de IVA(1)]
(PREREG) ("01"$_aTotal[004][3][6])
(PRE) TMP->(dbGoTop())
(PRE) _aTotal[007]:=0
(PREREG) If(TMP->TMP_IVAEXC<5000,_aTotal[012]+=TMP->TMP_IVAEXC,_aTotal[012]+=0)
(PREREG) If(TMP->TMP_IVAEXC<5000,_aTotal[013]+=TMP->TMP_VLRDED,_aTotal[013]+=0)
(PREREG) _aTotal[014]+=TMP->TMP_IVAEXC
(PREREG) _aTotal[015]+=TMP->TMP_VLRDED
(PREREG) (TMP->TMP_CMP=="20") 
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "51"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMLIN     N 005 0 _aTotal[007]
20PRE      C 002 0 TMP->TMP_PREF
20NIF      C 012 0 TMP->TMP_NIF
20LIQ      C 014 0 TMP->TMP_NUMLIQ
20ANO      C 004 0 TMP->TMP_ANO
20MES      C 002 0 TMP->TMP_MES
20VLEX     N 012 2 TMP->TMP_IVAEXC
20IVAD     N 012 2 TMP->TMP_VLRDED
ESP        C 062 0 " "

[TMP Registro Tipo 52 - Detalhe Anexo Relação de Fornecedores a DP de IVA(2)]
(PREREG) ("01"$_aTotal[004][3][6])
(PRE) TMP->(dbGoTop())
(PREREG) (TMP->TMP_CMP=="21") 
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "52"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMLIN     N 005 0 _aTotal[007]
21PRE      C 002 0 TMP->TMP_PREF
21NIF      C 012 0 TMP->TMP_NIF
21LIQ      C 014 0 TMP->TMP_NUMLIQ
21ANO      C 004 0 TMP->TMP_ANO
21MES      C 002 0 TMP->TMP_MES
21VLEX     N 012 2 TMP->TMP_IVAEXC
21IVAD     N 012 2 TMP->TMP_VLRDED
ESP        C 062 0 " "


[TMP Registro Tipo 53 - Detalhe Anexo Relação de Fornecedores a DP de IVA(3)]
(PREREG) ("01"$_aTotal[004][3][6])
(PRE) TMP->(dbGoTop())
(PREREG) (TMP->TMP_CMP=="22")   
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "53"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMLIN     N 005 0 _aTotal[007]
22PRE      C 002 0 TMP->TMP_PREF
22NIF      C 012 0 TMP->TMP_NIF
22LIQ      C 014 0 TMP->TMP_NUMLIQ
22ANO      C 004 0 TMP->TMP_ANO
22MES      C 002 0 TMP->TMP_MES
22VLEX     N 012 2 TMP->TMP_IVAEXC
22IVAD     N 012 2 TMP->TMP_VLRDED
ESP        C 062 0 " "

[TMP Registro Tipo 54 - Detalhe Anexo Relação de Fornecedores a DP de IVA(4)]
(PREREG) ("01"$_aTotal[004][3][6])
(PRE) TMP->(dbGoTop())
(PREREG) (TMP->TMP_CMP=="23") 
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "54"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMLIN     N 005 0 _aTotal[007]
23PRE      C 002 0 TMP->TMP_PREF
23NIF      C 012 0 TMP->TMP_NIF
23LIQ      C 014 0 TMP->TMP_NUMLIQ
23ANO      C 004 0 TMP->TMP_ANO
23MES      C 002 0 TMP->TMP_MES
23VLEX     N 012 2 TMP->TMP_IVAEXC
23IVAD     N 012 2 TMP->TMP_VLRDED
ESP        C 062 0 " "

[TMP Registro Tipo 55 - Detalhe Anexo Relação de Fornecedores a DP de IVA(5)]
(PREREG) ("01"$_aTotal[004][3][6])
(PRE) TMP->(dbGoTop())
(PREREG) (TMP->TMP_CMP=="24") 
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "55"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMLIN     N 005 0 _aTotal[007]
24PRE      C 002 0 TMP->TMP_PREF
24NIF      C 012 0 TMP->TMP_NIF
24LIQ      C 014 0 TMP->TMP_NUMLIQ
24ANO      C 004 0 TMP->TMP_ANO
24MES      C 002 0 TMP->TMP_MES
24VLEX     N 012 2 TMP->TMP_IVAEXC
24IVAD     N 012 2 TMP->TMP_VLRDED
ESP        C 062 0 " "
 
[XXX Registro Tipo 59 - Trailer Anexo Relação de Fornecedores a DP de IVA] 
(PREREG) ("01"$_aTotal[004][3][6])
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "59"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMREG     N 009 0 _aTotal[007]
TOTAQU     N 012 2 _aTotal[012]
TOTDED     N 012 2 _aTotal[013]
IVAEXC     N 014 2 _aTotal[014]
IVADED     N 014 2 _aTotal[015]            		
ESP        C 064 0 " "
//Apaga o arquivo de trabalho gerado
(POS) TempFOR(2,,_aTotal[006]) 

[XXX Registro Tipo 70 - Header Anexo Relação dos suj. Passivos a que respeitam as regularizações á DP de IVA]
(PREREG) ("01"$_aTotal[004][3][7])
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
//Monta e alimenta o arquivo de trabalho - função no fonte DTRANSIN
(PRE) MontSJP(1,,@_aTotal[006],,MV_PAR01,MV_PAR02)
TPOREG     C 002 0 "70"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMNIF     C 009 0 SM0->M0_CGC
ANODEC     C 004 0 _aTotal[022]
PERDEC     C 003 0 _aTotal[023]
ESP        C 109 0 " " 

[TMP Registro Tipo 71 - Detalhe Anexo Relacao dos SPs a que respeitam as regularizações á DP de IVA(1)]
(PREREG) ("01"$_aTotal[004][3][7])
(PRE) TMP->(dbGoTop())
(PRE) _aTotal[007]:=0 
(PREREG) If(TMP->TMP_VLR <1000,_aTotal[016]+=TMP->TMP_VLR,_aTotal[016]+=0)
(PREREG) If(TMP->TMP_VLR <1000,_aTotal[017]+=TMP->TMP_BSREG,_aTotal[017]+=0)
(PREREG) _aTotal[018]+=TMP->TMP_VLR
(PREREG) _aTotal[019]+=TMP->TMP_BSREG
(PREREG) _aTotal[007]++
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "71"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMLIN     N 005 0 _aTotal[007]
NIFPAS     C 009 0 TMP->TMP_NIF
ANO        C 004 0 TMP->TMP_ANO
MES        C 002 0 TMP->TMP_MES
BSEINC     N 012 2 TMP->TMP_BSREG
VALIVA     N 012 2 TMP->TMP_VLR
ESP        C 081 0 " "


[XXX Registro Tipo 79 - Trailer Anexo Relacao dos SPs a que respeitam as regularizações á DP de IVA]
(PREREG) ("01"$_aTotal[004][3][7])
(PREREG) _aTotal[024]++
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "79"
ANOANE     C 004 0 _aTotal[022]
PERANE     C 003 0 _aTotal[023]
NUMREG     N 009 0 _aTotal[007]
BSEINF     N 012 2 _aTotal[016]
VALINF     N 012 2 _aTotal[017]
RATBSE     N 012 2 0
RATIVA     N 012 2 0
OUTBSE     N 012 2 0
OUTIVA     N 012 2 0
TOTBSE     N 014 2 _aTotal[018]
TOTIVA     N 014 2 _aTotal[019]
ESP        C 016 0 " "
//Apaga o arquivo de trabalho gerado
(POS) MontSJP(2,,_aTotal[006])  

[XXX Registro Tipo 89 - Trailer da Declaração]
(PREREG) _aTotal[025]++
TPOREG     C 002 0 "89"
NUMREG     N 009 0 _aTotal[024]
ESP        C 123 0 " "

[XXX Registro Tipo 99 - Trailer do Ficheiro]
TPOREG     C 002 0 "99"
NUMREG     N 009 0 _aTotal[025]
ESP        C 123 0 " "
