[XXX POSICIONAMENTOS]
(PRE) If(AllTrim(SF1->F1_ESPECIE)<>"NDI",SA1->(MSSeek(xFilial("SA1")+SF1->F1_FORNECE +SF1->F1_LOJA)) , .T.)
(PRE) (AI0->(MSSeek(xFilial("AI0")+SF1->F1_FORNECE +SF1->F1_LOJA)) , .T.)

[XXX INICIALIZACION]
(PRE) SD1->(DbSetOrder(1))
(PRE) SB1->(DbSetOrder(1))
(PRE) SYA->(DbSetOrder(1))
(PRE) SC6->(DbSetOrder(1))
(PRE) SE4->(DbSetOrder(1)) 
(PRE) CTO->(DbSetOrder(1)) 
(PRE) SAH->(DbSetOrder(1))

(PRE) _aTotal[002] := chr(13) + chr(10)
(PRE) _aTotal[003] := "99999999999999.99"
(PRE) _aTotal[004] := {"SD1",""}
(PRE) _aTotal[005] := IIf(Alltrim(SF1->F1_ESPECIE)=="NF","factura","notaDebito")
(PRE) _aTotal[006] := Alltrim(SF1->F1_SERIE) + Alltrim(SF1->F1_DOC) + Alltrim(SF1->F1_ESPECIE)
(PRE) _aTotal[007] := SuperGetMV("MV_CFDIAMB",.F.,"1")
(PRE) _aTotal[008] := GetTaxasEq(SF1->F1_DOC, SF1->F1_SERIE, SF1->F1_FORNECE , SF1->F1_LOJA, .T.)
(PRE) _aTotal[009] := TamSX3("F1_DOC")[1]
(PRE) _aTotal[010] := ""
(PRE) _aTotal[011] := SUBSTR(DTOS(SF1->F1_EMISSAO),0,4) + "-" + SUBSTR(DTOS(SF1->F1_EMISSAO),5,2) + "-" + SUBSTR(DTOS(SF1->F1_EMISSAO),7,2) + "T" + SF1->F1_HORA + "Z"
(PRE) _aTotal[012] := fObtDocRef(SF1->F1_FILIAL, SF1->F1_DOC, SF1->F1_SERIE, SF1->F1_FORNECE, SF1->F1_LOJA, .T.)
(PRE) _aTotal[013] := SuperGetMV("MV_SIGNTCO",.F.,"")

(PREREG) FsQuery(_aTotal[004],1,"D1_DOC='" + SF1->F1_DOC + "' AND D1_SERIE='" + SF1->F1_SERIE + "' AND D1_FORNECE='" + SF1->F1_FORNECE + "' AND D1_LOJA='" + SF1->F1_LOJA + "'","SD1->D1_DOC=SF1->F1_DOC .AND. SD1->D1_SERIE=SF1->F1_SERIE .AND. SD1->D1_FORNECE=SF1->F1_FORNECE .AND. SD1->D1_LOJA=SF1->F1_LOJA","D1_ITEM") .And. .T.

[XXX ENCABEZADO]
(PREREG) (_aTotal[001] := '<?xml version="1.0" encoding="iso-8859-1"?>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '<DTE version="1.1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="DTE_v1.0.xsd">' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '<Documento ID="comprobante">' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '<Encabezado>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '    <IdDoc>' + _aTotal[002],.T.)  
(PREREG) (_aTotal[001] += '        <Ambiente>' + _aTotal[007] + '</Ambiente>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <TipoEmision>' + "1" + '</TipoEmision>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <ContenidoTC></ContenidoTC>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <Tipo>04</Tipo>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <Serie>' + Alltrim(SF1->F1_SERIE) + '</Serie>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <Numero>' + Alltrim(Substr(SF1->F1_DOC,(_aTotal[009]-8),9)) + '</Numero>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <Estado>ORIGINAL</Estado>' + _aTotal[002],.T.) 
(PREREG) (_aTotal[001] += '        <FechaEmis>' + _aTotal[011] + '</FechaEmis>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <Establecimiento>' + Alltrim(SF1->F1_ESTABL) + '</Establecimiento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <PtoEmis>' + Alltrim(SF1->F1_PTOEMIS) + '</PtoEmis>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </IdDoc>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <Emisor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIf(!Empty(_aTotal[013]), '        <TipoContribuyente>' + Alltrim(_aTotal[013]) + '</TipoContribuyente>' + _aTotal[002], ""),.T.)
(PREREG) (_aTotal[001] += '        <RegimenContable>' + "SI" + '</RegimenContable>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <IDEmisor>' + Alltrim(SM0->M0_CGC) + '</IDEmisor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <NmbEmisor>' + Alltrim(SM0->M0_NOME) + '</NmbEmisor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <NombreEmisor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<PrimerNombre>' + Alltrim(SM0->M0_NOMECOM) + '</PrimerNombre>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        </NombreEmisor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <DomFiscal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<Calle>' + Alltrim(SM0->M0_ENDENT) + " " + Alltrim(SM0->M0_COMPENT) + '</Calle>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<Departamento>' + Alltrim(SM0->M0_CIDENT) + '</Departamento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<Distrito>' + Alltrim(SM0->M0_CIDENT) + '</Distrito>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<Ciudad>' + Alltrim(SM0->M0_CIDENT) + '</Ciudad>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<Municipio>' + Alltrim(SM0->M0_CIDENT) + '</Municipio>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<Pais>218</Pais>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<CodigoPostal>' + Alltrim(SM0->M0_CEPENT) + '</CodigoPostal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        </DomFiscal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <LugarExped>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<Calle>' + Alltrim(SM0->M0_ENDENT) + " " + Alltrim(SM0->M0_COMPENT) + '</Calle>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        </LugarExped>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </Emisor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <Receptor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <DocRecep>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<TipoDocRecep>' + Alltrim(SA1->A1_TIPDOC) + '</TipoDocRecep>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<NroDocRecep>' + Alltrim(SA1->A1_CGC) + '</NroDocRecep>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        </DocRecep>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <NmbRecep>' + Alltrim(SA1->A1_NOME) + '</NmbRecep>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </Receptor>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <Transporte>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <MedioTransporte>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        		<MetodoTransp>MetodoTransp</MetodoTransp>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        </MedioTransporte>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </Transporte>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <Totales>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <Moneda>' + "USD" + '</Moneda>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <SubTotal>' + Alltrim(TRANSFORM(SF1->F1_VALMERC, _aTotal[003])) + '</SubTotal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <MntDcto>' + Alltrim(TRANSFORM(SF1->F1_DESCONT, _aTotal[003])) + '</MntDcto>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <VlrPagar>' + Alltrim(TRANSFORM(SF1->F1_VALBRUT, _aTotal[003])) + '</VlrPagar>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <MontoPropina>0.00</MontoPropina>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </Totales>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += _aTotal[008][1],.T.)
(PREREG) (_aTotal[001] += '</Encabezado>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

[SD1 INVOICE]
(PRE) DbGoTop()
(PREREG) (SB1->(DbSeek(xFilial("SB1") + SD1->D1_COD)),.T.)
(PREREG) (SAH->(DbSeek(xFilial("SAH") + SB1->B1_UM)),.T.)
(PREREG) _aTotal[010]  := TaxDetEcu(SD1->D1_DOC,SD1->D1_SERIE,SD1->D1_FORNECE,SD1->D1_LOJA,SD1->D1_TES,AllTrim(SF1->F1_ESPECIE),SD1->D1_COD, .T.)
(PREREG) (_aTotal[001] := '<Detalle>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <NroLinDet>' + Alltrim(SD1->D1_ITEM) + '</NroLinDet>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <CdgItem>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <TpoCodigo>' + Alltrim(SB1->B1_UM) + '</TpoCodigo>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <VlrCodigo>' + Alltrim(SB1->B1_COD) + '</VlrCodigo>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </CdgItem>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <DscLang>ES</DscLang>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <DscItem>' + Alltrim(SB1->B1_DESC) + '</DscItem>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <QtyItem>' + Alltrim(TRANSFORM(SD1->D1_QUANT,_aTotal[003])) + '</QtyItem>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <PrcNetoItem>' + Alltrim(TRANSFORM((SD1->D1_TOTAL + SD1->D1_VALDESC)/SD1->D1_QUANT,_aTotal[003])) + '</PrcNetoItem>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <DescuentoMonto>' + Alltrim(TRANSFORM(SD1->D1_VALDESC/SD1->D1_QUANT,_aTotal[003])) + '</DescuentoMonto>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += IIf(Alltrim(SF1->F1_ESPECIE) == "NF", _aTotal[010][1], ""),.T.)
(PREREG) (_aTotal[001] += '    <MontoNetoItem>' + Alltrim(TRANSFORM(SD1->D1_TOTAL,_aTotal[003])) + '</MontoNetoItem>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '</Detalle>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

[XXX INVOICE_FIN]
(PREREG) (_aTotal[001] := '<Referencia>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <NroLinRef>1</NroLinRef>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <TpoDocRef>' + _aTotal[012][1] + '</TpoDocRef>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <NumeroRef>' + AllTrim(_aTotal[012][2]) + "-" + AllTrim(_aTotal[012][3]) + "-" + AllTrim(_aTotal[012][4]) + '</NumeroRef>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <FechaRef>' + AllTrim(_aTotal[012][5]) + '</FechaRef>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <RazonRef>' + AllTrim(SF1->F1_MOTIVO) + '</RazonRef>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <MontosRef>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <Tipo>04</Tipo>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <Porcentaje>' + AllTrim(_aTotal[012][7]) + '</Porcentaje>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '        <Monto>' + AllTrim(_aTotal[012][8]) + '</Monto>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    </MontosRef>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '</Referencia>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '<CAE>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <Tipo>String</Tipo>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <NumeroInicial>' + Alltrim(SF1->F1_DOC) + '</NumeroInicial>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <NumeroFinal>' + Alltrim(SF1->F1_DOC) + '</NumeroFinal>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <NroResolucion>' + Alltrim(SF1->F1_DOC) + '</NroResolucion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '    <FechaResolucion>' + Substr(_aTotal[011],1,10) + '</FechaResolucion>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '</CAE>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '<TimeStamp>' + _aTotal[011] + '</TimeStamp>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '</Documento>' + _aTotal[002],.T.)
(PREREG) (_aTotal[001] += '</DTE>',.T.)
(PREREG) ENCODEUTF8(_aTotal[001])

(POS) FsQuery(_aTotal[004],2)

[XXX FACTURA]
(PRE) _aTotal[094] := _aTotal[006] + ".XML"

(ARQ) _aTotal[094]




